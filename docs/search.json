[
  {
    "objectID": "OSAP_TRCA_Stream_Habitat.html",
    "href": "OSAP_TRCA_Stream_Habitat.html",
    "title": "TRCA-OSAP Stream Habitat Analysis",
    "section": "",
    "text": "IntroductionMethodsRaw with Model Predictions DataResults - Model SummariesResults - Spatial FiguresResults - Temporal FiguresResults - Temporal TablesResults - Habitat - Biota RelationshipsSite Specific EvaluationsResults and Conclusions\n\n\n\nBackground\nThe ability of streams and rivers to support a healthy and diverse biota depends on the availability of suitable habitat. This includes channel structure (e.g., cover, substrate) and channel processes (e.g., hydrology and sediment transport). Understanding these habitat components of a river system is crucial as it influences habitat availability, water quality, and overall ecosystem health. In the context of Ontario Stream Assessment Protocol (OSAP) and the Toronto and Region Conservation Authority (TRCA), in-stream habitat monitoring can provide valuable insights into the health of aquatic ecosystems, particularly for fish and benthic invertebrates, which are often sensitive to changes in their physical environment. By examining the relationships between habitat conditions and biological responses, we can better understand the impacts of natural and anthropogenic disturbances on aquatic ecosystems to guide land-use planning and restoration efforts.\n\n\nProject Overview\nThis study aims to understanding the in-stream habitat data collected through TRCA’s long-term monitoring programs. It includes compilation and summarization of the data, as well as exploring spatial and temporal patterns. The results will allow TRCA and OSAP to assess the variability in habitat across the region and how they relate to fish and benthic invertebrate communities to better inform monitoring and management decisions.\n\n\nTRCA Monitoring Locations\n\n\n\n\n\n\n\n\n\nData and modelsR Code\n\n\nHabitat and fish community data were downloaded from the Flowing Waters Information System (FWIS) Channel Structure Summary table. Watershed outlines were downloaded from TRCA open data portal. Supplemental data was joined from V3 of the Ontario Aquatic Ecosystem Classification (AEC). The Upstream catchment stress index was used to generate 3 Stress Classes corresponding to low (20-80), medium (80-140), and high (140-200) anthropogenic impacts. The Upstream Catchment Area (UCA) was used to generate 3 UCA Classes corresponding to small (0-20), intermediate (20-80), and large (&gt;80) stream sizes.\nGeneralized Linear Mixed Effects Models (GLMMs; using the GLMMtmb R package) were used to describe spatial and temporal patterns in in-stream habitat endpoints over time. Distributional families were selected to match the distributions and data generating processes that underlie the endpoints, for example substrate sizes tend to vary on a log-normal distribution, whereas percentages and cover endpoints generally follow a beta distribution.\nSome endpoints contained multiple categorical values within continuously measured values (i.e., sand, silt, clay categories for fines within the Substrate Sizes endpoints). These values were all replaced by 0’s and modeled with the zero-inflation portion of the model. See the R Code for full list of data transformations. Endpoints with more than 75% of observations at 0 tended to have worse preliminary model fits and were excluded from the final analysis.\nEach endpoint was modeled with the following formula: \\[\nEndpoint = ln(Reach Slope+1) + Year_n*UCA*Stress + (Year_n|SiteCode) + (1|Year_n)\n\\]\nwhere \\(Reach Slope\\) is the percent slope of the reach from the AEC; \\(UCA\\), and \\(Stress\\) are fixed effect factor terms; \\(Year_n\\) represent temporal slopes and the \\((Year_n|SiteCode)\\) is a nested random-effects term which fits a temporal slope to each monitoring location nested within a UCA class, and Stress Class factor. The \\(Year_n*UCA*Stress\\) term is fit as three-way interaction terms fitting temporal slopes to the two factor variables together and individually. The \\((1|Year_n)\\) term fits a random intercept to each monitoring year. This allows for global effects that can influence all sites in a particular year such as a potential crew bias or severe weather event.\nSome endpoints are also fit with a zero-inflation model (probability of a zero: \\(E_0\\)). Zero-inflation was a simplified model without the three-way interaction \\(Year_n*UCA*Stress\\) term:\n\\[\nE_0 = ln(Reach Slope+1) + Year_n + UCA + Stress + (Year_n|SiteCode) + (1|Year_n)\n\\]\nThe following table summarizes the distributional family used for each endpoint.\n\n\n\n\n\n\n  \n    \n      \n      Distribution\n    \n  \n  \n    \n      Cover\n    \n    Wood Cover - Unembedded\nbeta\n    Wood Cover - Total\nbeta\n    Round Rock Cover - Unembedded\nbeta\n    Round Rock Cover - Total\nbeta\n    Flat Rock Cover - Unembedded\nbeta\n    Flat Rock Cover - Total\nbeta\n    \n      Percent\n    \n    Filamentous Algae Percent\nbeta\n    Non-Filamentous Algae Percent\nbeta\n    Moss Percent\nbeta\n    \n      Indices\n    \n    Sediment Sorting Index\ngamma\n    Bank Stability - Mean\nbeta\n    Habitat Homogeneity\nbeta\n    \n      Substrate Sizes\n    \n    D50\nlognormal\n    D85\nlognormal\n    D50Max\nlognormal\n    \n      Morphology\n    \n    Width - Mean\nlognormal\n    Depth - Mean\nlognormal\n    Width:Depth Ratio\ngamma\n    Usable Area\ngamma\n  \n  \n\n\n\n\nAfter an initial round of model fitting, models with convergence errors were subject to an outlier removal method. 10,000 simulated residuals were generated from the fitted models, and observed residuals were compared to simulated residuals using the DHARMa R package. Observed residuals that were outside the 2.5th and 97.5th percentiles of simulated residuals were considered outliers. These values were removed from the model training data, and models were refit to the reduced dataset. Outlier values were excluded from model fitting, but included in final evaluations.\n\n\nThis section contains all the R code to reproduce the current results and analysis.\n\n0 FWIS Source1 Source2 Download Data3 Format Raw Data4 Fit Models and Format Results5 Generate Figures6 Biological Correlations\n\n\n\nif( !require( \"httr\" ) ) {\n  install.packages( \"httr\" )\n}\nlibrary( httr )\nif( !require( \"jsonlite\" ) ) {\n  install.packages( \"jsonlite\" )\n}\nlibrary( jsonlite )\nif( !require( \"base64enc\" ) ) {\n  install.packages( \"base64enc\" )\n}\nlibrary( base64enc )\n\n# widePost.r -- a collection of functions that enable access to WIDE server data using R\n#\n# Usage: source( \"widePost.r\" )  ...from R console/script, with current directory set to folder with widePost.r\n#\n# to enable some debugging, such as the HTTP request/response headers and JSON request, enter the following:\n#  options( verbose = 1 )\n# to disable subsequent debugging, use:\n#  options( verbose = 0 )\n\n.WIDE &lt;- new.env()\n.WIDE$clientVersionDate &lt;- \"2016-06-27-1400\"\n.WIDE$clientVersion &lt;- c( \"1\", \"0\" )\n# list of servers that the user has logged in to...\n.WIDE$connectedServers &lt;- list()\n\n# wideLogin -- connect to a WIDE data API server\n#  serverURL: the URL of the server data API script\n#  username/password: login credentials\n# returns false in the event of an error, or a serverHandle (integer &gt; 0) value to be passed to subsequent widePost functions\n\nwideLogin&lt;-function( serverURL, username, password )\n{\n  # application.php requires parameters \"Username\", \"Password\" and \"cls_logon_submit\" as follows...\n  postBody&lt;-list( Username = username, Password = password, cls_logon_submit = 1 )\n  loginResponse &lt;- httr::POST( serverURL, body = postBody, encode = \"form\" )\n  loginContent &lt;- content( loginResponse, \"text\" )\n  \n  # error handling\n  if( !jsonlite::validate( loginContent ) ) {\n    # php syntax errors do not get encoded as JSON, so check for beginning and ending curly braces...\n    if( ( substr( loginContent, 1, 1 ) != \"{\" ) &&\n        ( substr( loginContent, nchar( loginContent ), nchar( loginContent ) ) != \"}\" ) ) {\n      print( paste( \" php syntax error: \", loginContent ) )\n    } else {\n      print( paste( \" invalid JSON: \", loginContent ) )\n    }\n    return( FALSE )\n  }\n  \n  jsonData &lt;- fromJSON( loginContent )\n  \n  if( \"error\" %in% names( jsonData ) ) {\n    print( jsonData )\n    return( FALSE )\n  }\n  \n  # successful login\n  print( jsonData$status )\n  \n  # check for version differences\n  if( .WIDE$clientVersion[ 1 ] == jsonData$version[ 1 ] ) {\n    if( .WIDE$clientVersion[ 2 ] == jsonData$version[ 2 ] ) {\n      print( paste( \"(0) WIDE interface ready - client/server version\", paste( .WIDE$clientVersion, collapse = \".\" ),\n                    \" (\", .WIDE$clientVersionDate, \")\" ) )\n      versionStatus &lt;- 0\n    } else if( .WIDE$clientVersion[ 2 ] &gt; jsonData$version[ 2 ] ) {\n      versionStatus &lt;- 1\n      print( paste0( \"(1) WIDE interface ready - server version \", jsonData$version[ 1 ], \".\", jsonData$version[ 2 ],\n                     \" (\", jsonData$versionDate, \"), client: \", paste( .WIDE$clientVersion, collapse = \".\" ), \" (\",\n                     .WIDE$clientVersionDate, \")\" ) )\n    } else {\n      versionStatus &lt;- -1\n      cat( paste0( \"(-1) WIDE interface ready - server version \", jsonData$version[ 1 ], \".\", jsonData$version[ 2 ],\n                   \" (\", jsonData$versionDate, \"), client: \", paste( .WIDE$clientVersion, collapse = \".\" ), \" (\",\n                   .WIDE$clientVersionDate, \")\\nPlease consider downloading a new client\\n\" ) )\n    }\n  } else if( .WIDE$clientVersion[ 1 ] &gt; jsonData$version[ 1 ] ) {\n    versionStatus &lt;- 1\n    print( paste0( \"(1) WIDE interface ready - server version \", jsonData$version[ 1 ], \".\", jsonData$version[ 2 ],\n                   \" (\", jsonData$versionDate, \"), client: \", paste( .WIDE$clientVersion, collapse = \".\" ), \" (\", .WIDE$clientVersionDate, \")\" ) )\n  } else {\n    versionStatus &lt;- -1\n    print( paste0( \"(-1) FATAL ERROR: client is out of date - server version \", jsonData$version[ 1 ], \".\", jsonData$version[ 2 ],\n                   \" (\", jsonData$versionDate, \"), client: \", paste( .WIDE$clientVersion, collapse = \".\" ), \" (\", .WIDE$clientVersionDate,\n                   \")\\nPlease consider downloading a new client\\n\" ) )\n  }\n  \n  # create and store server handle to be returned to the user\n  if( versionStatus == -1 ) {\n    return( -1 )\n  }\n  .WIDE$connectedServers &lt;- append( .WIDE$connectedServers, serverURL )\n  return( length( .WIDE$connectedServers ) )\n}\n\n# wideDataSelect -- retrieve one or more records from a database table\n#  e.g.,\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\"))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),orderBy=list(\"StreamName\"))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),orderBy=list(\"StreamName ASC\"))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),orderBy=list(\"StreamName DESC\"))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),orderBy=list('\"1\" DESC'))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),orderBy=list('1 DESC'))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),orderBy=list(1))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),list(StreamName=c(\"like\",\"%Black%\")))\n#   wideDataSelect(serverHandle,\"lkpStreamCode\",list(\"StreamName\",\"StreamCode\"),list(StreamName=c(\"like\",\"%Black%\"),StreamCode=c(\"like\",\"bl%\")),list(1),\"OR\")\n# returns a data.frame if successful; otherwise, returns NULL\n\nwideDataSelect&lt;-function( serverHandle, table, colsSelected, where = NULL, orderBy = NULL, logical = \"AND\", geoConstraint = 0 )\n{\n  if( getOption( \"wideFunCall\", 0 ) ) {\n    print( call( \"wideDataSelect\", serverHandle = serverHandle, table = table, colsSelected = colsSelected,\n                 where = where, orderBy = orderBy, logical = logical, geoConstraint = geoConstraint ) )\n  }\n  if( ( serverHandle &lt; 1 ) || ( serverHandle &gt; length( .WIDE$connectedServers ) ) ) {\n    stop( paste0( \"Invalid server handle, must be one of: [\", seq_len( length( .WIDE$connectedServers ) ), \"]\" ) )\n  }\n  \n  # Note that the \"xxx=\" prefix in each \"element\" of the jsonPost list must be specified (i.e., it can't be left out\n  #  of the jsonPost list() below)...\n  # e.g., jsonPost&lt;-list(table=\"lkpStreamCode\",action=\"select\",colsSelected=list(\"StreamName\"))\n  jsonPost&lt;-list( table = table, action = \"select\", colsSelected = colsSelected, colsWhere = where, orderbyCols = orderBy, logical = logical, geoConstraint = geoConstraint )\n  \n  if( getOption( \"verbose\" ) ) {\n    print( jsonPost )\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[serverHandle]], body = jsonPost, encode = \"json\", verbose() )\n  } else {\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[serverHandle]], body = jsonPost, encode = \"json\" )\n  }\n  # for some circumstances (e.g., application development, testing, etc.) it may be useful to save the basic postResponse content\n  #  to a file...\n  # write( paste( \"Content of postResponse \", content( postResponse, \"text\" ) ), \"c:/temp/routput.txt\" )\n  \n  postContent&lt;-content( postResponse, \"text\" )\n  \n  if( !jsonlite::validate( postContent ) ) {\n    if( ( substr( postContent, 1, 1 ) != \"{\" ) &&\n        ( substr( postContent, nchar( postContent ), nchar( postContent ) ) != \"}\" ) ) {\n      print( paste( \" php syntax error: \", postContent ) )\n    } else {\n      print( paste( \" invalid json: \", postContent ) )\n    }\n    return( NULL )\n  }\n  \n  jsonData &lt;- fromJSON( postContent )\n  \n  if( \"error\" %in% names( jsonData ) ) {\n    print( jsonData )\n    return( NULL )\n  }\n  \n  # find all of the binary columns which must be decoded\n  binaryCols &lt;- Filter( function( colName ) { jsonData[[ 1, colName ]] == 1 }, names( jsonData ) )\n  \n  # removing a row from a dataframe with one column ends up converting that data frame into a vector;\n  # to prevent this from happening, use drop=FALSE\n  jsonData &lt;- jsonData[ -1, , drop = FALSE ]\n  \n  # if the data frame isn't empty after removing the row, renumber all of the rows\n  if( nrow( jsonData ) ) {\n    row.names( jsonData ) &lt;- 1:nrow( jsonData )\n  }\n  \n  # if there are any binary columns to decode, do that now... (base64decode cannot NA, so those must be explicitly\n  #  returned back as NA)\n  # NA_character_ is returned because that is the type of NA value used in the shinyapp DataTable\n  if( length( binaryCols ) ) {\n    jsonData[[ binaryCols ]] &lt;- sapply( jsonData[[ binaryCols ]], function( i ) {\n      if( is.na( i ) ) {\n        return( NA_character_ )\n      }\n      # for some reason, without the paste (... collapse), the as.character(...) ends up as type list\n      #  in the final jsonData dataframe\n      return( paste0( \"0x\", as.character( base64decode( i ) ), collapse = \"\" ) )\n    } )\n  }\n  \n  return( jsonData )\n}\n\n# wideDataSpatialConstraint -- define a geospatial constraint for subsequent queries with\n#   spatial constraints enabled\n#  e.g.,\n\n# return TRUE if successful; otherwise, return FALSE\nwideDataSpatialConstraint &lt;- function( serverHandle, table = NULL, column = NULL, where = NULL, comparisonResult = NULL, logical=\"AND\") {\n  \n  if( getOption( \"wideFunCall\", 0 ) ) {\n    print( call( \"wideDataSpatialConstraint\", serverHandle = serverHandle, table = table, column = column, where = where,\n                 comparisonResult = comparisonResult, logical = logical ) )\n  }\n  if( ( serverHandle &lt; 1 ) || ( serverHandle &gt; length( .WIDE$connectedServers ) ) ) {\n    stop( paste0( \"Invalid server handle, must be one of: \", seq_len( length( .WIDE$connectedServers ) ) ) )\n  }\n  \n  jsonPost&lt;-list( table = table, action = \"geospatialConstraint\", column = column, colsWhere = where,\n                  comparisonResult = comparisonResult, logical = logical )\n  \n  if( getOption( \"verbose\" ) ) {\n    print( jsonPost )\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[serverHandle]], body = jsonPost, encode = \"json\", verbose() )\n  } else {\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[serverHandle]], body = jsonPost, encode = \"json\" )\n  }\n  \n  postContent&lt;-content( postResponse, \"text\" )\n  \n  if( !jsonlite::validate( postContent ) ) {\n    if( ( substr( postContent, 1, 1 ) != \"{\" ) &&\n        ( substr( postContent, nchar( postContent ), nchar( postContent ) ) != \"}\" ) ) {\n      print( paste( \" php syntax error: \", postContent ) )\n    } else {\n      print( paste( \" invalid json: \", postContent ) )\n    }\n    return( FALSE )\n  }\n  \n  jsonData &lt;- fromJSON( postContent )\n  print( jsonData )\n  \n  if( \"error\" %in% names( jsonData ) ) {\n    return( FALSE )\n  }\n  return( TRUE )\n}\n\n# wideDataUpdate -- update one or more records of a database table\n#  e.g.,\n# wideDataUpdate(serverHandle = 1L, table = \"lkpStreamCode\", cols = list(StreamName = \"Teststream1\"), where =list(StreamCode = c(\"=\", \"teststr\")))\n# return TRUE if successful; otherwise, return FALSE\n\nwideDataUpdate&lt;-function( serverHandle, table, cols, where, logical = \"AND\" )\n{\n  if( getOption( \"wideFunCall\", 0 ) ) {\n    print( call( \"wideDataUpdate\", serverHandle = serverHandle, table = table, cols = cols, where = where, logical = logical ) )\n  }\n  if( ( serverHandle &lt; 1 ) || ( serverHandle &gt; length( .WIDE$connectedServers ) ) ) {\n    stop( paste0( \"Invalid server handle, must be one of: \", seq_len( length( .WIDE$connectedServers ) ) ) )\n  }\n  \n  # Note that the \"xxx=\" prefix in each \"element\" of the jsonPost list must be specified (i.e., it can't be left out of the jsonPost list() below)...\n  jsonPost&lt;-list( table = table, action = \"update\", cols = cols, colsWhere = where, logical = logical )\n  \n  if( getOption( \"verbose\" ) ) {\n    print( jsonPost )\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[serverHandle]], body = jsonPost, encode = \"json\", verbose() )\n  } else {\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[serverHandle]], body = jsonPost, encode = \"json\" )\n  }\n  \n  postContent&lt;-content( postResponse, \"text\" )\n  \n  if( !jsonlite::validate( postContent ) ) {\n    if( ( substr( postContent, 1, 1 ) != \"{\" ) &&\n        ( substr( postContent, nchar( postContent ), nchar( postContent ) ) != \"}\" ) ) {\n      print( paste( \" php syntax error: \", postContent ) )\n    } else {\n      print( paste( \" invalid json: \", postContent ) )\n    }\n    return( FALSE )\n  }\n  \n  jsonData &lt;- fromJSON( postContent )\n  print( jsonData )\n  \n  if( \"error\" %in% names( jsonData ) ) {\n    return( FALSE )\n  }\n  \n  return( TRUE )\n}\n\n# return TRUE if successful; otherwise, return FALSE\n\nwideDataInsert&lt;-function( serverHandle, table, cols )\n{\n  if( getOption( \"wideFunCall\", 0 ) ) {\n    print( call( \"wideDataInsert\", serverHandle = serverHandle, table = table, cols = cols ) )\n  }\n  if( ( serverHandle &lt; 1 ) || ( serverHandle &gt; length( .WIDE$connectedServers ) ) ) {\n    stop( paste0( \"Invalid server handle, must be one of: \", seq_len( length( .WIDE$connectedServers ) ) ) )\n  }\n  \n  jsonPost&lt;-list( table = table, action = \"insert\", cols = cols )\n  \n  if( getOption( \"verbose\" ) ) {\n    print( jsonPost )\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[ serverHandle ]], body = jsonPost, encode = \"json\", verbose() )\n  } else {\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[ serverHandle ]], body = jsonPost, encode = \"json\" )\n  }\n  \n  postContent&lt;-content( postResponse, \"text\" )\n  \n  if( !jsonlite::validate( postContent ) ) {\n    if( ( substr( postContent, 1, 1 ) != \"{\" ) &&\n        ( substr( postContent, nchar( postContent ), nchar( postContent ) ) != \"}\" ) ) {\n      print( paste( \" php syntax error: \", postContent ) )\n    } else {\n      print( paste( \" invalid JSON: \", postContent ) )\n    }\n    return( FALSE )\n  }\n  \n  jsonData &lt;- fromJSON( postContent )\n  print( jsonData )\n  \n  if( \"error\" %in% names( jsonData ) ) {\n    return( FALSE )\n  }\n  return( TRUE )\n}\n\n# return TRUE if successful; otherwise, return FALSE\n\nwideDataDelete&lt;-function( serverHandle, table, where, logical = \"AND\" )\n{\n  if( getOption( \"wideFunCall\", 0 ) ) {\n    print( call( \"wideDataDelete\", serverHandle = serverHandle, table = table, where = where, logical = logical ) )\n  }\n  if( ( serverHandle &lt; 1 ) || ( serverHandle &gt; length( .WIDE$connectedServers ) ) ) {\n    stop( paste0( \"Invalid server handle, must be one of: \", seq_len( length( .WIDE$connectedServers ) ) ) )\n  }\n  \n  jsonPost&lt;-list( table = table, action = \"delete\", colsWhere = where, logical = logical )\n  \n  if( getOption( \"verbose\" ) ) {\n    print( jsonPost )\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[ serverHandle ]], body = jsonPost, encode = \"json\", verbose() )\n  } else {\n    postResponse&lt;-httr::POST( .WIDE$connectedServers[[ serverHandle ]], body = jsonPost, encode = \"json\" )\n  }\n  \n  postContent&lt;-content( postResponse, \"text\" )\n  if( !jsonlite::validate( postContent ) ) {\n    if( ( substr( postContent, 1, 1 ) != \"{\" ) &&\n        ( substr( postContent, nchar( postContent ), nchar( postContent ) ) != \"}\" ) ) {\n      print( paste( \" php syntax error: \", postContent ) )\n    } else {\n      print( paste( \" invalid JSON: \", postContent ) )\n    }\n    return( FALSE )\n  }\n  \n  jsonData &lt;- fromJSON( postContent )\n  print( jsonData )\n  \n  if( \"error\" %in% names( jsonData ) ) {\n    return( FALSE )\n  }\n  return( TRUE )\n}\n\n# example:\n#   data &lt;- wideDataSelect(\"lkpStreamCode\", list(\"*\"), orderBy=list(\"StreamCode DESC\"))\n#   exportCSV(data, \"c:/temp/output.csv\")\n\nexportCSV&lt;-function( data, filepath )\n{\n  if( getOption( \"wideFunCall\", 0 ) ) {\n    print( call( \"exportCSV\", data = data, filepath = filepath ) )\n  }\n  \n  # PARAMETERS (row.names, na)\n  # - do not include row numbers\n  # - save null values as conventional nulls instead of empty strings (i.e., \"column1\",\"column2\",,\"column4\" instead of \"column1\",\"column2\",\"\",\"column4\")\n  write.csv( data, filepath, row.names = FALSE, na = \"\" )\n}\n\n# to read a csv, see read.csv(...)\n\n\n\n\nlibrary(tidyverse)\nlibrary(sf)\n\n# Columns that uniquely identify observations\nID_cols &lt;- c(\n  \"ID\",\n  \"StreamName\",\n  \"StreamCode\",\n  \"SiteCode\",\n  \"Latitude\",\n  \"Longitude\",\n  \"SampleDate\",\n  \"Sample\",\n  'OrgNameList'\n)\n\n# Endpoint names and groups\nmet_cols &lt;- list(\n  `Morphology` = list(\n    `Width - Mean` = \"AvgWettedWidth\",\n    `Depth - Mean` = \"meanDepth\",\n    `Width:Depth Ratio` = \"widthDepthRatio\",\n    `Usable Area` = \"UsableArea\"\n  ),\n  `Substrate Sizes` = list(\n    `D15` = \"Substd15\",\n    `D50` = \"Substd50\",\n    `D85` = \"Substd85\",\n    `D50Max` = \"substPartMaxd50\"\n  ),\n  `Indices` = list(\n    #`Substrate Quality Rating` = \"Substrate Quality Rating\",\n    `Sediment Sorting Index` = \"sedimentSortingIndex\",\n    `Sediment Transport Potential` = \"sedimentTransportPotential\",\n    `Bank Stability - Mean` = \"bankStabilityAVG\",\n    `Habitat Homogeneity` = \"scoreHomogeneity\",\n    `Habitat Stability Score` = \"HabitatStabilityScore\"\n  ),\n  `Percent` = list(\n    `Filamentous Algae Percent` = \"TotalVegTypePCFL\",\n    `Non-Filamentous Algae Percent` = \"TotalVegTypePCAL\",\n    `Moss Percent` = \"TotalVegTypePCSS\",\n    `Macrophytes Percent` = \"TotalVegTypePCMC\"\n  ),\n  `Cover` = list(\n    `Wood Cover - Unembedded` = \"UnembCoverTypePCWood\",\n    `Wood Cover - Total` = \"TotalCoverTypePCWood\",\n    `Round Rock Cover - Unembedded` = \"UnembCoverTypePCRndRock\",\n    `Round Rock Cover - Total` = \"TotalCoverTypePCRndRock\",\n    `Flat Rock Cover - Unembedded` = \"UnembCoverTypePCFltRock\",\n    `Flat Rock Cover - Total` = \"TotalCoverTypePCFltRock\",\n    `Macrophyte Cover - Unembedded` = \"UnembCoverTypePCMacrophyte\",\n    `Macrophyte Cover - Total` = \"TotalCoverTypePCMacrophyte\",\n    `Bank Cover - Unembedded` = \"UnembCoverTypePCBank\",\n    `Bank Cover - Total` = \"TotalCoverTypePCBank\"\n  )\n)\n\n# Selected Fish Endpoints\nsel_fish_ep&lt;-c(\n  `Community Total Biomass`=\"Comm_Biomass\",\n  `Community Total Density`=\"Comm_Abundance\",\n  `Community Total Richness`=\"Comm_Richness\",\n  `SATI Biomass`=\"Therm_SATI_Bioperc\",\n  `Cold Water Stenotherm Biomass`=\"Therm_cold_Bio\",\n  `% Cold Water Stenotherm Biomass`=\"Therm_cold_Bioperc\",\n  `Tolerant Taxa Biomass`=\"Tol_tol_Bio\",\n  `% Tolerant Taxa Biomass`=\"Tol_tol_Bioperc\",\n  `Intolerant Taxa Biomass`=\"Tol_intol_Bio\",\n  `% Intolerant Taxa Biomass`=\"Tol_intol_Bioperc\",\n  \n  `Tolerant Taxa Richness`=\"Tol_tol_Rich\",\n  `Intolerant Taxa Richness`=\"Tol_intol_Rich\",\n  \n  `Sensitive Darters Biomass`=\"Spec_DRT_Bio\",\n  `% Sensitive Darters Biomass`=\"Spec_DRT_Bioperc\",\n  `Brook Trout Biomass`=\"Spec_BKT_Bio\",\n  `% Brook Trout Biomass`=\"Spec_BKT_Bioperc\",\n  `Creek Chub Biomass`=\"Spec_CKC_Bio\",\n  `% Creek Chub Biomass`=\"Spec_CKC_Bioperc\",\n  `Open Substratum/Substratum Choosers Biomass`=\"Rep_OSS_Bio\",\n  `% Open Substratum/Substratum Choosers Biomass`=\"Rep_OSS_Bioperc\",\n  `Lithophilic Spawners Biomass`=\"Rep_Lith_Bio\",\n  `% Lithophilic Spawners Biomass`=\"Rep_Lith_Bioperc\"\n  \n)\n\n# function to reformat model terms\n\nget_terms &lt;- function(mod,add_fixed_var=T){\n  fe_tbl &lt;- as.data.frame(glmmTMB::fixef(mod)$cond)\n  colnames(fe_tbl)&lt;-\"coef\"\n  fe_tbl$se &lt;- diag(glmmTMB::sandwich(mod))\n  \n  add_var &lt;- fe_tbl[\"(Intercept)\",\"se\"]\n  if (!add_fixed_var) add_var &lt;- 0\n  \n  re_tbl &lt;- as.data.frame(glmmTMB::ranef(mod, condVar = T)) %&gt;% \n    filter(component == \"cond\") %&gt;% \n    mutate(val=condval,\n           sd=condsd)\n  \n  comp_sel &lt;- unique(re_tbl$grpvar)\n  u_comp_sel &lt;- str_split(comp_sel,\"\\\\:\")\n  u_comp_sel &lt;- unique(unlist(u_comp_sel))\n  u_comp_sel &lt;- unique(gsub(\"`\",\"\",u_comp_sel))\n  \n  for (i in u_comp_sel) {\n    comp_sel_sub &lt;- comp_sel[sapply(comp_sel,function(x) any(grepl(i,x)))]\n    re_tbl[[i]]&lt;-NA_character_\n    \n    for (ii in comp_sel_sub) {\n      pos &lt;- str_split(ii,\"\\\\:\",simplify = T)\n      pos &lt;- gsub(\"`\",\"\",pos)\n      pos &lt;- which(pos==i)\n      \n      re_tbl[re_tbl$grpvar==ii,i] &lt;- str_split(re_tbl[re_tbl$grpvar==ii,\"grp\"],\"\\\\:\",simplify= T)[,pos]\n    }\n  }\n  \n  for (i in unique(re_tbl$SiteCode[!is.na(re_tbl$SiteCode)])){\n    \n    for (ii in unique(re_tbl$term)){\n      val_sum &lt;- re_tbl$val[re_tbl$SiteCode %in% i & re_tbl$term %in% ii]\n      sd_sum &lt;- re_tbl$sd[re_tbl$SiteCode %in% i & re_tbl$term %in% ii]\n      \n      for (iii in unique(re_tbl$grpvar)[!grepl(\"SiteCode\",unique(re_tbl$grpvar))]){\n        val_sum &lt;- c(val_sum, re_tbl$condval[re_tbl$grpvar %in% iii &\n                                               re_tbl$grp %in% gsub(paste0(\":\",i),\"\",unique(re_tbl[[\"grp\"]][re_tbl$SiteCode %in% i])) &\n                                               re_tbl$term %in% ii\n        ]\n        )\n        sd_sum &lt;- c(sd_sum, re_tbl$condsd[re_tbl$grpvar %in% iii &\n                                            re_tbl$grp %in% gsub(paste0(\":\",i),\"\",unique(re_tbl[[\"grp\"]][re_tbl$SiteCode %in% i])) &\n                                            re_tbl$term %in% ii\n        ]\n        )\n      }\n      \n      re_tbl$val[re_tbl$SiteCode %in% i & re_tbl$term %in% ii] &lt;- sum(val_sum)\n      re_tbl$sd[re_tbl$SiteCode %in% i & re_tbl$term %in% ii] &lt;- sqrt(sum(sd_sum^2)+add_var^2)\n      \n    }\n  }\n  \n  comp_list &lt;- re_tbl %&gt;% \n    filter(!is.na(SiteCode))%&gt;% \n    mutate(group_var=\"SiteCode\") %&gt;% \n    select(group_var,group=SiteCode,component,term,val,sd,any_of(u_comp_sel)) %&gt;% \n    group_by(group_var,group,component,term) %&gt;% \n    summarise(\n      value = sum(val),\n      sd = sqrt(sum(sd^2)+add_var^2),\n      across(any_of(u_comp_sel),~unique(.x)),\n      .groups = \"drop\"\n    )\n  \n  comp_list &lt;- bind_rows(\n    comp_list,\n    re_tbl %&gt;% \n      filter(is.na(SiteCode)) %&gt;% \n      filter(!grpvar %in% unique(comp_list$group_var)) %&gt;% \n      select(group_var=grpvar,\n             group=grp,\n             component,\n             term,\n             val=condval,\n             sd=condsd,\n             any_of(u_comp_sel)) %&gt;% \n      group_by(across(c(any_of(u_comp_sel),group_var,group,component,term))) %&gt;% \n      summarise(\n        value = sum(val),\n        sd = sqrt(sum(sd^2)+add_var^2),\n        .groups = \"drop\"\n      )\n  )\n  \n  comp_list &lt;- comp_list %&gt;% \n    mutate(\n      pred_low = value - (qnorm(1 - 0.1 / 2) * sd),\n      pred_high = value + (qnorm(1 - 0.1 / 2) * sd),\n      pred_low_trend = value - (qnorm(1 - 0.5 / 2) * sd),\n      pred_high_trend = value + (qnorm(1 - 0.5 / 2) * sd),\n    ) \n  \n  return(comp_list)\n  \n}\n\nget_terms2 &lt;- function(mod,add_fixed_var=F,terms){\n\n  fixed_list &lt;- list(\n    #\"`UCA Class`:`Stress Class`:`Habitat Stability Class`\" = as.formula(~`UCA Class`*`Stress Class`*`Habitat Stability Class`),\n    #\"`UCA Class`:`Habitat Stability Class`\" = as.formula(~`UCA Class`*`Habitat Stability Class`),\n    \"`UCA Class`:`Stress Class`\" = as.formula(~`UCA Class`*`Stress Class`),\n    #\"`Habitat Stability Class`\" = as.formula(~`Habitat Stability Class`),\n    \"`Stress Class`\" = as.formula(~`Stress Class`),\n    \"`UCA Class`\" = as.formula(~`UCA Class`),\n    \"`1`\" = as.formula(~1)\n  )\n  \n  fixed_list &lt;- map(fixed_list,\n                    ~{\n                      emt95 &lt;- emmeans::emtrends(mod,.x,var=\"Year_n\",level=0.95) %&gt;% # consider: addl.vars = \"SiteCode\" ,component=\"response\"\n                        data.frame(check.names = F) %&gt;% \n                        mutate(level=0.95,term=\"Year_n\") %&gt;% \n                        rename(val=Year_n.trend)\n                      \n                      emt50 &lt;- emmeans::emtrends(mod,.x,var=\"Year_n\",level=0.5) %&gt;% \n                        data.frame(check.names = F) %&gt;% \n                        mutate(level=0.5,term=\"Year_n\") %&gt;% \n                        rename(val=Year_n.trend)\n                      \n                      emm95 &lt;- emmeans::emmeans(mod,.x,level=0.95, at = list(Year_n = max(mod$frame$Year_n)),type=\"response\") %&gt;% \n                        data.frame(check.names = F) %&gt;% \n                        mutate(level=0.95,term=\"(Intercept)\") %&gt;% \n                        rename(val=response)\n                      emm50 &lt;- emmeans::emmeans(mod,.x,level=0.50, at = list(Year_n = max(mod$frame$Year_n)),type=\"response\") %&gt;% \n                        data.frame(check.names = F) %&gt;% \n                        mutate(level=0.5,term=\"(Intercept)\") %&gt;% \n                        rename(val=response)\n                      \n                      bind_rows(emm95,emm50,emt95,emt50) %&gt;% \n                        rowwise() %&gt;% \n                        mutate(grp=paste0(c_across(any_of(c(\"UCA Class\",\"Stress Class\"))),collapse = \":\"))\n                    })\n  \n  fixed_list &lt;- bind_rows(fixed_list,.id=\"grpvar\") %&gt;% \n    mutate(component=\"fixed\") \n  \n  re_tbl &lt;- as.data.frame(glmmTMB::ranef(mod, condVar = T)) %&gt;% \n    filter(component == \"cond\") %&gt;% \n    filter(grpvar == \"`UCA Class`:`Stress Class`:SiteCode\") %&gt;% \n    mutate(SiteCode = str_split(grp,\":\",simplify = T)[,3]) %&gt;% \n    rename(val=condval,\n           SE=condsd)\n  \n  out_frame_raw &lt;- distinct(mod$frame[,sapply(mod$frame,class)==\"factor\"]) %&gt;% \n    mutate(val = NA_real_,\n           SE = NA_real_)\n  \n  out_frame &lt;- out_frame_raw\n  \n  for (i in unique(out_frame$SiteCode)) {\n    sub_frame1 &lt;- fixed_list %&gt;% \n      filter(term == \"Year_n\") %&gt;% \n      filter(level == 0.95) %&gt;% \n      filter(\n        `UCA Class` == out_frame[out_frame$SiteCode==i,\"UCA Class\"],\n        #`Habitat Stability Class` == out_frame[out_frame$SiteCode==i,\"Habitat Stability Class\"],\n        `Stress Class` == out_frame[out_frame$SiteCode==i,\"Stress Class\"]\n      )\n    \n    sub_frame2 &lt;- re_tbl %&gt;% \n      filter(SiteCode==i) %&gt;% \n      filter(term == \"Year_n\")\n    \n    out_frame$val[out_frame$SiteCode==i] &lt;- sum(sub_frame1$val,na.rm = T) + sum(sub_frame2$val,na.rm = T)\n    out_frame$SE[out_frame$SiteCode==i] &lt;- sqrt(sum(sub_frame1$SE^2,na.rm = T) + sum(sub_frame2$SE^2,na.rm = T))\n    \n  }\n  \n  out_frame &lt;- out_frame %&gt;% \n    mutate(\n      pred_low = val - (qnorm(1 - 0.1 / 2) * SE),\n      pred_high = val + (qnorm(1 - 0.1 / 2) * SE),\n      pred_low_trend = val - (qnorm(1 - 0.5 / 2) * SE),\n      pred_high_trend = val + (qnorm(1 - 0.5 / 2) * SE),\n    ) %&gt;% \n    mutate(\n      term = \"Year_n\",\n      component = \"cond\",\n      grpvar = \"`UCA Class`:`Stress Class`:SiteCode\",\n    )\n  \n  fixed_list_wide &lt;- fixed_list %&gt;% \n    pivot_wider(names_from = level, values_from = c(asymp.LCL,asymp.UCL)) %&gt;% \n    rename(\n      pred_low = asymp.LCL_0.95,\n      pred_low_trend = asymp.LCL_0.5,\n      pred_high = asymp.UCL_0.95,\n      pred_high_trend = asymp.UCL_0.5\n    )\n  \n  \n  \n  return(\n    bind_rows(out_frame,fixed_list_wide) %&gt;% \n      rename(value=val,\n             group = grp,\n             group_var = grpvar,\n             sd = SE)\n  )\n  \n}\n\nsummary_fun &lt;- function(x){\n  out &lt;- map(\n    c(\"Subshed\",\"WSHED\",\"UCA Class\",\"Stress Class\",\"UCA Class:Stress Class\",\"UCA Class:Stress Class\"),#,\"UCA Class:Habitat Stability Class\",\"UCA Class:Stress Class:Habitat Stability Class\"\n    ~{x %&gt;% \n        as_tibble() %&gt;% \n        mutate(`UCA Class:Stress Class` = paste(`UCA Class`,`Stress Class`,sep = \".\")) %&gt;% \n        #mutate(`UCA Class:Habitat Stability Class` = paste(`UCA Class`,`Habitat Stability Class`,sep = \".\")) %&gt;% \n        #mutate(`UCA Class:Stress Class:Habitat Stability Class` = paste(`UCA Class`,`Stress Class`,`Habitat Stability Class`,sep = \".\")) %&gt;% \n        mutate(group=.x) %&gt;% \n        rename_with(.cols=any_of(.x),~paste0(\"group_val\")) %&gt;% \n        mutate(group_val=as.character(group_val)) %&gt;% \n        group_by(group,group_val) %&gt;% \n        summarise(\n          across(c(\n            `Upstream Catchment Area`,\n          ),\n          ~mean(log10(.x),na.rm=T)^10\n          ),\n          across(c(\n            `Reach Slope`,\n          ),\n          ~expm1(mean(log1p(.x),na.rm=T))\n          ),\n          across(c(\n            `Baseflow Index`,\n            `Upstream catchment developed (%)`,\n            `Upstream catchment agricultural (%)`,\n            `Upstream catchment stress index`\n          ),\n          ~median(.x,na.rm=T)\n          ),\n          .groups=\"drop\"\n        )\n    }\n  )\n  \n  out &lt;- bind_rows(out)\n  return(out)\n}\n\n# Function to extract model optim\n\nglmmTMB_get_optimum &lt;- function(mod) {\n  # Fixed effects\n  starting_point &lt;- list(\n    beta = glmmTMB::fixef(mod)$cond,\n    betazi = glmmTMB::fixef(mod)$zi,\n    betadisp = glmmTMB::fixef(mod)$disp\n  )\n  #Random effects\n  ref &lt;- glmmTMB::ranef(mod)\n  if (length(ref$cond) &gt; 0) {\n    starting_point$theta = ref$cond\n  }\n  if (length(ref$zi) &gt; 0) {\n    starting_point$thetazi = ref$zi\n  }\n  if (length(ref$disp) &gt; 0) {\n    starting_point$thetadisp = ref$disp\n  }\n  return(starting_point)\n}\n\n# Function to generate heatmaps\nheatmap_fn&lt;-function(x_df,\n                     y_df=NULL,\n                     alpha=0.1,\n                     sig_est=0.6,\n                     method=\"spearman\",\n                     scale_grad=ggplot2::scale_fill_gradient2(\n                       low = scales::muted(rgb(red=0/255,green=102/255,blue=255/255)),\n                       mid = \"white\",\n                       high = scales::muted(rgb(red=0/255,green=176/255,blue=80/255)),\n                       limits=c(-1,1)\n                     ),\n                     ...){\n  \n  if (is.null(y_df)){\n    y_df&lt;-x_df\n  }\n  cor_list&lt;-lapply(x_df,function(x) lapply(y_df,function(y) broom::tidy(cor.test(x,y,method=method,...))))\n  \n  pcorr_out&lt;-purrr::map_dfr(cor_list,.id=\"x_var\",~purrr::map_dfr(.,dplyr::bind_rows,.id=\"y_var\"))\n  \n  pcorr_out &lt;- pcorr_out %&gt;%\n    mutate(p.value = case_when(\n      estimate &gt;= 1 - .Machine$double.eps ~ NA,\n      estimate &lt;= -1 + .Machine$double.eps~ NA,\n      T ~ p.value\n    )) %&gt;%\n    mutate(estimate = case_when(\n      estimate &gt;= 1 - .Machine$double.eps ~ NA,\n      estimate &lt;= -1 + .Machine$double.eps~ NA,\n      T ~ estimate\n    )) \n  \n  rho&lt;-pcorr_out %&gt;%\n    select(x_var,y_var,estimate) %&gt;%\n    spread(x_var,estimate) %&gt;%\n    data.frame(check.names = F) %&gt;%\n    tibble::column_to_rownames(\"y_var\") %&gt;%\n    textshape::cluster_matrix(method =\"ward.D2\")\n  \n  pv&lt;-pcorr_out %&gt;%\n    mutate(p.value=case_when(\n      is.na(p.value) ~ \"darkgray\",\n      p.value&gt;alpha ~ \"darkgray\",\n      p.value&lt;=alpha & abs(estimate)&gt;=sig_est ~ \"darkred\",\n      p.value&lt;=alpha ~ \"orange\",\n      T ~ \"darkgray\"\n    )) %&gt;%\n    select(x_var,y_var,p.value) %&gt;%\n    spread(x_var,p.value) %&gt;%\n    data.frame(check.names = F) %&gt;%\n    tibble::column_to_rownames(\"y_var\")\n  \n  pv&lt;-pv[rownames(rho),colnames(rho)]\n  \n  plot_out &lt;- pcorr_out %&gt;%\n    select(x_var,y_var,estimate) %&gt;% \n    spread(x_var,estimate) %&gt;%\n    data.frame(check.names = F) %&gt;%\n    tibble::column_to_rownames(\"y_var\") %&gt;%\n    heatmaply::ggheatmap(hclust_method =\"ward.D2\",\n                         seriate=\"GW\",\n                         margins =c(40,40,40,40),\n                         branches_lwd = 0.25,\n                         grid_gap=3,\n                         heatmap_layers=list(\n                           theme(\n                             axis.text.y = element_text(size = 8)   ,\n                             axis.text.x = element_text(\n                               size = 8,\n                               hjust = 1,\n                               vjust = 1,\n                               angle = 45\n                             ),\n                             legend.position = \"none\"),\n                           geom_tile(data=pv %&gt;%\n                                       rownames_to_column(\"Endpoint\") %&gt;%\n                                       gather(\"Parameter\",\"Value\",-Endpoint),\n                                     aes(x=Parameter,y=Endpoint),\n                                     #alpha=0,\n                                     colour=pv %&gt;%\n                                       rownames_to_column(\"Endpoint\") %&gt;%\n                                       gather(\"Parameter\",\"Value\",-Endpoint) %&gt;%\n                                       pull(Value),\n                                     width=0.975, height=0.975,\n                                     size=0.3,\n                                     fill=NA,\n                                     inherit.aes = F),\n                           guides(colour=\"none\")\n                         ),\n                         scale_fill_gradient_fun = scale_grad)\n  \n  cowplot::ggdraw(plot_out)\n  \n}\n\n# transformer for car::logit\nclogit &lt;- scales::new_transform(\n  name=\"clogit\",\n  transform = function(x) {\n    x[x&lt;0] &lt;- 0\n    x[x&gt;1] &lt;- 1\n    car::logit(x,T,0.025)\n  },\n  inverse = function(x) {\n    a &lt;- 0.025\n    a &lt;- (1-2*a)\n    a &lt;- (a*(1+exp(x))+(exp(x)-1))/(2*a*(1+exp(x)))\n    zapsmall(a)\n  },\n  domain = c(0, 1)\n)\n\n# Functions to plot axis on pseudo-log scales\nforce_all &lt;- function(...) list(...) # Helper function defined in scales\n\npseudo_log &lt;- function (val, sigma = 1, base = exp(1)) {\n  asinh(val/(2*sigma))/log(base)\n}\n\npseudo_log_breaks &lt;- function(n = 5, sigma = 1, base = 10) {\n  force_all(n, base)\n  n_default = n\n  \n  force_all &lt;- function(...) list(...) # Helper function defined in scales\n  \n  pseudo_log &lt;- function (val, sigma = 1, base = exp(1)) {\n    asinh(val/(2*sigma))/log(base)\n  }\n  \n  function(x, n = n_default) {\n    rng &lt;- pseudo_log(range(x, na.rm = TRUE), sigma = sigma, base = base)\n    min &lt;- floor(rng[1])\n    max &lt;- ceiling(rng[2])\n    \n    if (max == min) return(base^min)\n    \n    by &lt;- floor((max - min) / n) + 1\n    breaks &lt;- base^seq(min, max, by = by)\n    relevant_breaks &lt;- base^rng[1] &lt;= breaks & breaks &lt;= base^rng[2]\n    if (sum(relevant_breaks) &gt;= (n - 2)) return(breaks)\n    \n    # the easy solution to get more breaks is to decrease 'by'\n    while (by &gt; 1) {\n      by &lt;- by - 1\n      breaks &lt;- base^seq(min, max, by = by)\n      relevant_breaks &lt;- base^rng[1] &lt;= breaks & breaks &lt;= base^rng[2]\n      if (sum(relevant_breaks) &gt;= (n - 2)) return(breaks)\n    }\n    scales:::log_sub_breaks(rng, n = n, base = base)\n  }\n}\n\n# Helper function to extract a legend\nget_legend &lt;- function(p, position = NULL){\n  \n  if(.is_list(p)){\n    continue &lt;- TRUE\n    i &lt;- 1\n    while(i &lt;= length(p) & continue){\n      leg &lt;- .get_legend(p[[i]], position = position)\n      if(!is.null(leg)) continue &lt;- FALSE\n      i &lt;- i+1\n    }\n  }\n  else{\n    leg &lt;- .get_legend(p, position = position)\n  }\n  leg\n}\n\n.is_list &lt;- function(x){\n  inherits(x, \"list\")\n}\n\n\n# Return legend for one plot\n.get_legend &lt;- function(p, position = NULL){\n  \n  if(is.null(p)) return(NULL)\n  if(!is.null(position)){\n    p &lt;- p + theme(legend.position = position)\n  }\n  tmp &lt;- ggplot_gtable(ggplot_build(p))\n  leg &lt;- which(sapply(tmp$grobs, function(x) x$name) == \"guide-box\")\n  if(length(leg) &gt; 0) leg &lt;- tmp$grobs[[leg]]\n  else leg &lt;- NULL\n  leg\n}\n\ncol2hex &lt;- function(color, alpha = 1) {\n  \n  if (alpha &lt; 0 | alpha &gt; 1)\n    stop('alpha must be between 0 and 1.')\n  \n  if (missing(color))\n    stop('Need a color')\n  \n  if (!is.character(color))\n    stop(strwrap('Elements must be character string as a named R color or\n         hex (e.g. \"#ffffff\")'))\n  \n  if (!color %in% colors()) {\n    if (!nchar(color) == 7 | !grepl('^#', color))\n      stop(strwrap('color must be an R color, e.g. see colors(),\n                   or a hex of the form #ff5500'))\n  }\n  \n  rgb(t(col2rgb(color)/255), alpha = alpha)\n}\n\n# Calculate fish endpoints\ncalc_fish_ep&lt;-function(df) {\n  \n  ep_tbl&lt;-df %&gt;% \n    group_by(SampleEventID,SampleDate) %&gt;% \n    mutate(\n      # General Community\n      Comm_Biomass=sum(EstimatedBiomass,na.rm=T),\n      Comm_Abundance=sum(NumberOfFish,na.rm=T),\n      Comm_Biomass_SATI=sum(EstimatedBiomass[!is.na(OPT_TEMP)],na.rm=T),\n      Comm_Abundance_SATI=sum(NumberOfFish[!is.na(OPT_TEMP)],na.rm=T),\n      Comm_Richness=length(unique(SpeciesCode)),\n      EstimatedBiomass_perc=EstimatedBiomass/Comm_Biomass,\n      NumberOfFish_perc=NumberOfFish/Comm_Abundance,\n      EstimatedBiomass_perc_SATI=EstimatedBiomass/Comm_Biomass_SATI,\n      NumberOfFish_perc_SATI=NumberOfFish/Comm_Abundance_SATI,\n      SATI_EstimatedBiomass_perc=EstimatedBiomass_perc_SATI*OPT_TEMP,\n      SATI_NumberOfFish_perc=NumberOfFish_perc_SATI*OPT_TEMP,\n    ) %&gt;% \n    summarise(\n      # General Community\n      Comm_Biomass=head(Comm_Biomass,1),\n      Comm_Abundance=head(Comm_Abundance,1),\n      Comm_Richness=head(Comm_Richness,1),\n      # Thermal Regime \n      Therm_SATI_Bioperc=sum(SATI_EstimatedBiomass_perc,na.rm=T),\n      Therm_SATI_Abuperc=sum(SATI_NumberOfFish_perc,na.rm=T),\n      \n      Therm_cold_Bioperc=sum(EstimatedBiomass_perc[Thermal.Regime==\"coldwater\"],na.rm=T),\n      Therm_cool_Bioperc=sum(EstimatedBiomass_perc[Thermal.Regime==\"coolwater\"],na.rm=T),\n      Therm_coolcold_Bioperc=sum(EstimatedBiomass_perc[Thermal.Regime %in% c(\"coolwater\",\"coldwater\")],na.rm=T),\n      Therm_warm_Bioperc=sum(EstimatedBiomass_perc[Thermal.Regime %in% c(\"warmwater\")],na.rm=T),\n      Therm_cold_Abuperc=sum(NumberOfFish_perc[Thermal.Regime==\"coldwater\"],na.rm=T),\n      Therm_cool_Abuperc=sum(NumberOfFish_perc[Thermal.Regime==\"coolwater\"],na.rm=T),\n      Therm_coolcold_Abuperc=sum(NumberOfFish_perc[Thermal.Regime %in% c(\"coolwater\",\"coldwater\")],na.rm=T),\n      Therm_warm_Abuperc=sum(NumberOfFish_perc[Thermal.Regime %in% c(\"warmwater\")],na.rm=T),\n      Therm_cold_Bio=sum(EstimatedBiomass_perc[Thermal.Regime==\"coldwater\"],na.rm=T)*Comm_Biomass,\n      Therm_cool_Bio=sum(EstimatedBiomass_perc[Thermal.Regime==\"coolwater\"],na.rm=T)*Comm_Biomass,\n      Therm_coolcold_Bio=sum(EstimatedBiomass_perc[Thermal.Regime %in% c(\"coolwater\",\"coldwater\")],na.rm=T)*Comm_Biomass,\n      Therm_warm_Bio=sum(EstimatedBiomass_perc[Thermal.Regime %in% c(\"warmwater\")],na.rm=T)*Comm_Biomass,\n      Therm_cold_Abu=sum(NumberOfFish_perc[Thermal.Regime==\"coldwater\"],na.rm=T)*Comm_Abundance,\n      Therm_cool_Abu=sum(NumberOfFish_perc[Thermal.Regime==\"coolwater\"],na.rm=T)*Comm_Abundance,\n      Therm_coolcold_Abu=sum(NumberOfFish_perc[Thermal.Regime %in% c(\"coolwater\",\"coldwater\")],na.rm=T)*Comm_Abundance,\n      Therm_warm_Abu=sum(NumberOfFish_perc[Thermal.Regime %in% c(\"warmwater\")],na.rm=T)*Comm_Abundance,\n      Therm_warm_Rich=length(NumberOfFish_perc[Thermal.Regime %in% c(\"warmwater\")]),\n      Therm_cold_Rich=length(NumberOfFish_perc[Thermal.Regime %in% c(\"coldwater\")]),\n      Therm_cool_Rich=length(NumberOfFish_perc[Thermal.Regime %in% c(\"coolwater\")]),\n      Therm_coolcold_Rich=length(NumberOfFish_perc[Thermal.Regime %in% c(\"coolwater\",\"coldwater\")]),\n      # Trophic Guild \n      Troph_invert_Bioperc=sum(EstimatedBiomass_perc[grepl(\"invertivore\",Trophic.Class)],na.rm=T),\n      Troph_detrit_Bioperc=sum(EstimatedBiomass_perc[grepl(\"detritivore\",Trophic.Class)],na.rm=T),\n      Troph_carn_Bioperc=sum(EstimatedBiomass_perc[grepl(\"carnivore\",Trophic.Class)],na.rm=T),\n      Troph_herb_Bioperc=sum(EstimatedBiomass_perc[grepl(\"herbivore\",Trophic.Class)],na.rm=T),\n      Troph_plank_Bioperc=sum(EstimatedBiomass_perc[grepl(\"planktivore\",Trophic.Class)],na.rm=T),\n      Troph_invert_Bio=sum(EstimatedBiomass_perc[grepl(\"invertivore\",Trophic.Class)],na.rm=T)*Comm_Biomass,\n      Troph_detrit_Bio=sum(EstimatedBiomass_perc[grepl(\"detritivore\",Trophic.Class)],na.rm=T)*Comm_Biomass,\n      Troph_carn_Bio=sum(EstimatedBiomass_perc[grepl(\"carnivore\",Trophic.Class)],na.rm=T)*Comm_Biomass,\n      Troph_herb_Bio=sum(EstimatedBiomass_perc[grepl(\"herbivore\",Trophic.Class)],na.rm=T)*Comm_Biomass,\n      Troph_plank_Bio=sum(EstimatedBiomass_perc[grepl(\"planktivore\",Trophic.Class)],na.rm=T)*Comm_Biomass,\n      Troph_invert_Abuperc=sum(NumberOfFish_perc[grepl(\"invertivore\",Trophic.Class)],na.rm=T),\n      Troph_detrit_Abuperc=sum(NumberOfFish_perc[grepl(\"detritivore\",Trophic.Class)],na.rm=T),\n      Troph_carn_Abuperc=sum(NumberOfFish_perc[grepl(\"carnivore\",Trophic.Class)],na.rm=T),\n      Troph_herb_Abuperc=sum(NumberOfFish_perc[grepl(\"herbivore\",Trophic.Class)],na.rm=T),\n      Troph_plank_Abuperc=sum(NumberOfFish_perc[grepl(\"planktivore\",Trophic.Class)],na.rm=T),\n      Troph_invert_Abu=sum(NumberOfFish_perc[grepl(\"invertivore\",Trophic.Class)],na.rm=T)*Comm_Abundance,\n      Troph_detrit_Abu=sum(NumberOfFish_perc[grepl(\"detritivore\",Trophic.Class)],na.rm=T)*Comm_Abundance,\n      Troph_carn_Abu=sum(NumberOfFish_perc[grepl(\"carnivore\",Trophic.Class)],na.rm=T)*Comm_Abundance,\n      Troph_herb_Abu=sum(NumberOfFish_perc[grepl(\"herbivore\",Trophic.Class)],na.rm=T)*Comm_Abundance,\n      Troph_plank_Abu=sum(NumberOfFish_perc[grepl(\"planktivore\",Trophic.Class)],na.rm=T)*Comm_Abundance,\n      Troph_invert_Rich=length(NumberOfFish_perc[grepl(\"invertivore\",Trophic.Class)]),\n      Troph_detrit_Rich=length(NumberOfFish_perc[grepl(\"detritivore\",Trophic.Class)]),\n      Troph_carn_Rich=length(NumberOfFish_perc[grepl(\"carnivore\",Trophic.Class)]),\n      Troph_herb_Rich=length(NumberOfFish_perc[grepl(\"herbivore\",Trophic.Class)]),\n      Troph_plank_Rich=length(NumberOfFish_perc[grepl(\"planktivore\",Trophic.Class)]),\n      # Tolerance\n      Tol_tol_Bioperc=sum(EstimatedBiomass_perc[Tolerance==\"tolerant\"],na.rm=T),\n      Tol_intol_Bioperc=sum(EstimatedBiomass_perc[Tolerance==\"intolerant\"],na.rm=T),\n      Tol_tol_Abuperc=sum(NumberOfFish_perc[Tolerance==\"tolerant\"],na.rm=T),\n      Tol_intol_Abuperc=sum(NumberOfFish_perc[Tolerance==\"intolerant\"],na.rm=T),\n      Tol_tol_Bio=sum(EstimatedBiomass_perc[Tolerance==\"tolerant\"],na.rm=T)*Comm_Biomass,\n      Tol_intol_Bio=sum(EstimatedBiomass_perc[Tolerance==\"intolerant\"],na.rm=T)*Comm_Biomass,\n      Tol_tol_Abu=sum(NumberOfFish_perc[Tolerance==\"tolerant\"],na.rm=T)*Comm_Abundance,\n      Tol_intol_Abu=sum(NumberOfFish_perc[Tolerance==\"intolerant\"],na.rm=T)*Comm_Abundance,\n      Tol_tol_Rich=length(NumberOfFish_perc[Tolerance==\"tolerant\"]),\n      Tol_intol_Rich=length(NumberOfFish_perc[Tolerance==\"intolerant\"]),\n      # Individual Species - \n      Spec_RBD_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode==337],na.rm=T),\n      Spec_RBD_Abuperc=sum(NumberOfFish_perc[SpeciesCode==337],na.rm=T),\n      Spec_BKT_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode==80],na.rm=T),\n      Spec_BKT_Abuperc=sum(NumberOfFish_perc[SpeciesCode==80],na.rm=T),\n      Spec_GDF_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode==181],na.rm=T),\n      Spec_GDF_Abuperc=sum(NumberOfFish_perc[SpeciesCode==181],na.rm=T),\n      Spec_CMC_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode==186],na.rm=T),\n      Spec_CMC_Abuperc=sum(NumberOfFish_perc[SpeciesCode==186],na.rm=T),\n      Spec_RDG_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode==366],na.rm=T),\n      Spec_RDG_Abuperc=sum(NumberOfFish_perc[SpeciesCode==366],na.rm=T),\n      Spec_CKC_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode==212],na.rm=T),\n      Spec_CKC_Abuperc=sum(NumberOfFish_perc[SpeciesCode==212],na.rm=T),\n      Spec_SKP_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode %in% c(381,382)],na.rm=T),\n      Spec_SKP_Abuperc=sum(NumberOfFish_perc[SpeciesCode %in% c(381,382)],na.rm=T),\n      Spec_LMP_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode %in% c(11:14)],na.rm=T),\n      Spec_LMP_Abuperc=sum(NumberOfFish_perc[SpeciesCode %in% c(11:14)],na.rm=T),\n      Spec_DRT_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode %in% c(335:340,342)],na.rm=T),\n      Spec_DRT_Abuperc=sum(NumberOfFish_perc[SpeciesCode %in% c(335:340,342)],na.rm=T),\n      Spec_CEB_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode %in% c(311, 313:317)],na.rm=T),\n      Spec_CEB_Abuperc=sum(NumberOfFish_perc[SpeciesCode %in% c(311, 313:317)],na.rm=T),\n      Spec_CTF_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode %in% c(231:233)],na.rm=T),\n      Spec_CTF_Abuperc=sum(NumberOfFish_perc[SpeciesCode %in% c(231:233)],na.rm=T),\n      Spec_SAL_Bioperc=sum(EstimatedBiomass_perc[SpeciesCode %in% c(71:83)],na.rm=T),\n      Spec_SAL_Abuperc=sum(NumberOfFish_perc[SpeciesCode %in% c(71:83)],na.rm=T),\n      \n      Spec_RBD_Bio=sum(EstimatedBiomass_perc[SpeciesCode==337],na.rm=T)*Comm_Biomass,\n      Spec_RBD_Abu=sum(NumberOfFish_perc[SpeciesCode==337],na.rm=T)*Comm_Abundance,\n      Spec_BKT_Bio=sum(EstimatedBiomass_perc[SpeciesCode==80],na.rm=T)*Comm_Biomass,\n      Spec_BKT_Abu=sum(NumberOfFish_perc[SpeciesCode==80],na.rm=T)*Comm_Abundance,\n      Spec_GDF_Bio=sum(EstimatedBiomass_perc[SpeciesCode==181],na.rm=T)*Comm_Biomass,\n      Spec_GDF_Abu=sum(NumberOfFish_perc[SpeciesCode==181],na.rm=T)*Comm_Abundance,\n      Spec_CMC_Bio=sum(EstimatedBiomass_perc[SpeciesCode==186],na.rm=T)*Comm_Biomass,\n      Spec_CMC_Abu=sum(NumberOfFish_perc[SpeciesCode==186],na.rm=T)*Comm_Abundance,\n      Spec_RDG_Bio=sum(EstimatedBiomass_perc[SpeciesCode==366],na.rm=T)*Comm_Biomass,\n      Spec_RDG_Abu=sum(NumberOfFish_perc[SpeciesCode==366],na.rm=T)*Comm_Abundance,\n      Spec_CKC_Bio=sum(EstimatedBiomass_perc[SpeciesCode==212],na.rm=T)*Comm_Biomass,\n      Spec_CKC_Abu=sum(NumberOfFish_perc[SpeciesCode==212],na.rm=T)*Comm_Abundance,\n      Spec_SKP_Bio=sum(EstimatedBiomass_perc[SpeciesCode %in% c(381,382)],na.rm=T)*Comm_Biomass,\n      Spec_SKP_Abu=sum(NumberOfFish_perc[SpeciesCode %in% c(381,382)],na.rm=T)*Comm_Abundance,\n      Spec_LMP_Bio=sum(EstimatedBiomass_perc[SpeciesCode %in% c(11:14)],na.rm=T)*Comm_Biomass,\n      Spec_LMP_Abu=sum(NumberOfFish_perc[SpeciesCode %in% c(11:14)],na.rm=T)*Comm_Abundance,\n      Spec_DRT_Bio=sum(EstimatedBiomass_perc[SpeciesCode %in% c(335:340,342)],na.rm=T)*Comm_Biomass,\n      Spec_DRT_Abu=sum(NumberOfFish_perc[SpeciesCode %in% c(335:340,342)],na.rm=T)*Comm_Abundance,\n      Spec_CEB_Bio=sum(EstimatedBiomass_perc[SpeciesCode %in% c(311, 313:317)],na.rm=T)*Comm_Biomass,\n      Spec_CEB_Abu=sum(NumberOfFish_perc[SpeciesCode %in% c(311, 313:317)],na.rm=T)*Comm_Abundance,\n      Spec_CTF_Bio=sum(EstimatedBiomass_perc[SpeciesCode %in% c(231:233)],na.rm=T)*Comm_Biomass,\n      Spec_CTF_Abu=sum(NumberOfFish_perc[SpeciesCode %in% c(231:233)],na.rm=T)*Comm_Abundance,\n      Spec_SAL_Bio=sum(EstimatedBiomass_perc[SpeciesCode %in% c(71:83)],na.rm=T)*Comm_Biomass,\n      Spec_SAL_Abu=sum(NumberOfFish_perc[SpeciesCode %in% c(71:83)],na.rm=T)*Comm_Abundance,\n      # Environment\n      Env_benthic_Bioperc=sum(EstimatedBiomass_perc[Environment==\"benthic\"],na.rm=T),\n      Env_pelagic_Bioperc=sum(EstimatedBiomass_perc[Environment==\"pelagic\"],na.rm=T),\n      Env_benthopelagic_Bioperc=sum(EstimatedBiomass_perc[Environment==\"benthopelagic\"],na.rm=T),\n      Env_benthic_Abuperc=sum(NumberOfFish_perc[Environment==\"benthic\"],na.rm=T),\n      Env_pelagic_Abuperc=sum(NumberOfFish_perc[Environment==\"pelagic\"],na.rm=T),\n      Env_benthopelagic_Abuperc=sum(NumberOfFish_perc[Environment==\"benthopelagic\"],na.rm=T),\n      Env_benthic_Bio=sum(EstimatedBiomass_perc[Environment==\"benthic\"],na.rm=T)*Comm_Biomass,\n      Env_pelagic_Bio=sum(EstimatedBiomass_perc[Environment==\"pelagic\"],na.rm=T)*Comm_Biomass,\n      Env_benthopelagic_Bio=sum(EstimatedBiomass_perc[Environment==\"benthopelagic\"],na.rm=T)*Comm_Biomass,\n      Env_benthic_Abu=sum(NumberOfFish_perc[Environment==\"benthic\"],na.rm=T)*Comm_Abundance,\n      Env_pelagic_Abu=sum(NumberOfFish_perc[Environment==\"pelagic\"],na.rm=T)*Comm_Abundance,\n      Env_benthopelagic_Abu=sum(NumberOfFish_perc[Environment==\"benthopelagic\"],na.rm=T)*Comm_Abundance,\n      Env_benthic_Rich=length(NumberOfFish_perc[Environment==\"benthic\"]),\n      Env_pelagic_Rich=length(NumberOfFish_perc[Environment==\"pelagic\"]),\n      Env_benthopelagic_Rich=length(NumberOfFish_perc[Environment==\"benthopelagic\"]),\n      # Reproductive Guild\n      ## Guarders\n      Rep_guard_Bioperc=sum(EstimatedBiomass_perc[grepl(\"^B\\\\.\",Reproductive.Code)],na.rm=T),\n      Rep_guard_Abuperc=sum(NumberOfFish_perc[grepl(\"^B\\\\.\",Reproductive.Code)],na.rm=T),\n      Rep_guard_Bio=sum(EstimatedBiomass_perc[grepl(\"^B\\\\.\",Reproductive.Code)],na.rm=T)*Comm_Biomass,\n      Rep_guard_Abu=sum(NumberOfFish_perc[grepl(\"^B\\\\.\",Reproductive.Code)],na.rm=T)*Comm_Abundance,\n      Rep_guard_Rich=length(NumberOfFish_perc[grepl(\"^B\\\\.\",Reproductive.Code)]),\n      ## Nesting?\n      Rep_OSS_Bioperc=sum(EstimatedBiomass_perc[grepl(\"\\\\.1\\\\.\",Reproductive.Code)],na.rm=T),\n      Rep_OSS_Abuperc=sum(NumberOfFish_perc[grepl(\"\\\\.1\\\\.\",Reproductive.Code)],na.rm=T),\n      Rep_OSS_Bio=sum(EstimatedBiomass_perc[grepl(\"\\\\.1\\\\.\",Reproductive.Code)],na.rm=T)*Comm_Biomass,\n      Rep_OSS_Abu=sum(NumberOfFish_perc[grepl(\"\\\\.1\\\\.\",Reproductive.Code)],na.rm=T)*Comm_Abundance,\n      Rep_OSS_Rich=length(NumberOfFish_perc[grepl(\"\\\\.1\\\\.\",Reproductive.Code)]),\n      Rep_BrHid_Bioperc=sum(EstimatedBiomass_perc[grepl(\"\\\\.2\\\\.\",Reproductive.Code)],na.rm=T),\n      Rep_BrHid_Abuperc=sum(NumberOfFish_perc[grepl(\"\\\\.2\\\\.\",Reproductive.Code)],na.rm=T),\n      Rep_BrHid_Bio=sum(EstimatedBiomass_perc[grepl(\"\\\\.2\\\\.\",Reproductive.Code)],na.rm=T)*Comm_Biomass,\n      Rep_BrHid_Abu=sum(NumberOfFish_perc[grepl(\"\\\\.2\\\\.\",Reproductive.Code)],na.rm=T)*Comm_Abundance,\n      Rep_BrHid_Rich=length(NumberOfFish_perc[grepl(\"\\\\.2\\\\.\",Reproductive.Code)]),\n      ## Lithophilic\n      Rep_Lith_Bioperc=sum(EstimatedBiomass_perc[grepl(\"Litho\",Reproductive.Guild)],na.rm=T),\n      Rep_Lith_Abuperc=sum(NumberOfFish_perc[grepl(\"Litho\",Reproductive.Guild)],na.rm=T),\n      Rep_Lith_Bio=sum(EstimatedBiomass_perc[grepl(\"Litho\",Reproductive.Guild)],na.rm=T)*Comm_Biomass,\n      Rep_Lith_Abu=sum(NumberOfFish_perc[grepl(\"Litho\",Reproductive.Guild)],na.rm=T)*Comm_Abundance,\n      Rep_Lith_Rich=length(NumberOfFish_perc[grepl(\"Litho\",Reproductive.Guild)]),\n      .groups=\"drop\"\n    ) \n  \n  return(ep_tbl)\n}\n\n\n\n\nsource(\"00_Functions/FWIS_Functions.R\")\nlibrary(tidyverse)\n\nusername&lt;-Sys.getenv(\"FWIS_username\")\npassword&lt;-Sys.getenv(\"FWIS_password\")\n\nfwis_login&lt;-wideLogin(\"http://www.comap.ca/fwis/wideR.php\",username,password)\n\n\n# Habitat Data ------------------------------------------------------------\n\nhab_tbls&lt;-c(\"tblChannelStructureSummary\")\n\ncolumns &lt;- wideDataSelect(1,\n                          \"tblDataAPI\",\n                          list(\"tbldColName\", \"tbldActionsRdRegUser\", \"tbldPK\", \"tbldNulls\", \"tbldType\", \"tbldGSConstraint\",\"tbldFilePath\",\"tbldFileFolder\"),\n                          where=list(tbldUserTblName=c(\"=\",hab_tbls)),\n                          orderBy=list(\"tbldOrdering\"))\n\ndata &lt;- wideDataSelect( 1, table=hab_tbls, colsSelected=as.list(columns$tbldColName) )\n\nwrite_csv(data,\"data/tblChannelStructureSummary.csv\")\n\n# Fish Data ---------------------------------------------------------------\n\nfish_tbls&lt;-c(\"tblFishSummaryOfTotalCatches\")\n\ncolumns &lt;- wideDataSelect(1,\n                          \"tblDataAPI\",\n                          list(\"tbldColName\", \"tbldActionsRdRegUser\", \"tbldPK\", \"tbldNulls\", \"tbldType\", \"tbldGSConstraint\",\"tbldFilePath\",\"tbldFileFolder\"),\n                          where=list(tbldUserTblName=c(\"=\",fish_tbls)),\n                          orderBy=list(\"tbldOrdering\"))\n\ndata &lt;- wideDataSelect( 1, table=fish_tbls, colsSelected=as.list(columns$tbldColName) )\n\nwrite_csv(data,\"data/tblFishSummaryOfTotalCatches.csv\")\n\n# Fish Habitat Data -------------------------------------------------------\n\nfish_tbls&lt;-c(\"lkpSpeciesHabitatRequirement\")\n\ncolumns &lt;- wideDataSelect(1,\n                          \"tblDataAPI\",\n                          list(\"tbldColName\", \"tbldActionsRdRegUser\", \"tbldPK\", \"tbldNulls\", \"tbldType\", \"tbldGSConstraint\",\"tbldFilePath\",\"tbldFileFolder\"),\n                          where=list(tbldUserTblName=c(\"=\",fish_tbls)),\n                          orderBy=list(\"tbldOrdering\"))\n\ndata &lt;- wideDataSelect( 1, table=fish_tbls, colsSelected=as.list(columns$tbldColName) )\n\nwrite_csv(data,\"data/lkpSpeciesHabitatRequirement.csv\")\n\n# Benthic Invertebrate Data -----------------------------------------------\n\n# Benthic Invertebrate Download -------------------------------------------\n\ntables &lt;- unique(wideDataSelect(1,\"tblDataAPI\", list(\"tbldUserTblName\"), orderBy = list(\"tbldUserTblName\")))\n\nbic_tbls&lt;-tables$tbldUserTblName[grepl(\"benthic\",tolower(tables$tbldUserTblName)) & grepl(\"tbl\",tolower(tables$tbldUserTblName))]\n\nbic_all&lt;-lapply(setNames(bic_tbls,bic_tbls),function(x){\n  columns &lt;- wideDataSelect(1,\n                            \"tblDataAPI\",\n                            list(\"tbldColName\", \"tbldActionsRdRegUser\", \"tbldPK\", \"tbldNulls\", \"tbldType\", \"tbldGSConstraint\",\"tbldFilePath\",\"tbldFileFolder\"),\n                            where=list(tbldUserTblName=c(\"=\",x)),\n                            orderBy=list(\"tbldOrdering\"))\n  \n  wideDataSelect( 1, table=x, colsSelected=as.list(columns$tbldColName) )\n  \n})\n\nsaveRDS(bic_all,\"data/BIC_ALL.rds\")\n\nobbn_tbls&lt;-tables$tbldUserTblName[grepl(\"obbn\",tolower(tables$tbldUserTblName)) & grepl(\"tbl\",tolower(tables$tbldUserTblName))]\n\nobbn_all&lt;-lapply(setNames(obbn_tbls,obbn_tbls),function(x){\n  columns &lt;- wideDataSelect(1,\n                            \"tblDataAPI\",\n                            list(\"tbldColName\", \"tbldActionsRdRegUser\", \"tbldPK\", \"tbldNulls\", \"tbldType\", \"tbldGSConstraint\",\"tbldFilePath\",\"tbldFileFolder\"),\n                            where=list(tbldUserTblName=c(\"=\",x)),\n                            orderBy=list(\"tbldOrdering\"))\n  \n  columns$tbldColName &lt;- gsub(\"Â\", \"\", columns$tbldColName)\n  \n  wideDataSelect( 1, table=x, colsSelected=as.list(columns$tbldColName) )\n  \n})\n\nsaveRDS(obbn_all,\"data/OBBN_ALL.rds\")\n\n\n\n\nsource(\"00_source.R\")\nlibrary(openxlsx)\n\n\n# Read in Data ------------------------------------------------------------\ndat &lt;- read_csv(\"data/tblChannelStructureSummary.csv\", locale = locale(encoding = \"latin1\"))\n\n\n# Add additional endpoints ------------------------------------------------\ndat &lt;- dat %&gt;% \n  mutate(\n    TotalCoverTypePCWood = EmbCoverTypePCWood + UnembCoverTypePCWood,\n    TotalCoverTypePCRndRock = EmbCoverTypePCRndRock + UnembCoverTypePCRndRock,\n    TotalCoverTypePCFltRock = EmbCoverTypePCFltRock + UnembCoverTypePCFltRock,\n    TotalCoverTypePCMacrophyte = EmbCoverTypePCMacrophyte + UnembCoverTypePCMacrophyte,\n    TotalCoverTypePCBank = EmbCoverTypePCBank + UnembCoverTypePCBank,\n  ) %&gt;% \n  mutate(\n    TotalVegTypePCFL = EmbVegTypePCFL + UnembVegTypePCFL,\n    TotalVegTypePCAL = EmbVegTypePCAL + UnembVegTypePCAL,\n    TotalVegTypePCSS = EmbVegTypePCSS + UnembVegTypePCSS,\n    TotalVegTypePCMC = EmbVegTypePCMC + UnembVegTypePCMC,\n  )\n\n# Exclude test data\ndat &lt;- dat %&gt;% \n  select(all_of(c(unlist(ID_cols),unlist(met_cols),StreamType = \"substrateQualityRatingCode\"))) %&gt;% \n  filter(!StreamCode %in% c(\"TEST\")) %&gt;% \n  filter(!grepl(\"Training\",OrgNameList)) %&gt;% \n  filter(SiteCode != \"NCD21-1C\") #%&gt;% # TRCA site not within bounds of TRCA shape file\n#filter(SiteCode != \"PT003WM\") %&gt;%  # incorrect coordinates\n#filter(SiteCode != \"PT002WM\") \n# filter(month(SampleDate) != \"1\",\n#        month(SampleDate) != \"2\",\n#        month(SampleDate) != \"12\")\n\n# Remove samples without location information\ndat &lt;- dat  %&gt;% \n  rename_with(~gsub(\"^.*?\\\\.\",\"\",.x)) %&gt;% \n  mutate(Longitude = as.numeric(Longitude),\n         Latitude = as.numeric(Latitude)) %&gt;% \n  group_by(SiteCode) %&gt;% \n  mutate(Longitude = median(Longitude,na.rm = T),\n         Latitude = median(Latitude,na.rm = T),\n  ) %&gt;% \n  filter(!is.na(Longitude),\n         !is.na(Latitude)) %&gt;% \n  ungroup()\n\n# Add utility columns\ndat &lt;- dat %&gt;% \n  group_by(!!!syms(ID_cols[!ID_cols %in% c(\"ID\",\"SampleDate\",\"Sample\",\"Longitude\",\"Latitude\")]))  %&gt;% \n  mutate(\n    Month = month(SampleDate),\n    Year = year(SampleDate),\n    `Sample Season` = case_when(\n      Month %in% 3:5 ~ \"Spring\",\n      Month %in% 6:8 ~ \"Summer\",\n      Month %in% 9:11 ~ \"Fall\",\n      T ~ \"Winter\"\n    ),\n    `Sample Years` = paste(sort(unique(Year)),collapse = \", \"),\n    `Sample Months` = paste(sort(unique(Month)),collapse = \", \"),\n    `Years of Data` = length(unique(Year)),\n    `Year-Month`=format(SampleDate,\"%Y-%m\"),\n    `Sample Year-Months` = paste(sort(unique(`Year-Month`)),collapse = \", \"),\n    `Sample Year-Season` = paste(sort(unique(`Year-Month`)),collapse = \", \"),\n    `TRCA` = OrgNameList == \"Toronto and Region Conservation Authority\",\n    `Sample Season`=factor(`Sample Season`,levels=c(\"Sping\",\"Summer\",\"Fall\",\"Winter\"))\n  ) %&gt;% \n  filter(Year &lt; 2025) %&gt;% \n  ungroup() %&gt;% \n  group_by(!!!syms(c(ID_cols[!ID_cols %in% c(\"ID\",\"SampleDate\",\"Sample\",\"Longitude\",\"Latitude\")],\"Year\"))) %&gt;% \n  mutate( \n    `Sampled Days within Year` = length(unique(SampleDate)),\n    `Sampled Seasons within Year` = length(unique(`Sample Season`)),\n  ) %&gt;% \n  ungroup() %&gt;% \n  rowwise() %&gt;% \n  mutate(\n    `Number of Missing Endpoints` = sum(is.na(c_across(unlist(sapply(met_cols,names),use.names = F))))\n  ) %&gt;% \n  ungroup() %&gt;% \n  mutate(\n    Year_n = (max(Year)-min(Year))-(max(Year)-Year)+1,\n    year_class = case_when(\n      Year %in% 1995:2000 ~ \"1995-2000\",\n      Year %in% 2001:2006 ~ \"2001-2006\",\n      Year %in% 2007:2012 ~ \"2007-2012\",\n      Year %in% 2013:2018 ~ \"2013-2018\",\n      Year %in% 2019:2024 ~ \"2019-2024\",\n    )\n  ) %&gt;% \n  mutate(\n    year_class = factor(year_class,levels=rev(c(\"1995-2000\",\"2001-2006\",\"2007-2012\",\"2013-2018\",\"2019-2024\")))\n  )\n\n\n# Filter Data -------------------------------------------------------------\ndat &lt;- dat %&gt;% \n  filter(`Years of Data` &gt; 3 & length(unique(year_class)) &gt; 1) %&gt;% \n  group_by(SiteCode,TRCA) %&gt;% \n  filter(\n    !TRCA | `Years of Data` &gt; 3,\n    !TRCA | any(Year &gt; 2018),\n    !TRCA | length(unique(year_class)) &gt; 1,\n    !TRCA | grepl(\"WM$|WMB$\",SiteCode)\n  ) %&gt;% \n  ungroup() \n\n# Duplicate TRCA data in full analysis subset -----------------------------\ndat &lt;- bind_rows(\n  dat %&gt;% mutate(TRCA=F),\n  dat %&gt;% filter(TRCA) %&gt;% mutate(TRCA=T)\n)\n\nif (F){\n  # Get Ranges -------------------------------------------------------------\n  \n  dat %&gt;% \n    pivot_longer(all_of(unlist(sapply(met_cols,names),use.names = F)),\n                 names_to = \"Endpoint\") %&gt;% \n    ggplot(aes(x=value)) +\n    geom_histogram() +\n    facet_wrap(~Endpoint,scales=\"free\")\n  \n  dat %&gt;% \n    pivot_longer(all_of(unlist(sapply(met_cols,names),use.names = F)),\n                 names_to = \"Endpoint\") %&gt;% \n    group_by(Endpoint) %&gt;% \n    summarise(\n      min = min(value,na.rm = T),\n      max = max(value,na.rm = T)\n    ) %&gt;% \n    print(n=Inf)\n  \n}\n\n# Convert Percent to Proportion -------------------------------------------\n\ndat &lt;- dat %&gt;% \n  mutate(\n    across(\n      contains(c(\"Cover\",\"Percent\")),\n      ~ .x/100\n    )\n  )\n\n# Replace problematic values ------------------------------------------------\n\n\ndat &lt;- dat %&gt;% \n  mutate(\n    `Habitat Stability Score` = `Habitat Stability Score` - 0.5,\n    `Habitat Homogeneity` = 1-`Habitat Homogeneity`,\n    across(\n      c(D15,D50,D85,D50Max),\n      ~ case_when(\n        .x &lt; 0 ~ NA_real_,\n        .x &lt;= 2 ~ 0,\n        .x &gt;= 1000 ~ NA_real_,\n        T ~ .x\n      )\n    ),\n    D15 = case_when(\n      D15 &gt; 50 ~ NA_real_,\n      T ~ D15\n    ),\n    across(\n      c(`Sediment Transport Potential`),\n      ~ case_when(\n        .x &lt; 0 ~ NA_real_,\n        T ~ .x\n      )\n    ),\n    across(\n      c(`Sediment Sorting Index`),\n      ~ case_when(\n        .x &lt; 0 ~ NA_real_,\n        T ~ .x\n      )\n    ),\n    across(\n      c(\n        contains(c(\"Cover\",\"Percent\")),\n        `Habitat Stability Score`,\n        `Habitat Homogeneity`,\n        `Bank Stability - Mean`\n      ),\n      ~ case_when(\n        .x &gt;= 1 ~ quantile(.x[.x&lt;1 & .x&gt;0],0.99,na.rm=T),\n        .x &lt; 0 ~ NA_real_,\n        T ~ .x\n      )\n    ),\n    across(\n      c(\n        contains(c(\"Cover\",\"Percent\"))\n      ),\n      ~ case_when(\n        .x &lt; 0.02 ~ 0,\n        T ~ .x\n      )\n    )\n  )\n\n\n# Convert to sf, and attribute with watershed info\n\ndat &lt;- dat %&gt;% \n  sf::st_as_sf(coords=c(\"Longitude\",\"Latitude\"),crs=\"WGS84\",remove = F)\n\n\n# Geospatial analysis -----------------------------------------------------\n\nTRCA_subwats &lt;- sf::read_sf(\"data/Subwatersheds_TRCA.geojson\")\n\nsf::sf_use_s2(F) # there is an invalid geometry\n\nunzip(\"data/AEC_V3_Core_Rev0_GPKG_Package02_LakeOntario.zip\",exdir=tempdir())\nunzip(\"data/AEC_V3_Core_Rev0_GPKG_Package04_LakeHuronSouth.zip\",exdir=tempdir())\nunzip(\"data/AEC_V3_Core_Rev0_GPKG_Package06_LakeSuperior.zip\",exdir=tempdir())\nunzip(\"data/AEC_V3_Core_Rev0_GPKG_Package03_OttawaStLawrenceRivers.zip\",exdir=tempdir())\nstrm_lns &lt;- list(\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package02_LakeOntario/w03_Lake_Ontario_West/w03_AEC_V3_Core_Rev0.gpkg\"),\n    \"w03_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package02_LakeOntario/w06_Lake_Ontario_East/w06_AEC_V3_Core_Rev0.gpkg\"),\n    \"w06_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package02_LakeOntario/w04_Lake_Ontario_Central/w04_AEC_V3_Core_Rev0.gpkg\"),\n    \"w04_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package06_LakeSuperior/w23_Lake_Superior_North_West/w23_AEC_V3_Core_Rev0.gpkg\"),\n    \"w23_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package03_OttawaStLawrenceRivers/w08_Ottawa_River_Lower/w08_AEC_V3_Core_Rev0.gpkg\"),\n    \"w08_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package03_OttawaStLawrenceRivers/w09_Ottawa_River_Central_South/w09_AEC_V3_Core_Rev0.gpkg\"),\n    \"w09_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package04_LakeHuronSouth/w14_Georgian_Bay_South_Simcoe/w14_AEC_V3_Core_Rev0.gpkg\"),\n    \"w14_Reach_SimpleGeometry_Core\")\n  ,\n  sf::read_sf(\n    file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package04_LakeHuronSouth/w15_Georgian_Bay_Central/w15_AEC_V3_Core_Rev0.gpkg\"),\n    \"w15_Reach_SimpleGeometry_Core\")\n)\n\nstrm_lns &lt;- bind_rows(strm_lns)\n\nstrm_lns &lt;- strm_lns %&gt;% \n  filter(Network_Line_Type != \"Shoreline Virtual Connector\",\n         Network_Line_Type != \"Virtual Connector\") %&gt;% \n  sf::st_transform(sf::st_crs(dat))\n\ndat &lt;- sf::st_join(dat,\n                   TRCA_subwats %&gt;% select(WSHED,Subshed)\n)\n\ndat &lt;- sf::st_join(dat,\n                   strm_lns %&gt;% select(WorkUnitID,ProvReachID,`Strahler Order`=Strahler_Order,`Upstream Catchment Area`=Upstream_Catchment_Area,`Baseflow Index`=BFI_RCA,`Reach Slope`=Slope_ReachChannel_Percent,Turbidity_percUpstreamChannel_T,Turbidity,Flow_Velocity),\n                   join =nngeo::st_nn,k=1,maxdist=Inf,parallel=8\n)\n\ndat &lt;- dat %&gt;% \n  left_join(\n    read_csv(\"data/AEC_supplementary_MWP_human_disturbance_gradients.csv\") %&gt;% \n      select(ProvReachID = ReachID, `Upstream catchment developed (%)`,\n             `Upstream catchment agricultural (%)`,\n             `Upstream catchment stress index`,\n             `Upstream catchment disturbance status`)\n  )\n\ndat &lt;- dat %&gt;% \n  mutate(\n    WSHED = case_when(\n      is.na(WSHED) ~ as.character(WorkUnitID),\n      T ~ WSHED\n    ),\n    Subshed = case_when(\n      is.na(Subshed) ~ OrgNameList,\n      T ~ Subshed\n    )\n  )\n\nif (F) mapview::mapview(list(strm_lns,dat))\n\n\n# Summarize TRCA Streamlines ----------------------------------------------\n\n\nTRCA_strm_lns &lt;- strm_lns %&gt;% \n  filter(WorkUnitID %in% unique(dat$WorkUnitID)) %&gt;% \n  sf::st_join(TRCA_subwats %&gt;% select(WSHED,Subshed)) %&gt;% \n  left_join(\n    read_csv(\"data/AEC_supplementary_MWP_human_disturbance_gradients.csv\") %&gt;% \n      select(ProvReachID = ReachID, `Upstream catchment developed (%)`,\n             `Upstream catchment agricultural (%)`,\n             `Upstream catchment stress index`,\n             `Upstream catchment disturbance status`)\n  ) %&gt;% \n  rename(\n    `Strahler Order` = Strahler_Order,\n    `Upstream Catchment Area`=Upstream_Catchment_Area,\n    `Baseflow Index`=BFI_RCA,\n    `Reach Slope`=Slope_ReachChannel_Percent\n  )\n\nTRCA_strm_lns &lt;- bind_rows(\n  TRCA_strm_lns %&gt;% \n    filter(!is.na(Subshed)) %&gt;% \n    mutate(TRCA=T),\n  TRCA_strm_lns %&gt;% \n    mutate(TRCA=F) %&gt;% \n    mutate(WSHED = as.character(WorkUnitID),\n           Subshed = as.character(WorkUnitID))\n)\n\nTRCA_strm_lns &lt;- TRCA_strm_lns %&gt;% \n  mutate(`Stress Class` = cut(`Upstream catchment stress index`,\n                              breaks = 3)) \n\nTRCA_strm_lns &lt;- TRCA_strm_lns %&gt;% \n  mutate(`Stress Class` = cut(`Upstream catchment stress index`,\n                              breaks = 3)) \n\nlevels(TRCA_strm_lns$`Stress Class`) &lt;- c(\"Low\",\"Medium\",\"High\")\nTRCA_strm_lns$`Stress Class` &lt;- as.character(TRCA_strm_lns$`Stress Class`)\nTRCA_strm_lns$`Stress Class`[is.na(TRCA_strm_lns$`Stress Class`)] &lt;- \"North\"\nTRCA_strm_lns$`Stress Class` &lt;- factor(TRCA_strm_lns$`Stress Class`,levels = c(\"Low\",\"Medium\",\"High\",\"North\"))\n\nTRCA_strm_lns &lt;- map(\n  c(\"Subshed\",\"WSHED\",\"Strahler Order\",\"Stress Class\",\"Strahler Order:Stress Class\"),\n  ~{TRCA_strm_lns %&gt;% \n      as_tibble() %&gt;% \n      mutate(`Strahler Order:Stress Class` = paste(`Strahler Order`,`Stress Class`,sep = \".\")) %&gt;% \n      mutate(group=.x) %&gt;% \n      rename_with(.cols=any_of(.x),~paste0(\"group_val\")) %&gt;% \n      mutate(group_val=as.character(group_val)) %&gt;% \n      group_by(TRCA,group,group_val) %&gt;% \n      summarise(\n        across(c(\n          `Upstream Catchment Area`,\n        ),\n        ~mean(log10(.x),na.rm=T)^10\n        ),\n        across(c(\n          `Reach Slope`,\n        ),\n        ~expm1(mean(log1p(.x),na.rm=T))\n        ),\n        across(c(\n          `Baseflow Index`,\n          `Upstream catchment developed (%)`,\n          `Upstream catchment agricultural (%)`,\n          `Upstream catchment stress index`\n        ),\n        ~median(.x,na.rm=T)\n        )\n      )\n  }\n)\n\nTRCA_strm_lns &lt;- bind_rows(TRCA_strm_lns)\n\nwrite_csv(TRCA_strm_lns,\"data/predictor_summaries.csv\")\n\n# Convert locations to factors --------------------------------------------\n\ndat &lt;- dat %&gt;% \n  group_by(WSHED) %&gt;% \n  mutate(Longitude_w = median(Longitude),\n         Latitude_w = median(Latitude)) %&gt;% \n  group_by(Subshed) %&gt;% \n  mutate(Longitude_s = median(Longitude),\n         Latitude_s = median(Latitude)) %&gt;% \n  mutate(\n    WSHED = factor(WSHED,levels=unique(WSHED[order(Longitude_w)])),\n    Subshed = factor(Subshed,levels=unique(Subshed[order(Longitude_s)])),\n    SiteCode = factor(SiteCode,levels=unique(SiteCode[order(Longitude_s)]))\n  ) %&gt;% \n  ungroup()\n\n\n# Bin  streams by cross-sectional size ------------------------------------\n\ndat &lt;- dat %&gt;% \n  mutate(\n    Area = `Width - Mean`*`Depth - Mean`\n  ) %&gt;% \n  group_by(SiteCode) %&gt;% \n  mutate(Area = median(Area,na.rm=T)) \n\ndat &lt;- dat %&gt;% \n  group_by(TRCA) %&gt;% \n  mutate(Area_class = cut(`Usable Area`,\n                          breaks = scales::log_breaks(5)(`Usable Area`)\n  )) %&gt;% \n  ungroup()\n\n\ndat &lt;- dat %&gt;% \n  mutate(`Stress Class` = cut(`Upstream catchment stress index`,\n                              breaks = 3)) \n\nlevels(dat$`Stress Class`) &lt;- c(\"Low\",\"Medium\",\"High\")\ndat$`Stress Class` &lt;- as.character(dat$`Stress Class`)\ndat$`Stress Class`[is.na(dat$`Stress Class`)] &lt;- \"North\"\ndat$`Stress Class` &lt;- factor(dat$`Stress Class`,levels = c(\"Low\",\"Medium\",\"High\",\"North\"))\n\ndat &lt;- dat %&gt;% \n  group_by(SiteCode) %&gt;% \n  mutate(`Habitat Stability Class` = median(`Habitat Stability Score`,na.rm=T)) %&gt;% \n  ungroup() %&gt;% \n  mutate(`Habitat Stability Class` = cut(`Habitat Stability Class`,\n                                         breaks = 2)) \n\nlevels(dat$`Habitat Stability Class`) &lt;- c(\"Low\",\"High\")\ndat$`Habitat Stability Class` &lt;- as.character(dat$`Habitat Stability Class`)\ndat$`Habitat Stability Class`[is.na(dat$`Habitat Stability Class`)] &lt;- \"Missing\"\ndat$`Habitat Stability Class` &lt;- factor(dat$`Habitat Stability Class`,levels = c(\"Low\",\"High\",\"Missing\"))\n\ndat$`UCA Class` &lt;- cut(dat$`Upstream Catchment Area`,c(0,20,80,Inf))\nlevels(dat$`UCA Class`) &lt;- c(\"Small\",\"Intermediate\",\"Large\")\n\n# Pivot data long ---------------------------------------------------------\n\ndat_long &lt;- dat %&gt;% \n  pivot_longer(all_of(unlist(sapply(met_cols,names),use.names = F)),\n               names_to = \"Endpoint\") \n\n# Separate locations ------------------------------------------------------\n\nlocs &lt;- dat %&gt;% \n  select(all_of(c(ID_cols[!ID_cols %in% c(\"ID\",\"SampleDate\")],\"Sample Years\",\"Years of Data\",\"Sample Months\",\"Sample Year-Months\",\"Longitude\",\"Latitude\"))) %&gt;% \n  distinct() %&gt;% \n  sf::st_as_sf(coords=c(\"Longitude\",\"Latitude\"),crs=\"WGS84\")\n\nif (F) mapview::mapview(locs,zcol=\"OrgNameList\")\n\n\n# Save Data ---------------------------------------------------------------\n\nsaveRDS(\n  list(\n    wide = dat,\n    long = dat_long\n  ),\n  \"data/1_formatted_data.RDS\"\n)\n\n# Calculate Fish Endpoints ------------------------------------------------\n\n\nlookup_tbl&lt;-read.csv(file.path(\"data\",\"fish_lookup.csv\")) %&gt;% \n  mutate(name.to.use=trimws(name.to.use))\ncolnames(lookup_tbl)[colnames(lookup_tbl)==\"OMNR.Code\"]&lt;-\"SpeciesCode\"\n\nSATI_df&lt;-read.csv(file.path(\"data\",\"lkpSpeciesHabitatRequirement.csv\")) %&gt;% \n  select(SpeciesCode=FWISFishCode,OPT_TEMP) %&gt;% \n  distinct() %&gt;% \n  filter(!is.na(OPT_TEMP))\n\nlookup_tbl&lt;-left_join(lookup_tbl,SATI_df,by=\"SpeciesCode\")\n\nraw_tbl&lt;-read.csv(file.path(\"data\",\"tblFishSummaryOfTotalCatches.csv\")) %&gt;% \n  filter(SiteCode %in% locs$SiteCode,\n         year(as.Date(SampleDate))&gt;1995)\n\nraw_tbl&lt;-raw_tbl %&gt;% \n  filter( \n    OSAPSE==1, #the sample event was associated with at least one OSAP project and the sample event itself used site boundaries that were defined as per OSAP\n    !is.na(TotalWeightPer100m2) # This makes sure only valid single taxa are included (i.e., Cyprid bulk samples will be excluded)\n  )\n\n# Setup Sample Event table ------------------------------------------------\n\nSampleEventID&lt;-raw_tbl[!is.na(raw_tbl$UsableArea) & raw_tbl$UsableArea&gt;0,\n                       c(\"SampleEventID\",\n                         \"StreamName\",\n                         \"StreamCode\",\n                         \"SiteCode\",\n                         \"Latitude\",\n                         \"Longitude\",\n                         \"SampleEventType\",\n                         \"SampleDate\")]\n\nSampleEventID&lt;-distinct(SampleEventID)\n\nSampleEventID&lt;-SampleEventID[SampleEventID$SampleEventType==\"(Electro) Fish Sampling\",]\nSampleEventID&lt;-SampleEventID[!is.na(SampleEventID$Latitude) & !is.na(SampleEventID$Longitude),]\n\n# Setup Fish table --------------------------------------------------------\n\nsub_tbl&lt;-raw_tbl[raw_tbl$SampleEventID %in% SampleEventID$SampleEventID,\n                 c(\"SampleEventID\",\"SampleDate\",\"SpeciesCode\",\"CommonName\",\"ScientificName\",\"NumberOfFishPer100m2\",\"TotalWeightPer100m2\")] \n\n# sub_tbl$EstimatedBiomass&lt;-sub_tbl$BulkWeight/sub_tbl$UsableArea*100\n# sub_tbl$NumberOfFish&lt;-sub_tbl$NumberOfFish/sub_tbl$UsableArea*100\nsub_tbl$EstimatedBiomass&lt;-sub_tbl$TotalWeightPer100m2\nsub_tbl$NumberOfFish&lt;-sub_tbl$NumberOfFishPer100m2\n\nsub_tbl&lt;-sub_tbl[sub_tbl$NumberOfFish&gt;0,] %&gt;% \n  group_by(SampleEventID, SampleDate, SpeciesCode,CommonName,ScientificName) %&gt;% \n  summarise(\n    NumberOfFish=sum(NumberOfFish,na.rm=T),\n    EstimatedBiomass=sum(EstimatedBiomass,na.rm=T)\n  ) %&gt;% \n  ungroup() %&gt;% \n  na.omit()\n\natr_tbl&lt;-left_join(sub_tbl,lookup_tbl,by=\"SpeciesCode\") \n\n\n\n# Taxa Tables -------------------------------------------------------------\n\ntaxa_tbl1 &lt;- atr_tbl %&gt;% \n  group_by(SampleEventID,SampleDate) %&gt;% \n  mutate(Comm_Biomass=sum(EstimatedBiomass,na.rm=T),\n         Comm_Abundance=sum(NumberOfFish,na.rm=T),\n         Perc_Biomass=EstimatedBiomass/Comm_Biomass,\n         Perc_Abundance=NumberOfFish/Comm_Abundance\n  ) %&gt;% \n  ungroup() %&gt;% \n  select(SampleEventID,SampleDate,SpeciesCode,Comm_Biomass,Comm_Abundance,Perc_Biomass,Perc_Abundance) %&gt;% \n  mutate(SpeciesCode=factor(SpeciesCode)) %&gt;% \n  group_by(SampleEventID,SampleDate) %&gt;% \n  complete(SpeciesCode,fill = list(Comm_Biomass=0,Comm_Abundance=0,Perc_Biomass=0,Perc_Abundance=0)) %&gt;% \n  ungroup() %&gt;% \n  mutate(Comm_Biomass=ifelse(Perc_Abundance&gt;0 & Comm_Biomass==0,NA_real_,Comm_Biomass)) %&gt;% \n  mutate(Perc_Biomass=ifelse(Perc_Abundance&gt;0 & Perc_Biomass==0,NA_real_,Perc_Biomass))\n\n\n# No Catch Table ----------------------------------------------------------\n\nno_catch_tbl&lt;-SampleEventID %&gt;% \n  as_tibble() %&gt;% \n  select(SampleEventID,SampleDate) %&gt;% \n  left_join(taxa_tbl1,by = c(\"SampleEventID\", \"SampleDate\")) %&gt;% \n  filter(is.na(Comm_Biomass)) %&gt;% \n  mutate_at(vars(Comm_Biomass:Perc_Abundance),~0) %&gt;% \n  mutate(SpeciesCode=atr_tbl$SpeciesCode[[1]]) %&gt;% \n  mutate(SpeciesCode=factor(SpeciesCode,levels=unique(taxa_tbl1$SpeciesCode))) %&gt;% \n  group_by(SampleEventID,SampleDate) %&gt;% \n  #complete(SpeciesCode,fill = list(Comm_Biomass=0,Comm_Abundance=0,Perc_Biomass=0,Perc_Abundance=0)) %&gt;% \n  ungroup() \n\nlookup_tbl2&lt;-read_csv(file.path(\"data\",\"fish_lookup.csv\")) %&gt;% \n  mutate(`name to use`=trimws(`name to use`))\ncolnames(lookup_tbl2)[colnames(lookup_tbl2)==\"OMNR Code\"]&lt;-\"SpeciesCode\"\n\ntaxa_tbl&lt;-taxa_tbl1 %&gt;% \n  bind_rows(no_catch_tbl) %&gt;% \n  mutate(SpeciesCode=as.character(SpeciesCode)) %&gt;% \n  mutate(SpeciesCode=as.integer(SpeciesCode)) %&gt;% \n  left_join(lookup_tbl2,by=\"SpeciesCode\") %&gt;% \n  group_by(SampleEventID,SampleDate,`name to use`) %&gt;% \n  reframe(across(where(is.numeric),~sum(.,na.rm=T)),\n          across(where(is.character),~head(.[!is.na(.)],1))\n  ) %&gt;% \n  ungroup() %&gt;% \n  select(any_of(colnames(lookup_tbl2)),everything())\n\n# Calculate endpoints -----------------------------------------------------\n\natr_tbl&lt;-left_join(sub_tbl,lookup_tbl,by=\"SpeciesCode\") \n\nep_tbl&lt;-calc_fish_ep(atr_tbl)\n\n# No Catch Table ----------------------------------------------------------\n\nno_catch_tbl&lt;-SampleEventID %&gt;% \n  select(SampleEventID,SampleDate) %&gt;% \n  left_join(ep_tbl,by = c(\"SampleEventID\", \"SampleDate\")) %&gt;% \n  filter(is.na(Comm_Richness)) %&gt;% \n  mutate_at(vars(Comm_Biomass:Rep_Lith_Rich),~0)\n\nep_tbl[sapply(ep_tbl,is.nan)]&lt;-NA\n\nep_tbl&lt;-ep_tbl %&gt;% \n  bind_rows(no_catch_tbl)\n\n\n# Endpoint Index ----------------------------------------------------------\nep_tbl_lng&lt;-ep_tbl %&gt;% \n  gather(\"Endpoint\",\"Value\",-SampleEventID,-SampleDate) %&gt;% \n  mutate(Value=ifelse(is.nan(Value),NA,Value)) %&gt;% \n  mutate(Endpoint_group=case_when(\n    grepl(\"^Therm_\",Endpoint) ~ \"Thermal Regime\",\n    grepl(\"^Troph_\",Endpoint) ~ \"Trophic Guild\",\n    grepl(\"^Tol_\",Endpoint) ~ \"Tolerance Group\",\n    grepl(\"^Spec_\",Endpoint) ~ \"Individual Species\",\n    grepl(\"^Env_\",Endpoint) ~ \"Environment Preference\",\n    grepl(\"^Rep_\",Endpoint) ~ \"Reproductive Guild\",\n    grepl(\"^Comm_\",Endpoint) ~ \"General Community\"\n  )) %&gt;%\n  mutate(Endpoint_subgroup=str_split(Endpoint,\"_\",simplify = T)[,2]) %&gt;% \n  mutate(Endpoint_subgroup=case_when(\n    Endpoint_subgroup == \"SATI\" ~ \"SATI\",\n    Endpoint_subgroup == \"cold\" ~ \"Cold water\",\n    Endpoint_subgroup == \"cool\" ~ \"Cool water\",\n    Endpoint_subgroup == \"coolcold\" ~ \"Cold-Cool water\",\n    Endpoint_subgroup == \"warm\" ~ \"Warm water\",\n    Endpoint_subgroup == \"invert\" ~ \"Invertivore\",\n    Endpoint_subgroup == \"detrit\" ~ \"Detritivore\",\n    Endpoint_subgroup == \"carn\" ~ \"Carniivore\",\n    Endpoint_subgroup == \"herb\" ~ \"Herbiivore\",\n    Endpoint_subgroup == \"plank\" ~ \"Planktivore\",\n    Endpoint_subgroup == \"tol\" ~ \"Tolerant\",\n    Endpoint_subgroup == \"intol\" ~ \"Intolerant\",\n    Endpoint_subgroup == \"RBD\" ~ \"Rainbow Darter\",\n    Endpoint_subgroup == \"BKT\" ~ \"Brook Trout\",\n    Endpoint_subgroup == \"GDF\" ~ \"Goldfish\",\n    Endpoint_subgroup == \"RDG\" ~ \"Round Goby\",\n    Endpoint_subgroup == \"CKC\" ~ \"Creek Chub\",\n    Endpoint_subgroup == \"CMC\" ~ \"Common Carp\",\n    Endpoint_subgroup == \"SKP\" ~ \"Mottled and Slimy Sculpin\",\n    Endpoint_subgroup == \"LMP\" ~ \"Lampreys\",\n    Endpoint_subgroup == \"DRT\" ~ \"Sensitive Darters\",\n    Endpoint_subgroup == \"CEB\" ~ \"Centrarchids and Basses\",\n    Endpoint_subgroup == \"CTF\" ~ \"Catfishes\",\n    Endpoint_subgroup == \"SAL\" ~ \"Salmonids\",\n    Endpoint_subgroup == \"benthic\" ~ \"Benthic\",\n    Endpoint_subgroup == \"pelagic\" ~ \"Pelagic\",\n    Endpoint_subgroup == \"benthopelagic\" ~ \"Benthopelagic\",\n    Endpoint_subgroup == \"guard\" ~ \"Guarders\",\n    Endpoint_subgroup == \"BrHid\" ~ \"Brood Hiders/Nest Spawners\",\n    Endpoint_subgroup == \"OSS\" ~ \"Open Substratum/Substratum Choosers\",\n    Endpoint_subgroup == \"Lith\" ~ \"Lithophilic Spawners\",\n    Endpoint==\"Comm_Biomass\" ~ \"Total Biomass\",\n    Endpoint==\"Comm_Abundance\" ~ \"Total Abundance\",\n    Endpoint==\"Comm_Richness\" ~ \"Total Richness\"\n  )) %&gt;% \n  mutate(Endpoint_type=case_when(\n    grepl(\"_Bioperc$\",Endpoint) ~ \"Biomass (%)\",\n    grepl(\"_Abuperc$\",Endpoint) ~ \"Abundance (%)\",\n    grepl(\"_Bio$\",Endpoint) ~ \"Total Biomass\",\n    grepl(\"_Abu$\",Endpoint) ~ \"Total Abundance\",\n    grepl(\"_Rich$\",Endpoint) ~ \"Richness\",\n    Endpoint==\"Comm_Biomass\" ~ \"Total Biomass\",\n    Endpoint==\"Comm_Abundance\" ~ \"Total Abundance\",\n    Endpoint==\"Comm_Richness\" ~ \"Richness\"\n  )) %&gt;% \n  filter(!is.na(Value))\n\n\n# Write results to excel --------------------------------------------------\n\nep_tbl_out&lt;-ep_tbl %&gt;% \n  left_join(SampleEventID) %&gt;% \n  select(StreamName, StreamCode, SiteCode, Latitude, Longitude, SampleEventType, SampleDate,SampleEventID,everything())\n\nif (F){\n  ep_tbl_out %&gt;% \n    mutate(Year = year(as.Date(SampleDate)),\n           month = month(as.Date(SampleDate))) %&gt;% \n    group_by(SiteCode,Year) %&gt;% \n    summarise(\n      n_samples = n(),\n      months = paste0(month,collapse = \", \")\n    ) %&gt;% \n    arrange(desc(n_samples)) %&gt;% \n    View()\n}\n\nep_tbl_lng_out&lt;-ep_tbl_lng %&gt;% \n  left_join(SampleEventID) %&gt;% \n  select(StreamName, StreamCode, SiteCode, Latitude, Longitude, SampleEventType, SampleDate,SampleEventID,everything())\n\nparam_tbl_out&lt;-ep_tbl_lng %&gt;% \n  select(Endpoint_group,Endpoint_subgroup,Endpoint_type,Endpoint) %&gt;% \n  distinct()\n\ntaxa_tbl_out&lt;-taxa_tbl %&gt;% \n  left_join(SampleEventID) %&gt;% \n  select(StreamName, StreamCode, SiteCode, Latitude, Longitude, SampleEventType, SampleDate,SampleEventID,everything())\n\n\nwb = createWorkbook()\n\naddWorksheet(wb, \"Endpoints\")\naddWorksheet(wb, \"Results - Wide\")\naddWorksheet(wb, \"Results - Long\")\naddWorksheet(wb, \"Taxa Table\")\n\nwriteData(wb,param_tbl_out, sheet=\"Endpoints\", rowNames =FALSE)\nwriteData(wb,ep_tbl_out, sheet=\"Results - Wide\", rowNames =FALSE)\nwriteData(wb,ep_tbl_lng_out, sheet=\"Results - Long\", rowNames =FALSE)\nwriteData(wb,taxa_tbl_out, sheet=\"Taxa Table\", rowNames =FALSE)\n\nsaveWorkbook(wb, file.path(\"data\",\"Fish_Endpoints.xlsx\"),overwrite = T)\n\nfinal_fish_out &lt;- ep_tbl_lng_out %&gt;% \n  mutate(Year = year(as.Date(SampleDate))) %&gt;% \n  select(SiteCode,Year,Endpoint,Endpoint_group,Endpoint_subgroup,Endpoint_type,Value) %&gt;% \n  group_by(SiteCode,Year,Endpoint,Endpoint_group,Endpoint_subgroup,Endpoint_type) %&gt;% \n  summarise(Value = median(Value,na.rm = T), .groups=\"drop\") \n\nwrite_csv(final_fish_out,\"data/fish_endpoints.csv\")\n\n\n\n\nsource(\"00_source.R\")\nlibrary(glmmTMB)\nlibrary(DHARMa)\nlibrary(broom.mixed)\nlibrary(parameters)\n\ndat_in &lt;- readRDS(\"data/1_formatted_data.RDS\")$long \npredictor_summaries&lt;-read_csv(\"data/predictor_summaries.csv\")\n\nif (F) {\n  ggplot(dat_in,aes(x=value)) +\n    geom_histogram() +\n    facet_wrap(~Endpoint,scales=\"free\")\n  \n  ggplot(dat_in,aes(x=value)) +\n    geom_histogram() +\n    scale_x_continuous(trans=\"log1p\")+\n    facet_wrap(~Endpoint,scales=\"free\")\n}\n\n# Setup Model param -------------------------------------------------------\n\ndat_in &lt;- dat_in %&gt;% \n  filter(`Stress Class` != \"North\") %&gt;% # Exclude sites without land cover data\n  #filter(Endpoint != c(\"Habitat Stability Score\")) %&gt;%  # Has a problematic distribution\n  filter(Endpoint != c(\"Sediment Transport Potential\")) %&gt;%  # Has a problematic distribution\n  group_by(TRCA) %&gt;% \n  mutate(\n    Year_n2 = Year,\n  ) %&gt;% \n  mutate(\n    Year_n = (max(Year)-min(Year))-(max(Year)-Year)+1,\n  ) %&gt;% \n  ungroup() %&gt;% \n  mutate(\n    `Strahler Order` = as.factor(`Strahler Order`)\n  )\n\nep_tbl &lt;- enframe(met_cols) %&gt;% \n  unnest(value) %&gt;% \n  mutate(Endpoint = names(value)) %&gt;% \n  unnest(value)\n\nmod_data_fin &lt;- dat_in %&gt;% \n  as_tibble() %&gt;% \n  group_by(across(any_of(c(\"TRCA\",\"Family\",\"Endpoint\")))) %&gt;% \n  nest() %&gt;% \n  ungroup() %&gt;% \n  left_join(enframe(met_cols) %&gt;% \n              unnest(value) %&gt;% \n              mutate(Endpoint = names(value)) %&gt;% \n              unnest(value) %&gt;% \n              select(-value,Endpoint_group=name,Endpoint),\n            by = \"Endpoint\" ) %&gt;% \n  mutate(Endpoint = factor(Endpoint,levels = ep_tbl$Endpoint),\n         Endpoint_group = factor(Endpoint_group,levels = unique(ep_tbl$name))) %&gt;% \n  mutate(model_params = case_when(\n    Endpoint %in% c(\"D15\",\n                    \"D50\",\n                    \"D85\",\n                    \"D50Max\"\n    ) ~ list(\n      list(\n        family = lognormal(link = \"log\"),\n        ziformula = ~ 1,\n        dispformula = ~ 1\n      )\n    ),\n    Endpoint %in% c(\"Sediment Sorting Index\"\n    ) ~ list(\n      list(\n        family = ziGamma(link = \"log\"),\n        ziformula = ~ 1,\n        dispformula = ~ 1\n      )\n    ),\n    Endpoint %in% c(\"Width - Mean\",\n                    \"Depth - Mean\") ~ list(\n                      list(\n                        family = lognormal(link = \"log\"),\n                        ziformula = ~ 0,\n                        dispformula = ~ 1\n                      )\n                    ),\n    Endpoint %in% c(\"Sediment Transport Potential\") ~ list(\n      list(\n        family = Gamma(link = \"sqrt\"),\n        ziformula = ~ 0,\n        dispformula = ~ 1\n      )\n    ),\n    Endpoint %in% c(\"Usable Area\",\"Width:Depth Ratio\") ~ list(\n      list(\n        family = Gamma(link = \"log\"),\n        ziformula = ~ 0,\n        dispformula = ~ 1\n      )\n    ),\n    grepl(\" Cover| Percent\",Endpoint) | Endpoint %in% c(\"Habitat Homogeneity\",\n                                                        \"Habitat Stability Score\")  ~ list(\n                                                          list(\n                                                            family = beta_family(link = \"logit\"),\n                                                            ziformula = ~ 1,\n                                                            dispformula = ~ 1\n                                                          )\n                                                        ),\n    Endpoint %in% c(\"Bank Stability - Mean\")  ~ list(\n      list(\n        family = beta_family(link = \"probit\"),\n        ziformula = ~ 0,\n        dispformula = ~ 1\n      )\n    ),\n    Endpoint %in% c(\"\") ~ list(\n      list(\n        family = gaussian(link = \"identity\"),\n        ziformula = ~ 1,\n        dispformula = ~ 1\n      )\n    )\n  )) %&gt;% \n  mutate(model_params = map2(TRCA,model_params,\n                             ~case_when(.x==T ~ c(.y,\n                                                  list(\n                                                    control = glmmTMBControl(parallel = parallel::detectCores()),\n                                                    formula = as.formula(\"value ~ log1p(`Reach Slope`) + Year_n*`UCA Class`*`Stress Class` + (Year_n|`UCA Class`:`Stress Class`:SiteCode) + (1|Year_n)\")\n                                                  )),\n                                        .x==F ~ c(.y,\n                                                  list(\n                                                    control = glmmTMBControl(parallel = parallel::detectCores()),\n                                                    formula = as.formula(\"value ~ log1p(`Reach Slope`) + Year_n*`UCA Class`*`Stress Class` + (Year_n|`UCA Class`:`Stress Class`:SiteCode) + (1|Year_n)\")\n                                                  ))\n                             )\n                             \n  )) %&gt;% \n  mutate(model_params = map2(TRCA,model_params,\n                             ~{\n                               if (.y$dispformula[[2]]!=0 & .x==T){\n                                 .y$dispformula &lt;- as.formula(\" ~ 1\")\n                               }\n                               if (.y$dispformula[[2]]!=0 & .x==F){\n                                 .y$dispformula &lt;- as.formula(\" ~ 1\")\n                               }\n                               if (.y$ziformula[[2]]!=0 & .x==T){\n                                 .y$ziformula &lt;- as.formula(\" ~ log1p(`Reach Slope`) + Year_n + `UCA Class` + `Stress Class` + (Year_n|`UCA Class`:`Stress Class`:SiteCode) + (1|Year_n)\")\n                               }\n                               if (.y$ziformula[[2]]!=0 & .x==F){\n                                 .y$ziformula &lt;- as.formula(\" ~ log1p(`Reach Slope`) + Year_n + `UCA Class` + `Stress Class` + (Year_n|`UCA Class`:`Stress Class`:SiteCode) + (1|Year_n)\")\n                               }\n                               return(.y)\n                             }\n  )) %&gt;% \n  mutate(model_params = map2(model_params,data, \n                             ~c(.x,\n                                list(\n                                  data= .y %&gt;% \n                                    filter(!is.na(value)) %&gt;% \n                                    select(\n                                      any_of(\n                                        c(\"WSHED\",\"Subshed\",\"SiteCode\",\"Area_class\",\n                                          \"Sample_Season\",\"Year_n\",\"Year_n2\",\"value\",\n                                          \"year_class\",\"Year\",\n                                          \"Upstream Catchment Area\",\"Baseflow Index\",\"Reach Slope\",\"Strahler Order\",\n                                          \"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\",\n                                          \"Upstream catchment stress index\",\"Stress Class\",\"Habitat Stability Class\",\"UCA Class\")\n                                      )\n                                    ) \n                                )\n                             ))) %&gt;% \n  mutate(Endpoint = factor(Endpoint, levels = unlist(sapply(met_cols,names),use.names=F)))\n\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(p0 = map_dbl(data,~sum(.x$value==0,na.rm=T)/length(.x$value==0)))\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  filter(p0 &lt; 0.75)\n\n# Run Models --------------------------------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(\n    model = map(model_params, ~do.call(glmmTMB::glmmTMB,.x))\n  ) \n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(\n    pred_error = map_lgl(model,\n                         ~any(\n                           is.na(\n                             predict(.x,\n                                     type=\"link\",\n                                     re.form = NULL,\n                                     se.fit = TRUE,\n                                     cov.fit = F,\n                                     do.bias.correct = F,\n                                     allow.new.levels = T)$se.fit\n                           ) |\n                             any(is.na(as.data.frame(glmmTMB::ranef(.x, condVar = T))$condsd))\n                         ) \n    )\n  )\n\nprint(mod_data_fin,n=Inf)\n\n# Exclude outliers --------------------------------------------------------\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(\n    model_params = case_when(\n      pred_error == T ~ map2(model_params,model, \n                             ~{\n                               .x$data &lt;- .x$data[!DHARMa::outliers(DHARMa::simulateResiduals(.y, use.u = T,refit = F,plot = F,n=9999),return = \"logical\",lowerQuantile = 0.025, upperQuantile = 0.975),]\n                               return(.x)\n                             }\n      ),\n      T ~ model_params\n    )\n  ) \n\n# Refit Models --------------------------------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;%\n  mutate(\n    model = case_when(\n      pred_error == T ~ map(model_params, ~do.call(glmmTMB::glmmTMB,.x)), #refit models with default links\n      T ~ model\n    )\n  )\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(\n    pred_error = map_lgl(model,\n                         ~any(\n                           is.na(\n                             predict(.x,\n                                     type=\"link\",\n                                     re.form = NULL,\n                                     se.fit = TRUE,\n                                     cov.fit = F,\n                                     do.bias.correct = F,\n                                     allow.new.levels = T)$se.fit\n                           ) |\n                             any(is.na(as.data.frame(glmmTMB::ranef(.x, condVar = T))$condsd))\n                         ) \n    )\n  )\n\n\n\nprint(mod_data_fin,n=Inf)\n\n# adjust link functions for bad fits\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(model = pmap(\n    list(.x=model,\n         .y=pred_error,\n         .z=model_params),\n    function(.x,.y,.z){\n      if (!.y) return(.x)\n      #if (.x$call$family$family != \"beta\") return(.x)\n      if (.x$call$family$family == \"beta\") {\n        .z$family &lt;- beta_family(link = \"probit\")\n        .x &lt;- do.call(glmmTMB::glmmTMB,.z)\n      }\n      if (.x$call$family$family == \"Gamma\") {\n        .z$family &lt;- ziGamma(link = \"sqrt\")\n        .x &lt;- do.call(glmmTMB::glmmTMB,.z)\n      }\n      if (.x$call$family$family == \"lognormal\") {\n        .z$family &lt;- lognormal(link = \"sqrt\")\n        .x &lt;- do.call(glmmTMB::glmmTMB,.z)\n      }\n      return(.x)\n    })\n  )\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(\n    pred_error = map2_lgl(model,\n                          pred_error,\n                          ~{\n                            if (!.y) return(.y)\n                            any(\n                              is.na(\n                                predict(.x,\n                                        type=\"link\",\n                                        re.form = NULL,\n                                        se.fit = TRUE,\n                                        cov.fit = F,\n                                        do.bias.correct = F,\n                                        allow.new.levels = T)$se.fit\n                              )\n                            ) |\n                              any(is.na(as.data.frame(glmmTMB::ranef(.x, condVar = T))$condsd))\n                          })\n  )\n\nprint(mod_data_fin,n=Inf)\n\n\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  filter(!pred_error)\n\n# Predict observations ----------------------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(Pred1 = map2(model,model_params, function (i,nm) {\n    \n    year_vals &lt;- nm$data %&gt;% \n      select(Year_n,Year_n2,year_class) %&gt;% \n      distinct()  \n    \n    pred_frame &lt;- nm$data %&gt;% \n      select(any_of(c(\"WSHED\",\"Subshed\",\"Area_class\",\"SiteCode\",\n                      \"Upstream Catchment Area\",\"Baseflow Index\",\"Reach Slope\",\"Strahler Order\",\n                      \"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\",\n                      \"Upstream catchment stress index\",\"Stress Class\",\"Habitat Stability Class\",\"UCA Class\"))) %&gt;% \n      distinct() %&gt;% \n      mutate(Sample_Season=\"Summer\",#list(factor(levels(nm$data$Sample_Season),levels = levels(nm$data$Sample_Season))),\n             Year_n = list(seq(from=min(year_vals$Year_n),to=max(year_vals$Year_n)))\n      ) %&gt;%\n      unnest(Year_n) %&gt;%\n      unnest(Sample_Season) %&gt;% \n      left_join(\n        year_vals\n      )\n    \n    pred_frame&lt;-pred_frame[complete.cases(pred_frame),]\n    \n    a1 &lt;- pred_frame %&gt;% \n      bind_cols(\n        data.frame(\n          pred=predict(i,\n                       newdata = pred_frame,\n                       type=\"link\",\n                       re.form = NULL,\n                       se.fit = TRUE,\n                       cov.fit = F,\n                       do.bias.correct = F,\n                       allow.new.levels = T)\n        )\n      ) %&gt;%\n      mutate(pred.fit = predict(i,newdata = pred_frame,type=\"response\")) %&gt;% \n      mutate(pred.fit = i$modelInfo$family$linkfun(pred.fit)) %&gt;% \n      mutate(\n        pred_low = pred.fit - (qnorm(1 - 0.1 / 2) * pred.se.fit),\n        pred_high = pred.fit + (qnorm(1 - 0.1 / 2) * pred.se.fit),\n        pred_low_trend = pred.fit - (qnorm(1 - 0.5 / 2) * pred.se.fit),\n        pred_high_trend = pred.fit + (qnorm(1 - 0.5 / 2) * pred.se.fit),\n      ) %&gt;% \n      left_join(\n        nm$data %&gt;% select(any_of(c(\"WSHED\",\"Subshed\",\"SiteCode\",\"Area_class\",\n                                    \"Sample_Season\",\"Year_n\",\"Year_n2\",\n                                    \"value\",\"year_class\",\n                                    \"Upstream Catchment Area\",\"Baseflow Index\",\"Reach Slope\",\"Strahler Order\",\n                                    \"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\",\n                                    \"Upstream catchment stress index\",\"Stress Class\",\"Habitat Stability Class\",\"UCA Class\")))\n      ) %&gt;% \n      mutate(\n        across(\n          c(pred.fit,pred_low,pred_high,pred_low_trend,pred_high_trend),\n          ~i$modelInfo$family$linkinv(.x)\n        )\n      ) \n    \n    return(a1)\n  }))\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(Pred1_error = map_lgl(Pred1,~any(is.na(.x$pred.se.fit))))\n\nprint(mod_data_fin,n=Inf)\n\n# Extract random effects terms --------------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(rand_ef = map(model,~get_terms2(.x))) \n\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(rand_ef_error = map_lgl(rand_ef,~any(is.na(.x$sd))))\n\nprint(mod_data_fin,n=Inf)\n\n# Get simulated residuals -------------------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;%\n  mutate(\n    sim_resid_refitF = map(model, ~ DHARMa::simulateResiduals(.x, use.u = T,refit = F,plot = F,n=9999)),\n  )\n\n# Format final data tables ------------------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;%\n  mutate(\n    Pred2 = map(Pred1,\n                ~ .x %&gt;% \n                  group_by(WSHED, Subshed, Sample_Season, SiteCode, year_class,\n                           `Upstream Catchment Area`,`Baseflow Index`,`Reach Slope`,`Strahler Order`,\n                           `Upstream catchment developed (%)`,`Upstream catchment agricultural (%)`,\n                           `Upstream catchment stress index`,`Stress Class`,`UCA Class`) %&gt;% #,`Habitat Stability Class`\n                  summarise(\n                    across(\n                      c(pred.fit, pred.se.fit, pred_low, pred_high, pred_low_trend, pred_high_trend, value),\n                      ~median(.x, na.rm=T)\n                    ),\n                    .groups = \"drop\"\n                  ) %&gt;% \n                  mutate(`UCA Class`=as.character(`UCA Class`))\n    ),\n    Pred2 = map2(Pred2,rand_ef,\n                 function(x,y){\n                   x %&gt;% \n                     left_join(\n                       y %&gt;% \n                         filter(term == \"Year_n\") %&gt;% \n                         filter(group_var== \"`UCA Class`:`Stress Class`:SiteCode\") %&gt;% #:`Habitat Stability Class`\n                         filter(component == \"cond\") %&gt;% \n                         select(-group_var,-term,-sd,-`1`) %&gt;% \n                         rename(lower_slope_sig = pred_low,\n                                upper_slope_sig = pred_high,\n                                lower_slope_trend = pred_low_trend,\n                                upper_slope_trend = pred_high_trend,\n                                mean_slope = value,\n                         )\n                     )\n                 }),\n    Pred2 = map(Pred2,\n                ~.x %&gt;% \n                  mutate(\n                    linear_trend = case_when(\n                      lower_slope_sig &gt; 0 ~ \"Increasing Significant\",\n                      upper_slope_sig &lt; 0 ~ \"Decreasing Significant\",\n                      lower_slope_trend &gt; 0 ~ \"Increasing Trend\",\n                      upper_slope_trend &lt; 0 ~ \"Decreasing Trend\",\n                      T ~ \"No Change\"\n                    )\n                  ) %&gt;% \n                  mutate(\n                    linear_trend = factor(linear_trend,\n                                          levels = c(\n                                            \"Increasing Significant\",\n                                            \"Increasing Trend\",\n                                            \"No Change\",\n                                            \"Decreasing Trend\",\n                                            \"Decreasing Significant\"\n                                          ))\n                  )\n                \n    )\n  )\n\n\n# UCA, Stability and stress class trends ------------------------------------\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  mutate(\n    spatial_summ = map(data,~summary_fun(.x))\n  ) %&gt;% \n  mutate(summary_terms_temporal = map(rand_ef,\n                                      ~{\n                                        .x %&gt;% \n                                          filter(term == \"Year_n\") %&gt;% \n                                          filter(group_var!= \"`UCA Class`:`Stress Class`:SiteCode\") %&gt;% #:`Habitat Stability Class`\n                                          filter(component == \"fixed\") %&gt;% \n                                          rename(lower_slope_sig = pred_low,\n                                                 upper_slope_sig = pred_high,\n                                                 lower_slope_trend = pred_low_trend,\n                                                 upper_slope_trend = pred_high_trend,\n                                                 mean_slope = value,\n                                          ) %&gt;% \n                                          mutate(\n                                            linear_trend = case_when(\n                                              lower_slope_sig &gt; 0 ~ \"Increasing Significant\",\n                                              upper_slope_sig &lt; 0 ~ \"Decreasing Significant\",\n                                              lower_slope_trend &gt; 0 ~ \"Increasing Trend\",\n                                              upper_slope_trend &lt; 0 ~ \"Decreasing Trend\",\n                                              T ~ \"No Change\"\n                                            )\n                                          ) %&gt;% \n                                          mutate(\n                                            linear_trend = factor(linear_trend,\n                                                                  levels = c(\n                                                                    \"Increasing Significant\",\n                                                                    \"Increasing Trend\",\n                                                                    \"No Change\",\n                                                                    \"Decreasing Trend\",\n                                                                    \"Decreasing Significant\"\n                                                                  ))\n                                          ) \n                                      })) %&gt;% \n  mutate(summary_terms_spatial = map(rand_ef,\n                                     ~{.x %&gt;% \n                                         filter(term == \"(Intercept)\") %&gt;% #labelled intercept but is predicted at max year\n                                         filter(group_var != \"`UCA Class`:`Stress Class`:SiteCode\") %&gt;% #:`Habitat Stability Class`\n                                         filter(component == \"fixed\") \n                                     }))\n\n\nsaveRDS(mod_data_fin,\"data/results_out.rds\")\n\n# Model Fit tables --------------------------------------------------------------\n\nmod_tbl_list &lt;- list()\n\nmod_tbl_list$TRCA_mod_tbl &lt;- modelsummary::modelsummary(\n  setNames(\n    mod_data_fin$model[mod_data_fin$TRCA],\n    mod_data_fin$Endpoint[mod_data_fin$TRCA]\n  ),\n  vcov = sandwich::vcovHC,\n  shape = effect:component + term + group ~ model + statistic,\n  stars = TRUE,\n  gof_omit = c(\"BIC|AIC|Std|Cond|Marg|ICC\"),\n  gof_function = function(model) tibble(`Pseudo R2`=scales::label_number(0.001)(cor(predict(model),model$frame$value,method=\"spearman\")^2)) ,\n  output = \"gt\",\n  coef_rename = F,\n  notes = \"zi = zero-inflation; cond = conditional; fixed = fixed effects parameter; ran_pars = random effects parameters;\",\n  title = \"TRCA Data Only\"\n) \n\nsig_list &lt;- which(apply(mod_tbl_list$TRCA_mod_tbl$`_data`,1,function(x)grepl(\"\\\\*|\\\\+\",x)),arr.ind = T)\nsig_list &lt;- split(sig_list,1:nrow(sig_list))\n\nfor (i in sig_list){\n  mod_tbl_list$TRCA_mod_tbl &lt;- mod_tbl_list$TRCA_mod_tbl %&gt;% \n    gt::tab_style(\n      style = gt::cell_fill(color = \"lightblue\"),\n      locations = gt::cells_body(\n        columns = i[[1]],\n        rows = i[[2]]\n      )\n    )\n}\n\nif (T){\n  mod_tbl_list$ALL_mod_tbl &lt;- modelsummary::modelsummary(\n    setNames(\n      mod_data_fin$model[!mod_data_fin$TRCA],\n      mod_data_fin$Endpoint[!mod_data_fin$TRCA]\n    ),\n    vcov = sandwich::vcovHC,\n    shape = effect:component + term + group ~ model + statistic,\n    stars = TRUE,\n    gof_omit = c(\"BIC|AIC|Std|Cond|Marg|ICC\"),\n    gof_function = function(model) tibble(`Pseudo R2`=scales::label_number(0.001)(cor(predict(model),model$frame$value,method=\"spearman\")^2)),\n    output = \"gt\",\n    coef_rename = F,\n    notes = \"zi = zero-inflation; cond = conditional; fixed = fixed effects parameter; ran_pars = random effects parameters;\",\n    title = \"All Data\"\n  ) \n  \n  sig_list &lt;- which(apply(mod_tbl_list$ALL_mod_tbl$`_data`,1,function(x)grepl(\"\\\\*|\\\\+\",x)),arr.ind = T)\n  sig_list &lt;- split(sig_list,1:nrow(sig_list))\n  \n  for (i in sig_list){\n    mod_tbl_list$ALL_mod_tbl &lt;- mod_tbl_list$ALL_mod_tbl %&gt;% \n      gt::tab_style(\n        style = gt::cell_fill(color = \"lightblue\"),\n        locations = gt::cells_body(\n          columns = i[[1]],\n          rows = i[[2]]\n        )\n      )\n  }\n}\n\n\nsaveRDS(mod_tbl_list,\"data/mod_tbl_list.rds\")\n\n# Correlation Figures -----------------------------------------------------\n\ncor_list &lt;- list(\n  TRCA_spat = mod_data_fin %&gt;% \n    filter(TRCA) %&gt;% \n    select(Endpoint, data) %&gt;% \n    unnest(data) %&gt;% \n    pivot_wider(names_from = Endpoint,values_from = value) %&gt;% \n    select(any_of(unlist(sapply(met_cols,names),use.names=F)),\n           any_of(c(\"Upstream Catchment Area\",\"Reach Slope\",\"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\",\"Upstream catchment stress index\"))\n    ) \n  ,\n  All_spat = mod_data_fin %&gt;% \n    filter(!TRCA) %&gt;% \n    select(Endpoint, data) %&gt;% \n    unnest(data) %&gt;% \n    pivot_wider(names_from = Endpoint,values_from = value) %&gt;% \n    select(any_of(unlist(sapply(met_cols,names),use.names=F)),\n           any_of(c(\"Upstream Catchment Area\",\"Reach Slope\",\"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\",\"Upstream catchment stress index\"))\n    )\n)\n\ncor_list &lt;- map(cor_list,function(x){\n  heatmap_fn(x,\n             alpha=0.1,\n             sig_est=0.6,\n             method=\"spearman\",\n             scale_grad=ggplot2::scale_fill_gradient2(low = scales::muted(rgb(red=0/255,green=102/255,blue=255/255)),\n                                                      mid = \"white\",\n                                                      high = scales::muted(rgb(red=0/255,green=176/255,blue=80/255)),\n                                                      limits=c(-1,1))) \n})\n\n\n\ntrend_cor &lt;- mod_data_fin %&gt;% \n  filter(TRCA) %&gt;% \n  select(Endpoint, Pred2) %&gt;% \n  mutate(Pred_current = map(Pred2,\n                            ~.x %&gt;% \n                              filter(year_class==max(levels(year_class)),\n                                     Sample_Season==\"Summer\"))) %&gt;% \n  select(-Pred2) %&gt;% \n  unnest(Pred_current) %&gt;% \n  select(SiteCode,Endpoint,linear_trend ) %&gt;% \n  mutate(linear_trend = case_when(\n    linear_trend == \"Increasing Significant\" ~ 2,\n    linear_trend == \"Increasing Trend\" ~ 1,\n    linear_trend == \"No Change\" ~ 0,\n    linear_trend == \"Decreasing Trend\" ~ -1,\n    linear_trend == \"Decreasing Significant\" ~ -2,\n  )) %&gt;% \n  pivot_wider(values_from = linear_trend ,names_from = Endpoint) %&gt;% \n  select(-SiteCode)\n\nt1 &lt;- cor(trend_cor,method = \"spearman\",use=\"pairwise.complete.obs\")\nkeep &lt;- (!apply(t1,2,function(x) all(is.na(x))))\ntrend_cor &lt;- trend_cor[,keep]\n\ntrend_cor&lt;-heatmap_fn(\n  trend_cor,\n  alpha=0.1,\n  sig_est=0.6,\n  method=\"spearman\",\n  use=\"pairwise.complete.obs\",\n  scale_grad=ggplot2::scale_fill_gradient2(low = scales::muted(rgb(red=0/255,green=102/255,blue=255/255)),\n                                           mid = \"white\",\n                                           high = scales::muted(rgb(red=0/255,green=176/255,blue=80/255)),\n                                           limits=c(-1,1))) \n\ncor_list$TRCA_temp &lt;- trend_cor\n\ntrend_cor &lt;- mod_data_fin %&gt;% \n  filter(!TRCA) %&gt;% \n  select(Endpoint, Pred2) %&gt;% \n  mutate(Pred_current = map(Pred2,\n                            ~.x %&gt;% \n                              filter(year_class==max(levels(year_class)),\n                                     Sample_Season==\"Summer\"))) %&gt;% \n  select(-Pred2) %&gt;% \n  unnest(Pred_current) %&gt;% \n  select(SiteCode,Endpoint,linear_trend ) %&gt;% \n  mutate(linear_trend = case_when(\n    linear_trend == \"Increasing Significant\" ~ 2,\n    linear_trend == \"Increasing Trend\" ~ 1,\n    linear_trend == \"No Change\" ~ 0,\n    linear_trend == \"Decreasing Trend\" ~ -1,\n    linear_trend == \"Decreasing Significant\" ~ -2,\n  )) %&gt;% \n  pivot_wider(values_from = linear_trend ,names_from = Endpoint) %&gt;% \n  select(-SiteCode)\n\nt1 &lt;- cor(trend_cor,method = \"spearman\",use=\"pairwise.complete.obs\")\nkeep &lt;- (!apply(t1,2,function(x) all(is.na(x))))\ntrend_cor &lt;- trend_cor[,keep]\n\ntrend_cor&lt;-heatmap_fn(\n  trend_cor,\n  alpha=0.1,\n  sig_est=0.6,\n  method=\"spearman\",\n  use=\"pairwise.complete.obs\",\n  scale_grad=ggplot2::scale_fill_gradient2(low = scales::muted(rgb(red=0/255,green=102/255,blue=255/255)),\n                                           mid = \"white\",\n                                           high = scales::muted(rgb(red=0/255,green=176/255,blue=80/255)),\n                                           limits=c(-1,1))) \n\ncor_list$All_temp &lt;- trend_cor\n\nsaveRDS(cor_list,\"data/cor_plots.rds\")\n\n\n\n\nsource(\"00_source.R\")\nlibrary(mapview)\nlibrary(basemaps)\nlibrary(ggspatial)\n\ncols_list &lt;- tail(scales::col_darker(RColorBrewer::brewer.pal(4,\"Set1\"),5),3)\nnames(cols_list)&lt;-c(\"Small\",\"Intermediate\",\"Large\")\n\nmod_data_fin &lt;- readRDS(\"data/results_out.rds\")\ncoords &lt;- readRDS(\"data/1_formatted_data.RDS\")$wide %&gt;% \n  select(TRCA,WSHED,SiteCode,`Stress Class`,`UCA Class`) %&gt;% #,`Habitat Stability Class`\n  group_by(TRCA,WSHED,SiteCode,`Stress Class`,`UCA Class`) %&gt;% #,`Habitat Stability Class`\n  summarise(geometry = unique(st_centroid(geometry)),.groups=\"drop\")\n\nsaveRDS(coords,\"data/coords.rds\")\n\ncoords&lt;-coords %&gt;%\n  select(-TRCA,-WSHED,-`Stress Class`,-`UCA Class`) %&gt;% #,-`Habitat Stability Class`\n  distinct()\n\nsf::sf_use_s2(F)\n\nTRCA_subwats &lt;- sf::read_sf(\"data/Subwatersheds_TRCA.geojson\") \nTRCA_wats &lt;- TRCA_subwats %&gt;% \n  group_by(WSHED) %&gt;% \n  summarise(geometry = sf::st_union(geometry))\n\nunzip(\"data/AEC_V3_Core_Rev0_GPKG_Package02_LakeOntario.zip\",exdir=tempdir())\nstrm_lns &lt;- sf::read_sf(\n  file.path(tempdir(),\"AEC_V3_Core_Rev0_GPKG_Package02_LakeOntario/w03_Lake_Ontario_West/w03_AEC_V3_Core_Rev0.gpkg\"),\n  \"w03_Reach_SimpleGeometry_Core\") %&gt;% \n  sf::st_transform(sf::st_crs(TRCA_subwats)) \n\nstrm_lns &lt;- strm_lns[apply(sf::st_intersects(strm_lns,sf::st_buffer(TRCA_wats,-0.0001),sparse=F),1,any),]\n\nstrm_lns &lt;- strm_lns %&gt;% \n  filter(Network_Line_Type != \"Shoreline Virtual Connector\")\n\nmod_data_fin &lt;- mod_data_fin %&gt;% \n  filter(!TRCA)\n\nplot_out &lt;- mod_data_fin %&gt;% \n  mutate(fam = map_chr(model_params,~.x$family$family)) %&gt;% \n  mutate(trans = case_when(\n    fam == \"beta\" ~ list(clogit),\n    fam == \"lognormal\" ~ list(scales::transform_pseudo_log()),\n    fam == \"Gamma\" ~ list(scales::transform_pseudo_log()),\n  )) %&gt;% \n  mutate(brks = case_when(\n    fam == \"beta\" ~ list(scales::pretty_breaks),\n    fam == \"lognormal\" ~ list(pseudo_log_breaks),\n    fam == \"Gamma\" ~ list(pseudo_log_breaks),\n  )) %&gt;% \n  select(TRCA, Endpoint, Endpoint_group, fam, trans, brks, Pred1, Pred2, summary_terms_temporal, summary_terms_spatial) %&gt;% \n  mutate(Pred_current = map(Pred2,\n                            ~left_join(.x,coords,by = join_by(SiteCode)) %&gt;% \n                              filter(year_class==max(levels(year_class)),\n                                     Sample_Season==\"Summer\") %&gt;% \n                              st_as_sf() %&gt;% \n                              filter(is.na(as.numeric(as.character(WSHED)))) %&gt;% \n                              mutate(`UCA Class` = factor(`UCA Class`,levels=c(\"Small\",\"Intermediate\",\"Large\")))\n  ))%&gt;% \n  mutate(Pred_obs = map(Pred1,\n                        ~.x %&gt;% \n                          distinct() %&gt;% \n                          filter(!is.na(value)) %&gt;% \n                          mutate(Year_n = 2000+Year_n) %&gt;% \n                          filter(is.na(as.numeric(as.character(WSHED)))) %&gt;% \n                          mutate(`UCA Class` = factor(`UCA Class`,levels=c(\"Small\",\"Intermediate\",\"Large\")))\n  )) %&gt;% \n  select(-Pred2,-Pred1) \n\n\n# Raw Data Plots ----------------------------------------------------------\n\nplot_out$raw_plots &lt;- pmap(\n  list(.x=plot_out$Pred_obs,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) \n    .x %&gt;% \n    mutate(WSHED2=WSHED) %&gt;% \n    group_by(WSHED2) %&gt;% \n    nest() %&gt;% \n    ungroup() %&gt;% \n    mutate(plt = map2(data,.y,\n                      function(x,y) {\n                        ggplot(\n                          x,\n                          aes(x = Year_n,\n                              colour = SiteCode,\n                              group = SiteCode\n                          )\n                        ) +\n                          geom_linerange(aes(ymin=pred_low,ymax=pred_high),\n                                         colour='grey',\n                                         alpha=0.40,\n                                         linewidth = 5) +\n                          geom_point(aes(y=value),size=3) +\n                          scale_colour_discrete() +\n                          theme_bw() +\n                          ylab(paste0(y)) +\n                          xlab(\"\")+\n                          facet_wrap(~SiteCode) +\n                          labs(\n                            title = paste0(x$WSHED[[1]],\" | \",.y),\n                            subtitle = \"Points represent observed values, grey bars represent 90 percent confidence interval from GLMM model\"\n                          )+\n                          theme(\n                            axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),\n                            legend.position = \"none\"\n                          )\n                      })) %&gt;% \n    pull(plt) %&gt;% \n    map(~.x + scale_y_continuous(breaks = .a(), expand = c(0,0)))%&gt;% \n    map(~.x + coord_transform(y = .z))\n)\n\nsaveRDS(plot_out,\"data/rawdata_plots.rds\")\n\nplot_out &lt;- plot_out %&gt;% \n  select(-raw_plots)\n\n# Model fit plot ----------------------------------------------------------\n\nplot_out$model_fit &lt;- pmap(\n  list(.x=plot_out$Pred_obs,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    ggplot(\n      .x,\n      aes(x = pred.fit,\n          y = value\n      )\n    ) +\n      geom_point(colour='grey25') +\n      geom_abline(slope = 1, intercept = 0, linewidth = 0.25,colour = \"black\")+\n      theme_bw() +\n      ylab(\"Observed\") +\n      xlab(\"Model Fitted\") +\n      scale_x_continuous(limits = range(.a(5)(c(.x$pred.fit,.x$value))),breaks = .a()) +\n      scale_y_continuous(limits = range(.a(5)(c(.x$pred.fit,.x$value))),breaks = .a()) +\n      coord_transform(\n        x = .z,\n        y = .z\n      ) + \n      labs(\n        title = paste0(.y),\n        subtitle = paste0(\"Pseudo R2 = \", scales::label_number(0.001)(cor(.x$pred.fit,.x$value,method=\"spearman\")^2))\n      )\n  }\n)\n\n\n# Model Residuals --------------------------------------------------------------\n\nplot_out$fit1 &lt;- map2(mod_data_fin$sim_resid_refitF,\n                      mod_data_fin$Endpoint,\n                      function(x,y){\n                        ggplotify::as.ggplot(function() plot(x,title = paste(\"Model Fits -\",y)))\n                      }\n)\n\n\n# Temporal Plots ----------------------------------------------------------\n\nplot_out$temporal_plot1 &lt;- pmap(\n  list(.x=plot_out$Pred_current,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    ggplot(\n      .x,\n      aes(x = SiteCode,\n          y = mean_slope,\n          colour = WSHED,\n          alpha = case_when(\n            grepl(\"Sig\",linear_trend) ~ 1,\n            grepl(\"Trend\",linear_trend) ~ 0.92,\n            T ~ 0.8\n          )\n      )\n    ) +\n      geom_pointrange(aes(ymin = lower_slope_sig,\n                          ymax = upper_slope_sig,\n      ),linewidth = 0.25) +\n      geom_pointrange(aes(ymin = lower_slope_trend,\n                          ymax = upper_slope_trend,\n      ),linewidth = 1.5) +\n      geom_point(aes(x = SiteCode,\n                     y = mean_slope),\n                 shape=21,size=2.5,inherit.aes = F)+\n      geom_hline(yintercept = 0) +\n      scale_colour_discrete() +\n      facet_wrap(~WSHED, scales = \"free_x\") +\n      theme_bw() +\n      ylab(.y) +\n      theme(\n        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),\n        legend.position = \"none\"\n      ) +\n      labs(title = paste0(.y),\n           subtitle  = \"Mean +/- 50 and 90 percent confidence intervals of the slope coefficients from GLMM models\",\n           caption = \"Areas with confidence intervals that don't overlap 0 are considered to increase or decrease significantly.\"\n      ) \n  }\n)\n\nplot_out$temporal_plot1_1 &lt;- pmap(\n  list(.x=plot_out$Pred_current,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    ggplot(\n      .x,\n      aes(x = SiteCode,\n          y = mean_slope,\n          alpha = case_when(\n            grepl(\"Sig\",linear_trend) ~ 1,\n            grepl(\"Trend\",linear_trend) ~ 0.92,\n            T ~ 0.8\n          )\n      )\n    ) +\n      geom_linerange(aes(ymin = lower_slope_sig,\n                         ymax = upper_slope_sig,\n                         colour = `UCA Class`\n      ),linewidth = 0.25) +\n      geom_linerange(aes(ymin = lower_slope_trend,\n                         ymax = upper_slope_trend,\n                         colour = `UCA Class`\n      ),linewidth = 1.5) +\n      geom_point(aes(x = SiteCode,\n                     y = mean_slope,\n                     shape = `Stress Class`,\n                     fill = `UCA Class`,\n                     alpha = case_when(\n                       grepl(\"Sig\",linear_trend) ~ 1,\n                       grepl(\"Trend\",linear_trend) ~ 0.92,\n                       T ~ 0.8\n                     )),\n                 colour = \"black\",\n                 size=2.5,inherit.aes = F)+\n      geom_hline(yintercept = 0) +\n      scale_shape_manual(values=c(21,22,23)) +\n      scale_colour_manual(values = cols_list) +\n      scale_fill_manual(values = cols_list) +\n      facet_wrap(~WSHED, scales = \"free_x\") +\n      theme_bw() +\n      ylab(.y) +\n      theme(\n        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),\n        legend.position = \"top\"\n      ) +\n      labs(title = paste0(.y),\n           subtitle  = \"Mean +/- 50 and 90 percent confidence intervals of the slope coefficients from GLMM models\",\n           caption = \"Areas with confidence intervals that don't overlap 0 are considered to increase or decrease significantly.\"\n      ) +\n      guides(alpha=\"none\")\n  }\n)\n\n\n# Temporal plots by station -----------------------------------------------\n\nplot_out_stntemp &lt;- plot_out %&gt;% \n  select(TRCA,Endpoint,Endpoint_group,fam,trans,brks,Pred_current) %&gt;% \n  unnest(Pred_current) %&gt;% \n  group_by(TRCA) %&gt;% \n  nest() %&gt;% \n  mutate(\n    temporal_plot1_st = map(data,\n                            ~{\n                              ggplot(\n                                .x \n                                ,\n                                aes(x = Endpoint,\n                                    y = mean_slope#,\n                                    # alpha = case_when(\n                                    #   grepl(\"Sig\",linear_trend) ~ 1,\n                                    #   grepl(\"Trend\",linear_trend) ~ 0.92,\n                                    #   T ~ 0.8\n                                    # )\n                                )\n                              ) +\n                                geom_linerange(aes(ymin = lower_slope_sig,\n                                                   ymax = upper_slope_sig,\n                                                   colour = Endpoint_group\n                                ),linewidth = 0.25) +\n                                geom_linerange(aes(ymin = lower_slope_trend,\n                                                   ymax = upper_slope_trend,\n                                                   colour = Endpoint_group\n                                ),linewidth = 1.5) +\n                                geom_point(aes(x = Endpoint,\n                                               y = mean_slope,\n                                               fill = Endpoint_group#,\n                                               # alpha = case_when(\n                                               #   grepl(\"Sig\",linear_trend) ~ 1,\n                                               #   grepl(\"Trend\",linear_trend) ~ 0.92,\n                                               #   T ~ 0.8\n                                               # )\n                                ),\n                                colour = \"black\",\n                                shape=21,\n                                size=2.5,inherit.aes = F)+\n                                geom_hline(yintercept = 0) +\n                                facet_wrap(~WSHED+SiteCode, scales = \"free\",ncol=4) +\n                                theme_bw() +\n                                ylab(\"\") +\n                                xlab(\"\")+\n                                theme(\n                                  axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),\n                                  legend.position = \"none\"\n                                ) +\n                                labs(#title = paste0(.y),\n                                  subtitle  = \"Mean +/- 50 and 90 percent confidence intervals of the slope coefficients from GLMM models\",\n                                  caption = \"Areas with confidence intervals that don't overlap 0 are considered to increase or decrease significantly.\"\n                                ) +\n                                guides(alpha=\"none\")\n                              \n                            })\n  )\n\nsaveRDS(plot_out_stntemp,\"data/plot_out_stntemp.rds\")\n\n# Temporal Plots - High Level ---------------------------------------------\n\nplot_out$temporal_plot2 &lt;- pmap(\n  list(.x=plot_out$summary_terms_temporal,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    .x %&gt;% \n      mutate(\n        gp = case_when(\n          group_var == \"`1`\" ~ \"Overall\",\n          #group_var == \"`Habitat Stability Class`\" ~ `Habitat Stability Class`,\n          group_var == \"`Stress Class`\" ~ `Stress Class`,\n          group_var == \"`UCA Class`\" ~ `UCA Class`,\n        ),\n        gp = factor(gp,levels=c(\"Overall\",\"Small\",\"Intermediate\",\"Large\",\"High\",\"Medium\",\"Low\"))\n      ) %&gt;% \n      filter(group_var == \"`UCA Class`:`Stress Class`\") %&gt;% #:`Habitat Stability Class`\n      mutate(`Stress Class` = paste0(\"Stress - \",`Stress Class`)) %&gt;%\n      #mutate(`Habitat Stability Class` = paste0(\"Habitat Stability - \",`Habitat Stability Class`)) %&gt;%\n      mutate(`Stress Class` = factor(`Stress Class`,levels = paste0(\"Stress - \",c(\"High\",\"Medium\",\"Low\")))) %&gt;% \n      #mutate(`Habitat Stability Class` = factor(`Habitat Stability Class`,levels = paste0(\"Habitat Stability - \",c(\"High\",\"Low\")))) %&gt;% \n      mutate(gp=case_when(\n        #is.na(`Stress Class`) ~ `Habitat Stability Class`,\n        T ~ `Stress Class`)) %&gt;% \n      ggplot(\n        aes(x = `UCA Class`,\n            y = mean_slope,\n            colour = `Stress Class`, # = `Habitat Stability Class`,\n            group = `Stress Class`,# = `Habitat Stability Class`,\n            # alpha = case_when(\n            #   grepl(\"Sig\",linear_trend) ~ 1,\n            #   grepl(\"Trend\",linear_trend) ~ 0.92,\n            #   T ~ 0.8\n            # )\n        )\n      ) +\n      geom_pointrange(aes(ymin = lower_slope_sig,\n                          ymax = upper_slope_sig,\n      ),linewidth = 0.25,position=position_dodge(width=0.5)) +\n      geom_pointrange(aes(ymin = lower_slope_trend,\n                          ymax = upper_slope_trend,\n      ),linewidth = 1.5,position=position_dodge(width=0.5)) +\n      geom_point(aes(x = `UCA Class`,\n                     y = mean_slope,\n                     group = `Stress Class`), #`Habitat Stability Class`\n                 shape=21,size=2.5,inherit.aes = F,position=position_dodge(width=0.5))+\n      geom_hline(yintercept = 0) +\n      scale_colour_discrete() +\n      facet_grid(~`Stress Class`) +\n      theme_bw() +\n      ylab(.y) +\n      theme(\n        legend.position = \"bottom\"\n      ) +\n      labs(title = paste0(.y, \" by Stress Class\"), #and Habitat Stability \n           subtitle  = \"Mean +/- 50 and 90 percent confidence intervals of the slope coefficients from GLMM models\",\n           caption = \"Coefficients with confidence intervals that don't overlap 0 are considered to increase or decrease significantly.\"\n      ) +\n      guides(alpha=\"none\")\n    \n  }\n)\n\n# Version 2\n\ntemp_summary_plot1 &lt;- plot_out %&gt;%\n  select(TRCA,\n         summary_terms_temporal,\n         Endpoint,\n         trans,\n         brks) %&gt;% \n  unnest(summary_terms_temporal) %&gt;% \n  filter(group_var %in% c(\"`UCA Class`:`Stress Class`\")) %&gt;% #\"`Habitat Stability Class`\",\n  group_by(TRCA,Endpoint) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map2(data,Endpoint,\n                     ~{\n                       .x  %&gt;% \n                         ggplot(\n                           aes(x = `UCA Class`,\n                               y = mean_slope,\n                               colour = `Stress Class`#,\n                               # alpha = case_when(\n                               #   grepl(\"Sig\",linear_trend) ~ 1,\n                               #   grepl(\"Trend\",linear_trend) ~ 0.92,\n                               #   T ~ 0.8\n                               # )\n                           )\n                         ) +\n                         geom_pointrange(aes(ymin = lower_slope_sig,\n                                             ymax = upper_slope_sig,\n                         ),linewidth = 0.25,\n                         position=position_dodge(width=0.25)) +\n                         geom_pointrange(aes(ymin = lower_slope_trend,\n                                             ymax = upper_slope_trend,\n                         ),linewidth = 1.5,\n                         position=position_dodge(width=0.25)) +\n                         geom_point(aes(x = `UCA Class`,\n                                        y = mean_slope,\n                                        group = `Stress Class`),\n                                    shape=21,size=2.5,inherit.aes = F,\n                                    position=position_dodge(width=0.25)) +\n                         geom_hline(yintercept = 0) +\n                         scale_colour_discrete() +\n                         theme_bw() +\n                         ylab(\"\")+\n                         xlab(\"\")+\n                         theme(\n                           legend.position = \"bottom\"\n                         ) +\n                         labs(title = .y)+\n                         guides(alpha=\"none\")\n                     }))\n\ntemp_summary_plot1 &lt;- temp_summary_plot1 %&gt;% \n  ungroup() %&gt;% \n  group_by(TRCA) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map(data,~cowplot::plot_grid(plotlist=.x$plot,ncol=1,align =\"hv\",axis =\"tblr\"))) %&gt;% \n  mutate(plot = map(plot,~cowplot::plot_grid( \n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Overall Trends\",\n      fontface = 'bold',\n      size = 14,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Mean +/- 50 and 90 percent confidence intervals of the slope coefficients from GLMM models\",\n      fontface = 'plain',\n      size = 12,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Coefficients with confidence intervals that don't overlap 0 are considered to increase or decrease significantly\",\n      fontface = 'plain',\n      size = 10,\n      x = 0,\n      hjust = 0\n    ),\n    .x,\n    ncol=1,\n    rel_heights = c(0.01,0.01,0.01,1))))\n\nsaveRDS(temp_summary_plot1,\"data/temp_summary_plot1.rds\")\n\n\n# Temporal Plots - Summary ------------------------------------------------\n\ntemp_summary_plot &lt;- plot_out %&gt;%\n  select(TRCA,\n         summary_terms_temporal,\n         Endpoint,\n         trans,\n         brks) %&gt;% \n  unnest(summary_terms_temporal) %&gt;% \n  filter(group_var %in% c(\"`Stress Class`\",\"`UCA Class`\",\"`1`\")) %&gt;% #\"`Habitat Stability Class`\",\n  mutate(\n    gp = case_when(\n      group_var == \"`1`\" ~ \"Overall\",\n      #group_var == \"`Habitat Stability Class`\" ~ `Habitat Stability Class`,\n      group_var == \"`Stress Class`\" ~ `Stress Class`,\n      group_var == \"`UCA Class`\" ~ `UCA Class`,\n    ),\n    group_var = case_when(\n      group_var == \"`1`\" ~ \"Overall\",\n      #group_var == \"`Habitat Stability Class`\" ~ \"Habitat Stability Class\",\n      group_var == \"`Stress Class`\" ~ \"Stress Class\",\n      group_var == \"`UCA Class`\" ~ \"UCA Class\",\n      T ~ group_var\n    )\n  ) %&gt;% \n  mutate(group_var = factor(group_var, levels = rev(c(\"Stress Class\",\"UCA Class\",\"Overall\")))) %&gt;% #\"Habitat Stability Class\",\n  group_by(TRCA,Endpoint) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map2(data,Endpoint,\n                     ~{\n                       .x  %&gt;% \n                         mutate(gp = factor(gp,levels=c(\"Overall\",\"Small\",\"Intermediate\",\"Large\",\"High\",\"Medium\",\"Low\"))) %&gt;% \n                         #filter(!is.na(gp)) %&gt;% \n                         ggplot(\n                           aes(x = gp,\n                               y = mean_slope,\n                               colour = group_var#,\n                               # alpha = case_when(\n                               #   grepl(\"Sig\",linear_trend) ~ 1,\n                               #   grepl(\"Trend\",linear_trend) ~ 0.92,\n                               #   T ~ 0.8\n                               # )\n                           )\n                         ) +\n                         geom_pointrange(aes(ymin = lower_slope_sig,\n                                             ymax = upper_slope_sig,\n                         ),linewidth = 0.25) +\n                         geom_pointrange(aes(ymin = lower_slope_trend,\n                                             ymax = upper_slope_trend,\n                         ),linewidth = 1.5) +\n                         geom_point(aes(x = gp,\n                                        y = mean_slope),\n                                    shape=21,size=2.5,inherit.aes = F) +\n                         geom_hline(yintercept = 0) +\n                         scale_colour_discrete() +\n                         facet_grid(~group_var,scales=\"free\", drop=TRUE) +\n                         theme_bw() +\n                         ylab(\"\")+\n                         xlab(\"\")+\n                         theme(\n                           legend.position = \"none\"\n                         ) +\n                         labs(title = .y)+\n                         guides(alpha=\"none\")\n                     }))\n\ntemp_summary_plot &lt;- temp_summary_plot %&gt;% \n  ungroup() %&gt;% \n  group_by(TRCA) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map(data,~cowplot::plot_grid(plotlist=.x$plot,ncol=1,align =\"hv\",axis =\"tblr\"))) %&gt;% \n  mutate(plot = map(plot,~cowplot::plot_grid( \n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Overall Trends\",\n      fontface = 'bold',\n      size = 14,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Mean +/- 50 and 90 percent confidence intervals of the slope coefficients from GLMM models\",\n      fontface = 'plain',\n      size = 12,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Coefficients with confidence intervals that don't overlap 0 are considered to increase or decrease significantly\",\n      fontface = 'plain',\n      size = 10,\n      x = 0,\n      hjust = 0\n    ),\n    .x,\n    ncol=1,\n    rel_heights = c(0.01,0.01,0.01,1))))\n\nsaveRDS(temp_summary_plot,\"data/temp_summary_plot.rds\")\n\n# Temporal Maps -----------------------------------------------------------\n\nplot_out$temporal_map1 &lt;- map2(\n  plot_out$Pred_current,\n  plot_out$Endpoint,\n  ~basemap_ggplot(sf::st_bbox(TRCA_subwats),map_service=\"carto\",map_type=\"light\",verbose=F) +\n    theme_minimal()+\n    theme(legend.position = \"bottom\",\n          axis.text = element_blank(),\n          axis.ticks = element_blank(),\n          legend.key.width = unit(dev.size()[1] / 15, \"inches\"),\n          legend.key.height = unit(dev.size()[2] / 50, \"inches\"),\n          plot.margin=unit(c(0,0,0,0),\"cm\")) +\n    ylab(\"\")+\n    xlab(\"\")+\n    geom_sf(data=sf::st_transform(TRCA_subwats,crs=\"EPSG: 3857\"),alpha=0.75)+\n    geom_sf(data=sf::st_transform(TRCA_wats,crs=\"EPSG: 3857\"),alpha=0,linewidth=1.25)+\n    geom_sf(data=sf::st_transform(strm_lns,crs=\"EPSG: 3857\"),alpha=0.25,colour=\"darkblue\")+\n    geom_sf(data=sf::st_transform(.x,crs=\"EPSG: 3857\"),\n            aes(colour=linear_trend),\n            size=3,\n            linewidth=0.05) +\n    geom_sf(data=sf::st_transform(.x,crs=\"EPSG: 3857\"),\n            size=3,\n            shape=21) +\n    scale_colour_manual(values = c(\n      `Increasing Significant`=\"darkolivegreen4\",\n      `Increasing Trend`=\"darkolivegreen2\",\n      `No Change`=\"black\",\n      `Decreasing Trend`=\"skyblue2\",\n      `Decreasing Significant`=\"skyblue4\"\n    )) +\n    labs(\n      title = .y,\n      subtitle  = \"Mean slope coefficients from GLMM models\",\n      colour = .y\n    ) \n)\n\n\n\n# Spatial Plots -----------------------------------------------------------\n\n\nplot_out$spatial_plot1 &lt;- pmap(\n  list(.x=plot_out$Pred_current,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    ggplot(\n      .x,\n      aes(x = SiteCode,\n          y = pred.fit,\n          colour = WSHED\n      )\n    ) +\n      geom_pointrange(aes(ymin = pred_low,\n                          ymax = pred_high,\n      ),linewidth = 0.25) +\n      geom_pointrange(aes(ymin = pred_low_trend,\n                          ymax = pred_high_trend,\n      ),linewidth = 1.5) +\n      geom_point(aes(x = SiteCode,\n                     y = pred.fit),shape=21,size=2.5,inherit.aes = F)+\n      \n      scale_colour_discrete() +\n      facet_wrap(~WSHED, scales = \"free_x\") +\n      theme_bw() +\n      ylab(.y) +\n      theme(\n        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),\n        legend.position = \"none\"\n      ) +\n      labs(title = paste0(.y),\n           subtitle = \"Mean +/- 50 and 90 percent confidence intervals of predicted 2024 mean values from GLMM models\",\n           caption  = \"Areas with confidence intervals that don't overlap 0 are considered to differ significantly\"\n      ) +\n      scale_y_continuous(breaks = .a()) +\n      coord_transform(\n        y = .z\n      )\n  }\n)\n\nplot_out$spatial_plot1_1 &lt;- pmap(\n  list(.x=plot_out$Pred_current,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    ggplot(\n      .x,\n      aes(x = SiteCode,\n          y = pred.fit,\n          shape = `Stress Class`,\n          colour = `UCA Class`\n      )\n    ) +\n      geom_linerange(aes(ymin = pred_low,\n                         ymax = pred_high,\n                         colour = `UCA Class`\n      ),linewidth = 0.25) +\n      geom_linerange(aes(ymin = pred_low_trend,\n                         ymax = pred_high_trend,\n                         colour = `UCA Class`\n      ),linewidth = 1.5) +\n      geom_point(aes(x = SiteCode,\n                     y = pred.fit,\n                     shape = `Stress Class`,\n                     fill = `UCA Class`),size=2.5,inherit.aes = F)+\n      scale_shape_manual(values=c(21,22,23))+\n      scale_colour_manual(values = cols_list) +\n      scale_fill_manual(values = cols_list) +\n      facet_wrap(~WSHED, scales = \"free_x\") +\n      theme_bw() +\n      ylab(.y) +\n      theme(\n        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),\n        legend.position = \"top\"\n      ) +\n      labs(title = paste0(.y),\n           subtitle = \"Mean +/- 50 and 90 percent confidence intervals of predicted 2024 mean values from GLMM models\",\n           caption  = \"Areas with confidence intervals that don't overlap 0 are considered to differ significantly\"\n      ) +\n      scale_y_continuous(breaks = .a()) +\n      coord_transform(\n        y = .z\n      )\n  }\n)\n\n\n# Spatial Plot - High Level -----------------------------------------------\n\n\nplot_out$spatial_plot2 &lt;- pmap(\n  list(.x=plot_out$summary_terms_spatial,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    .x %&gt;% \n      mutate(\n        gp = case_when(\n          group_var == \"`1`\" ~ \"Overall\",\n          #group_var == \"`Habitat Stability Class`\" ~ `Habitat Stability Class`,\n          group_var == \"`Stress Class`\" ~ `Stress Class`,\n          group_var == \"`UCA Class`\" ~ `UCA Class`,\n        ),\n        gp = factor(gp,levels=c(\"Overall\",\"Small\",\"Intermediate\",\"Large\",\"High\",\"Medium\",\"Low\"))\n      ) %&gt;% \n      filter(group_var == \"`UCA Class`:`Stress Class`\") %&gt;% #:`Habitat Stability Class`\n      mutate(`Stress Class` = paste0(\"Stress - \",`Stress Class`)) %&gt;%\n      #mutate(`Habitat Stability Class` = paste0(\"Habitat Stability - \",`Habitat Stability Class`)) %&gt;%\n      mutate(`Stress Class` = factor(`Stress Class`,levels = paste0(\"Stress - \",c(\"High\",\"Medium\",\"Low\")))) %&gt;% \n      #mutate(`Habitat Stability Class` = factor(`Habitat Stability Class`,levels = paste0(\"Habitat Stability - \",c(\"High\",\"Low\")))) %&gt;% \n      mutate(gp=case_when(\n        #is.na(`Stress Class`) ~ `Habitat Stability Class`,\n        T ~ `Stress Class`)) %&gt;% \n      ggplot(\n        aes(x = `UCA Class`,\n            y = value,\n            colour = `Stress Class`, #`Habitat Stability Class`\n            group = `Stress Class` #`Habitat Stability Class`\n        )\n      ) +\n      geom_pointrange(aes(ymin = pred_low,\n                          ymax = pred_high,\n      ),linewidth = 0.25,position=position_dodge(width=0.5)) +\n      geom_pointrange(aes(ymin = pred_low_trend,\n                          ymax = pred_high_trend,\n      ),linewidth = 1.5,position=position_dodge(width=0.5)) +\n      geom_point(aes(x = `UCA Class`,\n                     y = value,\n                     group = `Stress Class`), #`Habitat Stability Class`\n                 shape=21,size=2.5,inherit.aes = F,position=position_dodge(width=0.5))+\n      \n      scale_colour_discrete() +\n      #facet_grid(~`Stress Class`) +\n      theme_bw() +\n      ylab(.y) +\n      theme(\n        legend.position = \"bottom\"\n      ) +\n      labs(title = paste0(.y),\n           subtitle = \"Mean +/- 50 and 90 percent confidence intervals of predicted 2024 mean values from GLMM models\",\n           caption  = \"Coefficients with confidence intervals that don't overlap are considered to differ significantly\"\n      ) +\n      scale_y_continuous(breaks = .a()) +\n      coord_transform(\n        y = .z\n      )\n  }\n)\n\n#version 2\nspat_summary_plot1 &lt;- plot_out %&gt;%\n  select(TRCA,\n         summary_terms_spatial,\n         Endpoint,\n         trans,\n         brks) %&gt;% \n  unnest(summary_terms_spatial) %&gt;% \n  filter(group_var %in% c(\"`UCA Class`:`Stress Class`\")) %&gt;% #\"`Habitat Stability Class`\",\n  group_by(TRCA,Endpoint) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map2(data,Endpoint,\n                     ~{\n                       .x  %&gt;% \n                         ggplot(\n                           aes(x = `UCA Class`,\n                               y = value,\n                               colour = `Stress Class`\n                           )\n                         ) +\n                         geom_pointrange(\n                           aes(ymin = pred_low,\n                               ymax = pred_high,\n                           ),\n                           linewidth = 0.25,\n                           position=position_dodge(width=0.25)) +\n                         geom_pointrange(\n                           aes(ymin = pred_low_trend,\n                               ymax = pred_high_trend,\n                           ),\n                           linewidth = 1.5,\n                           position=position_dodge(width=0.25)) +\n                         geom_point(\n                           aes(x = `UCA Class`,\n                               y = value,\n                               group = `Stress Class`),\n                           shape=21,\n                           size=2.5,\n                           inherit.aes = F,\n                           position=position_dodge(width=0.25)) +\n                         scale_colour_discrete() +\n                         theme_bw() +\n                         ylab(\"\")+\n                         xlab(\"\")+\n                         theme(\n                           legend.position = \"bottom\"\n                         ) +\n                         labs(title=.y)+\n                         guides(alpha=\"none\") +\n                         scale_y_continuous(breaks = .x$brks[[1]]()) +\n                         coord_transform(\n                           y = .x$trans[[1]]\n                         )\n                     }))\n\nspat_summary_plot1 &lt;- spat_summary_plot1 %&gt;% \n  ungroup() %&gt;% \n  group_by(TRCA) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map(data,~cowplot::plot_grid(plotlist=.x$plot,ncol=1,align =\"hv\",axis =\"tblr\") )) %&gt;% \n  mutate(plot = map(plot,~cowplot::plot_grid(\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Overall Means\",\n      fontface = 'bold',\n      size = 14,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Mean +/- 50 and 90 percent confidence intervals of predicted 2024 mean values from GLMM models\",\n      fontface = 'plain',\n      size = 12,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Coefficients with confidence intervals that don't overlap are considered to differ significantly\",\n      fontface = 'plain',\n      size = 10,\n      x = 0,\n      hjust = 0\n    ),\n    .x,\n    ncol=1,\n    rel_heights = c(0.01,0.01,0.01,1))))\n\nsaveRDS(spat_summary_plot1,\"data/spat_summary_plot1.rds\")\n\n\n# Spatial Plots - Summary ------------------------------------------------\n\nspat_summary_plot &lt;- plot_out %&gt;%\n  select(TRCA,\n         summary_terms_spatial,\n         Endpoint,\n         trans,\n         brks) %&gt;% \n  unnest(summary_terms_spatial) %&gt;% \n  filter(group_var %in% c(\"`Stress Class`\",\"`UCA Class`\",\"`1`\")) %&gt;% #\"`Habitat Stability Class`\",\n  mutate(\n    gp = case_when(\n      group_var == \"`1`\" ~ \"Overall\",\n      #group_var == \"`Habitat Stability Class`\" ~ `Habitat Stability Class`,\n      group_var == \"`Stress Class`\" ~ `Stress Class`,\n      group_var == \"`UCA Class`\" ~ `UCA Class`,\n    ),\n    group_var = case_when(\n      group_var == \"`1`\" ~ \"Overall\",\n      #group_var == \"`Habitat Stability Class`\" ~ \"Habitat Stability Class\",\n      group_var == \"`Stress Class`\" ~ \"Stress Class\",\n      group_var == \"`UCA Class`\" ~ \"UCA Class\",\n      T ~ group_var\n    )\n  ) %&gt;% \n  mutate(group_var = factor(group_var, levels = rev(c(\"Stress Class\",\"UCA Class\",\"Overall\")))) %&gt;% #\"Habitat Stability Class\",\n  group_by(TRCA,Endpoint) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map2(data,Endpoint,\n                     ~{\n                       .x  %&gt;% \n                         mutate(gp = factor(gp,levels=c(\"Overall\",\"Small\",\"Intermediate\",\"Large\",\"High\",\"Medium\",\"Low\"))) %&gt;% \n                         ggplot(\n                           aes(x = gp,\n                               y = value,\n                               colour = group_var\n                           )\n                         ) +\n                         geom_pointrange(aes(ymin = pred_low,\n                                             ymax = pred_high,\n                         ),linewidth = 0.25) +\n                         geom_pointrange(aes(ymin = pred_low_trend,\n                                             ymax = pred_high_trend,\n                         ),linewidth = 1.5) +\n                         geom_point(aes(x = gp,\n                                        y = value),\n                                    shape=21,size=2.5,inherit.aes = F) +\n                         scale_colour_discrete() +\n                         facet_grid(~group_var,scales=\"free\", drop=TRUE) +\n                         theme_bw() +\n                         ylab(\"\")+\n                         xlab(\"\")+\n                         theme(\n                           legend.position = \"none\"\n                         ) +\n                         labs(title=.y)+\n                         guides(alpha=\"none\") +\n                         scale_y_continuous(breaks = .x$brks[[1]]()) +\n                         coord_transform(\n                           y = .x$trans[[1]]\n                         )\n                     }))\n\nspat_summary_plot &lt;- spat_summary_plot %&gt;% \n  ungroup() %&gt;% \n  group_by(TRCA) %&gt;% \n  nest() %&gt;% \n  mutate(plot = map(data,~cowplot::plot_grid(plotlist=.x$plot,ncol=1,align =\"hv\",axis =\"tblr\") )) %&gt;% \n  mutate(plot = map(plot,~cowplot::plot_grid(\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Overall Means\",\n      fontface = 'bold',\n      size = 14,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Mean +/- 50 and 90 percent confidence intervals of predicted 2024 mean values from GLMM models\",\n      fontface = 'plain',\n      size = 12,\n      x = 0,\n      hjust = 0\n    ),\n    cowplot::ggdraw()+cowplot::draw_label(\n      \"Coefficients with confidence intervals that don't overlap are considered to differ significantly\",\n      fontface = 'plain',\n      size = 10,\n      x = 0,\n      hjust = 0\n    ),\n    .x,\n    ncol=1,\n    rel_heights = c(0.01,0.01,0.01,1))))\n\nsaveRDS(spat_summary_plot,\"data/spat_summary_plot.rds\")\n\n# Spatial Maps -----------------------------------------------------------\n\nplot_out$spatial_map1 &lt;- pmap(\n  list(.x=plot_out$Pred_current,\n       .y=plot_out$Endpoint,\n       .z=plot_out$trans,\n       .a=plot_out$brks\n  ),\n  function(.x,.y,.z,.a) {\n    basemap_ggplot(sf::st_bbox(TRCA_subwats),map_service=\"carto\",map_type=\"light\",verbose=F) +\n      theme_minimal()+\n      theme(legend.position = \"bottom\",\n            axis.text = element_blank(),\n            axis.ticks = element_blank(),\n            legend.key.width = unit(dev.size()[1] / 15, \"inches\"),\n            legend.key.height = unit(dev.size()[2] / 50, \"inches\"),\n            plot.margin=unit(c(0,0,0,0),\"cm\")) +\n      ylab(\"\")+\n      xlab(\"\")+\n      geom_sf(data=sf::st_transform(TRCA_subwats,crs=\"EPSG: 3857\"),alpha=0.75)+\n      geom_sf(data=sf::st_transform(TRCA_wats,crs=\"EPSG: 3857\"),alpha=0,linewidth=1.25)+\n      geom_sf(data=sf::st_transform(strm_lns,crs=\"EPSG: 3857\"),alpha=0.25,colour=\"darkblue\")+\n      geom_sf(data=sf::st_transform(.x,crs=\"EPSG: 3857\"),\n              aes(colour=pred.fit),\n              size=3,\n              linewidth=0.1) +\n      scale_colour_continuous(palette = \"Spectral\",type=\"div\",trans = .z,breaks=.a()) +\n      geom_sf(data=sf::st_transform(.x,crs=\"EPSG: 3857\"),\n              shape=21,\n              size=3) +\n      labs(\n        title = .y,\n        subtitle = \"Predicted 2024 mean values from GLMM models\",\n        colour = .y\n      ) \n    \n  }\n)\n\n\nsaveRDS(plot_out,\"data/results_plots.rds\")\n\n\n\n# Temporal Summary Tables ----------------------------------------------------------\n\ntbl_out &lt;- plot_out %&gt;% \n  select(Endpoint_group,Endpoint,Pred_current) %&gt;% \n  unnest(Pred_current) %&gt;% \n  mutate(`UCA Class`=factor(`UCA Class`,levels = c(\"Small\",\"Intermediate\",\"Large\"))) %&gt;% \n  mutate(`Stress Class`=factor(`Stress Class`,levels = c(\"Low\",\"Medium\",\"High\"))) %&gt;% \n  #mutate(`Habitat Stability Class`=factor(`Habitat Stability Class`,levels = c(\"High\",\"Low\"))) %&gt;% \n  arrange(`Stress Class`,`UCA Class`) %&gt;% #,`Habitat Stability Class`\n  mutate(value = paste0(mean_slope,\" (\",lower_slope_sig,\" - \",upper_slope_sig,\")\")) %&gt;% \n  select(Endpoint_group,Endpoint,WSHED,SiteCode,value,linear_trend,\n         `Stress Class`,`UCA Class`#,`Habitat Stability Class`\n  )\n\nep_grp &lt;- tbl_out %&gt;% \n  select(Endpoint_group,Endpoint) %&gt;% \n  distinct()%&gt;% \n  group_by(Endpoint_group) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$Endpoint),.x$Endpoint_group[[1]])) %&gt;% \n  unlist(recursive = F)\n\nsite_grp &lt;- tbl_out %&gt;% \n  select(WSHED,SiteCode,`Stress Class`,`UCA Class`) %&gt;%  #,`Habitat Stability Class`\n  distinct() %&gt;% \n  group_by(WSHED) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x %&gt;% select(-WSHED)),.x$WSHED[[1]])) %&gt;% \n  unlist(recursive = F)\n\nshade_tbl &lt;- tbl_out %&gt;% \n  select(-value,-Endpoint_group,-WSHED) %&gt;% \n  pivot_wider(names_from = Endpoint,values_from = linear_trend) %&gt;% \n  mutate(SiteCode = as.character(SiteCode)) %&gt;% \n  mutate(across(everything(),~case_when(is.na(.x) ~ \"No Change\", T ~ .x)))\n\nwritexl::write_xlsx(shade_tbl,\"data/changetbl1.xlsx\")\n\nshade_tbl_sym &lt;- shade_tbl %&gt;% \n  mutate(across(everything(),\n                ~case_when(\n                  .x == \"Increasing Significant\" ~ \"++\",\n                  .x == \"Increasing Trend\" ~ \"+\",\n                  .x == \"No Change\" ~ \"0\",\n                  .x == \"Decreasing Trend\" ~ \"-\",\n                  .x == \"Decreasing Significant\" ~ \"--\",\n                  is.na(.x) ~ \"0\",\n                  T ~ .x\n                )))\n\nnum_tbl &lt;- tbl_out %&gt;% \n  select(-linear_trend,-Endpoint_group,-WSHED) %&gt;% \n  pivot_wider(names_from = Endpoint,values_from = value) %&gt;% \n  mutate(SiteCode = as.character(SiteCode))\n\ncol_list &lt;- list(`Increasing Significant` = \"darkolivegreen4\",\n                 `Increasing Trend` = \"darkolivegreen2\",\n                 `No Change` = \"grey90\",\n                 `Decreasing Trend` = \"skyblue2\",\n                 `Decreasing Significant` = \"skyblue4\"\n)\n\n\ncol_list_leg &lt;- list(`+ + = Increasing Significant` = \"darkolivegreen4\",\n                     `+ = Increasing Trend` = \"darkolivegreen2\",\n                     `0 = No Change` = \"darkgrey\",\n                     `- = Decreasing Trend` = \"skyblue2\",\n                     `- - = Decreasing Significant` = \"skyblue4\"\n)\n\ncol_list_leg &lt;- map2(names(col_list_leg),col_list,\n                     ~paste0(\"&lt;span style='color:\",col2hex(.y),\";'&gt;\",.x,\"&lt;/span&gt;\"))\n\ncol_list_leg &lt;- paste0(col_list_leg, collapse = \" | \")\n\n\ngt_list &lt;- list()\n\nfor (v in names(site_grp)){\n  \n  shade_tbl_sub &lt;- shade_tbl %&gt;% \n    filter(SiteCode %in% site_grp[[v]]$SiteCode) %&gt;%\n    select(-`Stress Class`)\n  shade_tbl_sym_sub &lt;- shade_tbl_sym %&gt;%\n    filter(SiteCode %in% site_grp[[v]]$SiteCode) %&gt;%\n    select(-`Stress Class`)\n  \n  gt_tbl &lt;- gt::gt(shade_tbl_sym_sub  ,\n                   rowname_col = \"SiteCode\") %&gt;% \n    gt::tab_header(\n      title = v\n    ) %&gt;%\n    gt::tab_stubhead(label = v) %&gt;% \n    gt::tab_source_note(\n      source_note = gt::md(col_list_leg)\n    ) %&gt;% \n    gt::tab_style(\n      style = gt::cell_text(align = \"center\", v_align = \"middle\"),\n      locations = gt::cells_body(\n        columns = everything(),\n        rows = everything()\n      )\n    ) %&gt;% \n    gt::tab_style(\n      style = gt::cell_text(align = \"center\",\n                            v_align = \"middle\",\n                            stretch = \"extra-condensed\",\n                            size = \"small\"),\n      locations = gt::cells_column_labels()\n    ) %&gt;% \n    gt::tab_style(\n      style = gt::cell_text(align = \"center\",\n                            v_align = \"middle\",\n                            stretch = \"extra-condensed\",\n                            size = \"small\",\n                            transform=\"capitalize\"),\n      locations = gt::cells_row_groups()\n    )\n  \n  for (i in names(col_list)){\n    for (ii in 1:ncol(shade_tbl_sub)){\n      gt_tbl &lt;- gt_tbl %&gt;% \n        gt::tab_style(\n          style = gt::cell_fill(color = col_list[[i]]),\n          locations = gt::cells_body(\n            columns = ii,\n            rows = which(shade_tbl_sub[[ii]] == i)\n          )\n        )\n    }\n  }\n  \n  for (i in names(ep_grp)){\n    gt_tbl &lt;- gt_tbl %&gt;% gt::tab_spanner(label = i,columns  = as.character(ep_grp[[i]]))\n  }\n  \n  for (i in unique(site_grp[[v]]$`Stress Class`)){\n    gt_tbl &lt;- gt_tbl %&gt;% gt::tab_row_group(label = paste0(i,\" Stess Class\"),rows = as.character(site_grp[[v]]$SiteCode[site_grp[[v]]$`Stress Class`==i]))\n  }\n  \n  gt_list[[v]] &lt;- gt_tbl\n}\n\ngt_tbl &lt;- gt::gt_group(\n  .list = gt_list\n)\n\nsaveRDS(gt_tbl,\"data/summarytbl.rds\")\n\n# Trend Summary Table 1 ---------------------------------------------------\n\ntbl_out &lt;- plot_out %&gt;% \n  select(Endpoint_group,Endpoint,summary_terms_temporal) %&gt;% \n  unnest(summary_terms_temporal) %&gt;% \n  filter(group_var %in% c(\"`1`\",\"`Stress Class`\",\"`UCA Class`\")) %&gt;% #,\"`Habitat Stability Class`\",\n  select(Endpoint_group,Endpoint,`Stress Class`,`UCA Class`,`1`,linear_trend) %&gt;% #,`Habitat Stability Class`\n  arrange(`Stress Class`,`UCA Class`,`1`) %&gt;% #,`Habitat Stability Class`\n  pivot_longer(c(`Stress Class`,`UCA Class`,`1`)) %&gt;% #,`Habitat Stability Class`\n  filter(!is.na(value))\n\nlevels(tbl_out$value)[levels(tbl_out$value)==\"overall\"]&lt;-\"Global Trend\"\n\nep_grp &lt;- tbl_out %&gt;% \n  select(Endpoint_group,Endpoint) %&gt;% \n  distinct()%&gt;% \n  group_by(Endpoint_group) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$Endpoint),.x$Endpoint_group[[1]])) %&gt;% \n  unlist(recursive = F)\n\nsite_grp &lt;- tbl_out %&gt;% \n  select(name,value) %&gt;% \n  distinct() %&gt;% \n  group_by(name) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$value),.x$name[[1]])) %&gt;% \n  unlist(recursive = F)\n\nshade_tbl &lt;- tbl_out %&gt;% \n  select(-Endpoint_group) %&gt;% \n  pivot_wider(names_from = Endpoint,values_from = linear_trend) %&gt;% \n  arrange(name,value) %&gt;% \n  mutate(across(everything(),~case_when(is.na(.x) ~ \"No Change\", T ~ .x)))\n\nsite_grp &lt;- shade_tbl %&gt;% \n  mutate(value = row_number()) %&gt;% \n  select(name,value) %&gt;% \n  distinct() %&gt;% \n  group_by(name) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$value),.x$name[[1]])) %&gt;% \n  unlist(recursive = F)\n\nsite_grp&lt;-rev(site_grp)\nnames(site_grp)[names(site_grp)==\"1\"] &lt;- \" \"\n\n\nshade_tbl &lt;- shade_tbl %&gt;% \n  select(-name) \n\nshade_tbl_sym &lt;- shade_tbl %&gt;% \n  mutate(across(everything(),\n                ~case_when(\n                  .x == \"Increasing Significant\" ~ \"++\",\n                  .x == \"Increasing Trend\" ~ \"+\",\n                  .x == \"No Change\" ~ \"0\",\n                  .x == \"Decreasing Trend\" ~ \"-\",\n                  .x == \"Decreasing Significant\" ~ \"--\",\n                  is.na(.x) ~ \"0\",\n                  T ~ .x\n                )))\n\ngt_tbl1 &lt;- gt::gt(shade_tbl_sym,rowname_col = \"value\") %&gt;% \n  gt::tab_stubhead(label = \"Overall Trends\") %&gt;% \n  gt::tab_source_note(\n    source_note = gt::md(col_list_leg)\n  ) %&gt;% \n  gt::tab_style(\n    style = gt::cell_text(align = \"center\", v_align = \"middle\"),\n    locations = gt::cells_body(\n      columns = everything(),\n      rows = everything()\n    )\n  ) %&gt;% \n  gt::tab_style(\n    style = gt::cell_text(align = \"center\",\n                          v_align = \"middle\",\n                          stretch = \"extra-condensed\",\n                          size = \"small\"),\n    locations = gt::cells_column_labels()\n  ) %&gt;% \n  gt::tab_style(\n    style = gt::cell_text(align = \"center\",\n                          v_align = \"middle\",\n                          stretch = \"extra-condensed\",\n                          size = \"small\",\n                          transform=\"capitalize\"),\n    locations = gt::cells_row_groups()\n  )\n\nfor (i in names(col_list)){\n  for (ii in 1:ncol(shade_tbl)){\n    gt_tbl1 &lt;- gt_tbl1 %&gt;% \n      gt::tab_style(\n        style = gt::cell_fill(color = col_list[[i]]),\n        locations = gt::cells_body(\n          columns = ii,\n          rows = which(shade_tbl[[ii]] == i)\n        )\n      )\n  }\n}\n\nfor (i in names(site_grp)){\n  gt_tbl1 &lt;- gt_tbl1 %&gt;% gt::tab_row_group(label = i,rows = site_grp[[i]])\n}\n\nfor (i in names(ep_grp)){\n  gt_tbl1 &lt;- gt_tbl1 %&gt;% gt::tab_spanner(label = i,columns  = as.character(ep_grp[[i]]))\n}\n\n# Trend Summary Table 2 ---------------------------------------------------\n\ntbl_out &lt;- plot_out %&gt;% \n  select(Endpoint_group,Endpoint,summary_terms_temporal) %&gt;% \n  unnest(summary_terms_temporal) %&gt;% \n  filter(group_var == \"`UCA Class`:`Stress Class`\") %&gt;% \n  select(Endpoint_group,Endpoint,`Stress Class`,`UCA Class`,linear_trend) %&gt;% \n  filter(!is.na(`Stress Class`)) %&gt;% \n  mutate(`UCA Class` = paste(\"UCA\",`UCA Class`)) %&gt;% \n  mutate(`UCA Class` = factor(`UCA Class`,levels=c(\"UCA Small\",\"UCA Intermediate\",\"UCA Large\"))) %&gt;% \n  arrange(`UCA Class`)\n\nep_grp &lt;- tbl_out %&gt;% \n  select(Endpoint_group,Endpoint) %&gt;% \n  distinct()%&gt;% \n  group_by(Endpoint_group) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$Endpoint),.x$Endpoint_group[[1]])) %&gt;% \n  unlist(recursive = F)\n\nsite_grp &lt;- tbl_out %&gt;% \n  select(`Stress Class`,`UCA Class`) %&gt;% \n  distinct() %&gt;% \n  group_by(`Stress Class`) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$`UCA Class`),.x$`Stress Class`[[1]])) %&gt;% \n  unlist(recursive = F)\n\nshade_tbl &lt;- tbl_out %&gt;% \n  select(-Endpoint_group) %&gt;% \n  pivot_wider(names_from = Endpoint,values_from = linear_trend) %&gt;% \n  arrange(`Stress Class`,`UCA Class`) %&gt;% \n  mutate(`UCA Class` = as.character(`UCA Class`)) %&gt;% \n  mutate(across(everything(),~case_when(is.na(.x) ~ \"No Change\", T ~ .x)))\n\nsite_grp &lt;- shade_tbl %&gt;% \n  mutate(`UCA Class` = row_number()) %&gt;% \n  select(`Stress Class`,`UCA Class`) %&gt;% \n  distinct() %&gt;% \n  group_by(`Stress Class`) %&gt;% \n  group_split() %&gt;% \n  map(~setNames(list(.x$`UCA Class`),.x$`Stress Class`[[1]])) %&gt;% \n  unlist(recursive = F)\n\nsite_grp &lt;- site_grp[c(\"Low\",\"Medium\",\"High\")]\nnames(site_grp) &lt;- c(c(\"Low Stress\",\"Medium Stress\",\"High Stress\"))\n\nwritexl::write_xlsx(shade_tbl,\"data/changetbl2.xlsx\")\n\nshade_tbl &lt;- shade_tbl %&gt;% \n  select(-`Stress Class`) \n\nshade_tbl_sym &lt;- shade_tbl %&gt;% \n  mutate(across(everything(),\n                ~case_when(\n                  .x == \"Increasing Significant\" ~ \"++\",\n                  .x == \"Increasing Trend\" ~ \"+\",\n                  .x == \"No Change\" ~ \"0\",\n                  .x == \"Decreasing Trend\" ~ \"-\",\n                  .x == \"Decreasing Significant\" ~ \"--\",\n                  is.na(.x) ~ \"0\",\n                  T ~ .x\n                )))\n\ngt_tbl2 &lt;- gt::gt(shade_tbl_sym,rowname_col = \"UCA Class\") %&gt;% \n  # gt::tab_header(\n  #   title = \"Temporal Changes across UCA Class\"\n  # ) %&gt;% \n  gt::tab_stubhead(label = \"UCA Class / Stress Class\") %&gt;% \n  gt::tab_source_note(\n    source_note = gt::md(col_list_leg)\n  ) %&gt;% \n  gt::tab_style(\n    style = gt::cell_text(align = \"center\", v_align = \"middle\"),\n    locations = gt::cells_body(\n      columns = everything(),\n      rows = everything()\n    )\n  ) %&gt;% \n  gt::tab_style(\n    style = gt::cell_text(align = \"center\",\n                          v_align = \"middle\",\n                          stretch = \"extra-condensed\",\n                          size = \"small\"),\n    locations = gt::cells_column_labels()\n  ) %&gt;% \n  gt::tab_style(\n    style = gt::cell_text(align = \"center\",\n                          v_align = \"middle\",\n                          stretch = \"extra-condensed\",\n                          size = \"small\",\n                          transform=\"capitalize\"),\n    locations = gt::cells_row_groups()\n  )\n\nfor (i in names(col_list)){\n  for (ii in 1:ncol(shade_tbl)){\n    gt_tbl2 &lt;- gt_tbl2 %&gt;% \n      gt::tab_style(\n        style = gt::cell_fill(color = col_list[[i]]),\n        locations = gt::cells_body(\n          columns = ii,\n          rows = which(shade_tbl[[ii]] == i)\n        )\n      )\n  }\n}\n\nfor (i in names(site_grp)){\n  gt_tbl2 &lt;- gt_tbl2 %&gt;% gt::tab_row_group(label = i,rows = site_grp[[i]])\n}\n\nfor (i in names(ep_grp)){\n  gt_tbl2 &lt;- gt_tbl2 %&gt;% gt::tab_spanner(label = i,columns  = as.character(ep_grp[[i]]))\n}\n\n\n# Trend Summary Table 3 ---------------------------------------------------\n\n# tbl_out &lt;- plot_out %&gt;% \n#   select(Endpoint_group,Endpoint,summary_terms_temporal) %&gt;% \n#   unnest(summary_terms_temporal) %&gt;% \n#   filter(group_var == \"`UCA Class`:`Habitat Stability Class`\") %&gt;% \n#   select(Endpoint_group,Endpoint,`Habitat Stability Class`,`UCA Class`,linear_trend) %&gt;% \n#   filter(!is.na(`Habitat Stability Class`)) %&gt;% \n#   mutate(`UCA Class` = paste(\"UCA\",`UCA Class`)) %&gt;% \n#   mutate(`UCA Class` = factor(`UCA Class`,levels=c(\"UCA Small\",\"UCA Intermediate\",\"UCA Large\"))) %&gt;% \n#   arrange(`UCA Class`)\n# \n# \n# ep_grp &lt;- tbl_out %&gt;% \n#   select(Endpoint_group,Endpoint) %&gt;% \n#   distinct()%&gt;% \n#   group_by(Endpoint_group) %&gt;% \n#   group_split() %&gt;% \n#   map(~setNames(list(.x$Endpoint),.x$Endpoint_group[[1]])) %&gt;% \n#   unlist(recursive = F)\n# \n# site_grp &lt;- tbl_out %&gt;% \n#   select(`Habitat Stability Class`,`UCA Class`) %&gt;% \n#   distinct() %&gt;% \n#   group_by(`Habitat Stability Class`) %&gt;% \n#   group_split() %&gt;% \n#   map(~setNames(list(.x$`UCA Class`),.x$`Habitat Stability Class`[[1]])) %&gt;% \n#   unlist(recursive = F)\n# \n# shade_tbl &lt;- tbl_out %&gt;% \n#   select(-Endpoint_group) %&gt;% \n#   pivot_wider(names_from = Endpoint,values_from = linear_trend) %&gt;% \n#   arrange(`Habitat Stability Class`,`UCA Class`) %&gt;% \n#   mutate(`UCA Class` = as.character(`UCA Class`)) %&gt;% \n#   mutate(across(everything(),~case_when(is.na(.x) ~ \"No Change\", T ~ .x)))\n# \n# site_grp &lt;- shade_tbl %&gt;% \n#   mutate(`UCA Class` = row_number()) %&gt;% \n#   select(`Habitat Stability Class`,`UCA Class`) %&gt;% \n#   distinct() %&gt;% \n#   group_by(`Habitat Stability Class`) %&gt;% \n#   group_split() %&gt;% \n#   map(~setNames(list(.x$`UCA Class`),.x$`Habitat Stability Class`[[1]])) %&gt;% \n#   unlist(recursive = F)\n# \n# site_grp &lt;- site_grp[c(\"Low\",\"High\")]\n# names(site_grp) &lt;- c(c(\"Low Stability\",\"High Stability\"))\n# \n# writexl::write_xlsx(shade_tbl,\"data/changetbl3.xlsx\")\n# \n# shade_tbl &lt;- shade_tbl %&gt;% \n#   select(-`Habitat Stability Class`)\n# \n# shade_tbl_sym &lt;- shade_tbl %&gt;% \n#   mutate(across(everything(),\n#                 ~case_when(\n#                   .x == \"Increasing Significant\" ~ \"++\",\n#                   .x == \"Increasing Trend\" ~ \"+\",\n#                   .x == \"No Change\" ~ \"0\",\n#                   .x == \"Decreasing Trend\" ~ \"-\",\n#                   .x == \"Decreasing Significant\" ~ \"--\",\n#                   is.na(.x) ~ \"0\",\n#                   T ~ .x\n#                 )))\n# \n# gt_tbl3 &lt;- gt::gt(shade_tbl_sym,rowname_col = \"UCA Class\") %&gt;% \n#   gt::tab_stubhead(label = \"UCA Class / Habitat Stability Class\") %&gt;% \n#   gt::tab_source_note(\n#     source_note = gt::md(col_list_leg)\n#   ) %&gt;% \n#   gt::tab_style(\n#     style = gt::cell_text(align = \"center\", v_align = \"middle\"),\n#     locations = gt::cells_body(\n#       columns = everything(),\n#       rows = everything()\n#     )\n#   ) %&gt;% \n#   gt::tab_style(\n#     style = gt::cell_text(align = \"center\",\n#                           v_align = \"middle\",\n#                           stretch = \"extra-condensed\",\n#                           size = \"small\"),\n#     locations = gt::cells_column_labels()\n#   ) %&gt;% \n#   gt::tab_style(\n#     style = gt::cell_text(align = \"center\",\n#                           v_align = \"middle\",\n#                           stretch = \"extra-condensed\",\n#                           size = \"small\",\n#                           transform=\"capitalize\"),\n#     locations = gt::cells_row_groups()\n#   )\n# \n# for (i in names(col_list)){\n#   for (ii in 1:ncol(shade_tbl)){\n#     gt_tbl3 &lt;- gt_tbl3 %&gt;% \n#       gt::tab_style(\n#         style = gt::cell_fill(color = col_list[[i]]),\n#         locations = gt::cells_body(\n#           columns = ii,\n#           rows = which(shade_tbl[[ii]] == i)\n#         )\n#       )\n#   }\n# }\n# \n# for (i in names(site_grp)){\n#   gt_tbl3 &lt;- gt_tbl3 %&gt;% gt::tab_row_group(label = i,rows = site_grp[[i]])\n# }\n# \n# for (i in names(ep_grp)){\n#   gt_tbl3 &lt;- gt_tbl3 %&gt;% gt::tab_spanner(label = i,columns  = as.character(ep_grp[[i]]))\n# }\n\ngt_tbl4 &lt;- gt::gt_group(\n  gt_tbl1,\n  gt_tbl2,\n  #gt_tbl3\n)\n\nsaveRDS(gt_tbl4,\"data/summarytbl2.rds\")\n\n\n\n\nsource(\"00_source.R\")\n\nmod_data_fin &lt;- readRDS(\"data/results_out.rds\")\n\nfish_ep &lt;- read_csv(\"data/fish_endpoints.csv\") %&gt;% \n  select(SiteCode,Year,Endpoint,Value) %&gt;% \n  pivot_wider(names_from = Endpoint, values_from = Value) %&gt;% \n  select(SiteCode,Year, any_of(sel_fish_ep))\n\ncor_list &lt;- list()\nfish_plot_list &lt;- list()\n\n# TRCA Data ---------------------------------------------------------------\n\ncmb_data_TRCA &lt;- mod_data_fin %&gt;% \n  filter(TRCA) %&gt;% \n  select(Endpoint, data) %&gt;% \n  unnest(data) %&gt;% \n  pivot_wider(names_from = Endpoint,values_from = value) %&gt;% \n  left_join(fish_ep,by = join_by(SiteCode, Year))\n\nhab_data_TRCA &lt;- cmb_data_TRCA %&gt;% \n  select(any_of(unlist(sapply(met_cols,names),use.names=F))#,\n         # any_of(c(\"Upstream Catchment Area\",\"Reach Slope\",\n         #          \"Upstream catchment stress index\",\"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\"))\n  )\n\nfish_data_TRCA &lt;- cmb_data_TRCA %&gt;% \n  select(any_of(names(sel_fish_ep)))\n\ncor_list$TRCA &lt;- heatmap_fn(hab_data_TRCA,\n                            fish_data_TRCA,\n                            alpha=0.1,\n                            sig_est=0.6,\n                            method=\"spearman\",\n                            scale_grad=ggplot2::scale_fill_gradient2(low = scales::muted(rgb(red=0/255,green=102/255,blue=255/255)),\n                                                                     mid = \"white\",\n                                                                     high = scales::muted(rgb(red=0/255,green=176/255,blue=80/255)),\n                                                                     limits=c(-1,1))) \n\nfish_plot_list$TRCA &lt;- cor(fish_data_TRCA,hab_data_TRCA,method=\"spearman\",use=\"pairwise.complete.obs\") %&gt;% \n  as.data.frame() %&gt;% \n  rownames_to_column(\"var1\") %&gt;% \n  pivot_longer(c(everything(),-var1),names_to = \"var2\") %&gt;% \n  mutate(abs_cor = abs(value)) %&gt;% \n  filter(abs_cor&gt;0.3)%&gt;% \n  arrange(desc(abs_cor)) %&gt;% \n  mutate(plot = map2(\n    var1,\n    var2,\n    ~tibble(\n      SiteCode = cmb_data_TRCA$StreamCode,\n      SampleDate = cmb_data_TRCA$SampleDate,\n      var2 = cmb_data_TRCA[[.y]],\n      var1 = fish_data_TRCA[[.x]]\n    ) %&gt;% \n      ggplot(aes(x=var2,y=var1))+\n      geom_point()+\n      geom_smooth(se=F)+\n      ylab(.x)+\n      xlab(.y)+\n      theme_bw()\n    \n  )) %&gt;% \n  mutate(plot = map2(plot,value,\n                     ~.x + labs(\n                       #title = \"TRCA Data Only\",\n                       subtitle = paste0(\"Spearman Correlation = \",scales::label_number(0.001)(.y)))\n  ))\n\n# All Data ----------------------------------------------------------------\n\ncmb_data_all &lt;- mod_data_fin %&gt;% \n  filter(!TRCA) %&gt;% \n  select(Endpoint, data) %&gt;% \n  unnest(data) %&gt;% \n  pivot_wider(names_from = Endpoint,values_from = value) %&gt;% \n  left_join(fish_ep,by = join_by(SiteCode, Year))\n\nhab_data_all &lt;- cmb_data_all %&gt;% \n  select(any_of(unlist(sapply(met_cols,names),use.names=F))#,\n         # any_of(c(\"Upstream Catchment Area\",\"Reach Slope\",\n         #          \"Upstream catchment stress index\",\"Upstream catchment developed (%)\",\"Upstream catchment agricultural (%)\"))\n  )\n\nfish_data_all &lt;- cmb_data_all %&gt;% \n  select(any_of(names(sel_fish_ep)))\n\ncor_list$All &lt;- heatmap_fn(hab_data_all,\n                            fish_data_all,\n                            alpha=0.1,\n                            sig_est=0.6,\n                            method=\"spearman\",\n                            scale_grad=ggplot2::scale_fill_gradient2(low = scales::muted(rgb(red=0/255,green=102/255,blue=255/255)),\n                                                                     mid = \"white\",\n                                                                     high = scales::muted(rgb(red=0/255,green=176/255,blue=80/255)),\n                                                                     limits=c(-1,1))) \n\n\nfish_plot_list$All &lt;- cor(fish_data_all,hab_data_all,method=\"spearman\",use=\"pairwise.complete.obs\") %&gt;% \n  as.data.frame() %&gt;% \n  rownames_to_column(\"var1\") %&gt;% \n  pivot_longer(c(everything(),-var1),names_to = \"var2\") %&gt;% \n  mutate(abs_cor = abs(value)) %&gt;% \n  filter(abs_cor&gt;0.3)%&gt;% \n  arrange(desc(abs_cor)) %&gt;% \n  mutate(plot = map2(\n    var1,\n    var2,\n    ~tibble(\n      SiteCode = cmb_data_all$StreamCode,\n      SampleDate = cmb_data_all$SampleDate,\n      var2 = hab_data_all[[.y]],\n      var1 = fish_data_all[[.x]]\n    ) %&gt;% \n      ggplot(aes(x=var2,y=var1))+\n      geom_point()+\n      geom_smooth(se=F)+\n      ylab(.x)+\n      xlab(.y)+\n      theme_bw()\n    \n  )) %&gt;% \n  mutate(plot = map2(plot,value,\n                     ~.x + labs(\n                       #title = \"All Data\",\n                       subtitle = paste0(\"Spearman Correlation = \",scales::label_number(0.001)(.y)))\n  ))\n\nsaveRDS(fish_plot_list,\"data/biofish_plots.rds\")\nsaveRDS(cor_list,\"data/biocor_plots.rds\")\n\n\n\n\n\n\n\n\n\nThese figures show the raw data for each endpoint over time, grouped by watershed. The grey bars represent the 90 percent prediction interval for each observation.\n\nMorphologySubstrate SizesIndicesPercentCover\n\n\n\nWidth - MeanDepth - MeanWidth:Depth RatioUsable Area\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nD50D85D50Max\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSediment Sorting IndexBank Stability - MeanHabitat Homogeneity\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nFilamentous Algae PercentNon-Filamentous Algae PercentMoss Percent\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nWood Cover - UnembeddedWood Cover - TotalRound Rock Cover - UnembeddedRound Rock Cover - TotalFlat Rock Cover - UnembeddedFlat Rock Cover - Total\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nModel SummariesModel ResidualsModel Fit\n\n\nThese tables show the model coefficients, estimated standard error, and significance for fixed effects terms. Random effects are summarized as variance and correlations within groups. Variance measures how much the random effects vary across different groups or levels in the hierarchy.Random effects models assume that observations within the same group are correlated. This correlation arises because these observations share common characteristics. Summary measures are provided below the model results.\n\n\n\n\n\n\n  All Data\n  \n    \n      effect\n       \n        \n      \n        Width - Mean    \n      \n      \n        Depth - Mean    \n      \n      \n        Width:Depth Ratio    \n      \n      \n        Usable Area    \n      \n      \n        D50    \n      \n      \n        D85    \n      \n      \n        D50Max    \n      \n      \n        Sediment Sorting Index    \n      \n      \n        Bank Stability - Mean    \n      \n      \n        Habitat Homogeneity    \n      \n      \n        Filamentous Algae Percent    \n      \n      \n        Non-Filamentous Algae Percent    \n      \n      \n        Moss Percent    \n      \n      \n        Wood Cover - Unembedded    \n      \n      \n        Wood Cover - Total    \n      \n      \n        Round Rock Cover - Unembedded    \n      \n      \n        Round Rock Cover - Total    \n      \n      \n        Flat Rock Cover - Unembedded    \n      \n      \n        Flat Rock Cover - Total    \n      \n    \n    \n      Est.\n      S.E.\n      Est. \n      S.E. \n      Est.  \n      S.E.  \n      Est.   \n      S.E.   \n      Est.    \n      S.E.    \n      Est.     \n      S.E.     \n      Est.      \n      S.E.      \n      Est.       \n      S.E.       \n      Est.        \n      S.E.        \n      Est.         \n      S.E.         \n      Est.          \n      S.E.          \n      Est.           \n      S.E.           \n      Est.            \n      S.E.            \n      Est.             \n      S.E.             \n      Est.              \n      S.E.              \n      Est.               \n      S.E.               \n      Est.                \n      S.E.                \n      Est.                 \n      S.E.                 \n      Est.                  \n      S.E.                  \n    \n  \n  \n    fixed cond\n(Intercept)\n\n0.943***\n0.163\n5.390***\n0.143\n2.482***\n0.186\n4.731***\n0.203\n2.761***\n0.269\n3.652***\n0.287\n3.271***\n0.308\n5.140***\n0.188\n0.120\n0.142\n-2.491***\n0.328\n-1.923**\n0.649\n-2.696***\n0.718\n-2.275***\n0.523\n-2.537***\n0.283\n-2.430***\n0.304\n-2.550***\n0.391\n-2.512***\n0.425\n-3.328***\n0.452\n-3.081***\n0.479\n    \nlog1p(`Reach Slope`)\n\n0.005\n0.187\n-0.593***\n0.119\n0.540**\n0.169\n-0.190\n0.184\n0.304+\n0.168\n0.932***\n0.219\n1.133***\n0.250\n-0.069\n0.136\n0.219*\n0.106\n0.441*\n0.224\n0.646+\n0.356\n0.942**\n0.337\n0.675*\n0.330\n-0.011\n0.226\n0.046\n0.231\n0.835**\n0.281\n1.220***\n0.341\n1.201***\n0.354\n1.574***\n0.396\n    \nYear_n\n\n0.001\n0.005\n0.002\n0.006\n0.003\n0.006\n0.012+\n0.006\n-0.004\n0.011\n-0.006\n0.010\n-0.002\n0.009\n-0.002\n0.008\n0.004\n0.006\n0.029*\n0.014\n-0.011\n0.034\n0.001\n0.032\n0.003\n0.022\n0.022*\n0.011\n0.017\n0.012\n-0.010\n0.016\n-0.014\n0.015\n0.030+\n0.017\n0.015\n0.017\n    \n`UCA Class`Intermediate\n\n0.707***\n0.142\n0.276+\n0.147\n0.503*\n0.197\n0.931***\n0.220\n-0.276\n0.338\n0.211\n0.317\n0.607+\n0.313\n-0.414+\n0.222\n-0.179\n0.148\n1.682***\n0.361\n0.282\n0.703\n0.484\n0.758\n0.876\n0.558\n0.081\n0.306\n0.149\n0.333\n0.865*\n0.406\n1.005*\n0.444\n0.926*\n0.456\n0.837+\n0.472\n    \n`UCA Class`Large\n\n1.333***\n0.264\n0.335+\n0.190\n1.079***\n0.281\n1.719***\n0.322\n-0.158\n0.366\n0.602\n0.400\n0.718+\n0.432\n-0.634*\n0.277\n0.160\n0.199\n2.115***\n0.458\n0.279\n0.783\n0.476\n0.885\n0.903\n0.833\n-0.557\n0.478\n-0.545\n0.520\n0.846\n0.545\n1.158+\n0.621\n0.602\n0.668\n0.577\n0.693\n    \n`Stress Class`Medium\n\n0.190\n0.171\n0.091\n0.144\n0.280\n0.181\n0.346+\n0.200\n0.181\n0.291\n-0.002\n0.288\n0.271\n0.285\n-0.249\n0.209\n-0.084\n0.138\n1.095**\n0.352\n-0.102\n0.674\n-0.140\n0.721\n1.566**\n0.540\n-0.457\n0.332\n-0.564\n0.353\n0.477\n0.375\n0.528\n0.400\n1.036*\n0.411\n0.915*\n0.425\n    \n`Stress Class`High\n\n0.401**\n0.128\n0.154\n0.132\n0.323+\n0.170\n0.551**\n0.190\n-0.056\n0.267\n0.234\n0.274\n0.545*\n0.276\n-0.263\n0.193\n-0.065\n0.129\n0.653*\n0.333\n-0.320\n0.661\n0.216\n0.685\n1.188*\n0.525\n0.004\n0.332\n-0.089\n0.354\n0.555\n0.364\n0.733+\n0.385\n0.826*\n0.395\n0.769+\n0.406\n    \nYear_n × `UCA Class`Intermediate\n\n0.001\n0.006\n0.000\n0.007\n0.003\n0.009\n-0.001\n0.008\n0.028+\n0.017\n0.010\n0.014\n0.003\n0.012\n0.010\n0.011\n0.008\n0.008\n-0.035*\n0.017\n0.018\n0.037\n0.040\n0.037\n-0.021\n0.027\n-0.005\n0.015\n-0.008\n0.016\n0.005\n0.020\n-0.003\n0.019\n-0.016\n0.021\n-0.003\n0.021\n    \nYear_n × `UCA Class`Large\n\n-0.001\n0.007\n0.003\n0.009\n-0.012\n0.013\n-0.011\n0.013\n0.026\n0.021\n-0.002\n0.018\n-0.002\n0.017\n0.011\n0.015\n-0.013\n0.011\n-0.036\n0.023\n0.027\n0.044\n0.026\n0.048\n-0.042\n0.054\n0.002\n0.030\n0.003\n0.032\n-0.008\n0.031\n-0.016\n0.029\n-0.007\n0.033\n0.005\n0.032\n    \nYear_n × `Stress Class`Medium\n\n0.002\n0.006\n-0.003\n0.007\n-0.004\n0.008\n-0.007\n0.008\n0.006\n0.014\n0.020\n0.013\n0.008\n0.011\n-0.000\n0.010\n0.006\n0.007\n-0.032+\n0.016\n0.054\n0.035\n0.063+\n0.034\n-0.054*\n0.025\n-0.005\n0.015\n0.001\n0.016\n0.013\n0.018\n0.009\n0.017\n-0.015\n0.018\n-0.004\n0.018\n    \nYear_n × `Stress Class`High\n\n0.004\n0.005\n0.003\n0.006\n-0.004\n0.007\n-0.001\n0.007\n0.020\n0.013\n0.016\n0.012\n0.006\n0.010\n-0.006\n0.010\n-0.003\n0.007\n-0.014\n0.016\n0.065+\n0.035\n0.052\n0.033\n-0.039\n0.026\n-0.024\n0.016\n-0.022\n0.017\n0.022\n0.017\n0.010\n0.016\n0.006\n0.017\n0.012\n0.017\n    \n`UCA Class`Intermediate × `Stress Class`Medium\n\n-0.334+\n0.196\n-0.183\n0.184\n-0.317\n0.246\n-0.499+\n0.277\n0.313\n0.403\n0.517\n0.380\n-0.137\n0.375\n0.235\n0.277\n0.140\n0.185\n-2.186***\n0.451\n-0.160\n0.793\n0.117\n0.860\n-1.009\n0.676\n0.082\n0.481\n0.002\n0.509\n-0.738\n0.480\n-0.792\n0.533\n-0.601\n0.541\n-0.304\n0.564\n    \n`UCA Class`Large × `Stress Class`Medium\n\n-0.598*\n0.269\n-0.248\n0.217\n-0.122\n0.314\n-0.480\n0.358\n0.256\n0.420\n0.187\n0.445\n0.131\n0.467\n0.556+\n0.321\n-0.041\n0.226\n-2.030***\n0.526\n0.208\n0.863\n0.199\n0.963\n0.064\n0.919\n0.728\n0.641\n0.848\n0.693\n-0.696\n0.599\n-0.871\n0.679\n0.248\n0.718\n0.577\n0.747\n    \n`UCA Class`Intermediate × `Stress Class`High\n\n-0.136\n0.097\n-0.151\n0.188\n-0.083\n0.264\n-0.244\n0.300\n0.285\n0.438\n-0.334\n0.404\n-0.692+\n0.402\n0.313\n0.290\n-0.050\n0.193\n-1.716***\n0.476\n-0.235\n0.807\n-0.337\n0.845\n-0.358\n0.709\n0.016\n0.672\n-0.289\n0.669\n-0.921+\n0.494\n-0.891\n0.557\n-0.887\n0.567\n-0.682\n0.594\n    \n`UCA Class`Large × `Stress Class`High\n\n-0.083\n0.276\n-0.024\n0.226\n-0.229\n0.338\n-0.258\n0.388\n0.430\n0.434\n0.075\n0.478\n0.116\n0.502\n0.390\n0.344\n-0.066\n0.242\n-1.839**\n0.562\n-0.025\n0.892\n-0.056\n0.963\n-0.007\n0.960\n-0.066\n1.388\n-0.232\n1.181\n-1.597*\n0.645\n-1.945**\n0.734\n0.315\n0.757\n0.388\n0.790\n    \nYear_n × `UCA Class`Intermediate × `Stress Class`Medium\n\n0.001\n0.007\n0.007\n0.009\n-0.007\n0.011\n0.002\n0.011\n-0.021\n0.021\n-0.032+\n0.017\n-0.011\n0.014\n-0.005\n0.014\n-0.007\n0.010\n0.058**\n0.022\n-0.022\n0.041\n-0.058\n0.042\n0.031\n0.033\n0.000\n0.023\n0.006\n0.024\n-0.009\n0.023\n-0.001\n0.022\n0.011\n0.024\n-0.007\n0.024\n    \nYear_n × `UCA Class`Large × `Stress Class`Medium\n\n0.006\n0.008\n0.006\n0.010\n0.012\n0.015\n0.019\n0.014\n-0.019\n0.024\n-0.016\n0.020\n-0.004\n0.019\n-0.019\n0.017\n0.009\n0.013\n0.049+\n0.026\n-0.019\n0.047\n-0.020\n0.052\n0.024\n0.058\n-0.009\n0.037\n-0.017\n0.039\n0.010\n0.033\n0.019\n0.031\n0.012\n0.036\n-0.001\n0.034\n    \nYear_n × `UCA Class`Intermediate × `Stress Class`High\n\n-0.001\n0.007\n0.003\n0.009\n-0.005\n0.012\n0.002\n0.011\n-0.016\n0.023\n0.018\n0.017\n0.022\n0.015\n-0.006\n0.015\n0.001\n0.010\n0.050*\n0.023\n0.005\n0.042\n-0.020\n0.042\n0.019\n0.035\n-0.003\n0.032\n0.010\n0.032\n0.017\n0.023\n0.026\n0.022\n0.032\n0.025\n0.020\n0.025\n    \nYear_n × `UCA Class`Large × `Stress Class`High\n\n0.002\n0.008\n-0.006\n0.011\n0.018\n0.016\n0.002\n0.015\n-0.019\n0.025\n-0.011\n0.021\n-0.016\n0.020\n-0.013\n0.018\n0.012\n0.014\n0.057*\n0.028\n-0.027\n0.048\n-0.018\n0.052\n0.014\n0.060\n0.010\n0.068\n0.016\n0.060\n0.029\n0.035\n0.046\n0.033\n-0.008\n0.037\n-0.007\n0.036\n    ran_pars cond\nsd__(Intercept)\n`UCA Class`:`Stress Class`:SiteCode\n0.567\n\n0.267\n\n0.453\n\n0.549\n\n0.305\n\n0.511\n\n0.653\n\n0.262\n\n0.273\n\n0.526\n\n0.491\n\n0.224\n\n0.746\n\n0.256\n\n0.412\n\n0.519\n\n0.781\n\n0.753\n\n0.865\n\n    \n\nYear_n\n0.035\n\n0.071\n\n0.060\n\n0.029\n\n0.059\n\n0.042\n\n0.050\n\n0.065\n\n0.101\n\n0.098\n\n0.270\n\n0.212\n\n0.228\n\n0.075\n\n0.095\n\n0.180\n\n0.193\n\n0.235\n\n0.266\n\n    \nsd__Year_n\n`UCA Class`:`Stress Class`:SiteCode\n0.009\n\n0.009\n\n0.017\n\n0.017\n\n0.013\n\n0.012\n\n0.019\n\n0.006\n\n0.014\n\n0.016\n\n0.012\n\n0.018\n\n0.009\n\n0.006\n\n0.015\n\n0.009\n\n0.013\n\n0.022\n\n0.024\n\n    \ncor__(Intercept).Year_n\n\n-0.485\n\n-0.246\n\n-0.485\n\n-0.603\n\n-0.463\n\n-0.439\n\n-0.548\n\n-0.213\n\n-0.553\n\n-0.492\n\n1.000\n\n1.000\n\n-1.000\n\n0.806\n\n-0.477\n\n0.260\n\n-0.297\n\n-0.155\n\n-0.161\n\n    fixed zi\n(Intercept)\n\n\n\n\n\n\n\n\n\n4.663***\n1.378\n-0.795\n3.450\n-1.760\n3.869\n-6.867+\n4.049\n\n\n-0.409\n1.281\n2.160**\n0.724\n4.340***\n0.759\n-0.687\n0.828\n0.318\n0.818\n-0.079\n0.830\n3.788**\n1.335\n1.803\n1.876\n4.053*\n1.815\n0.683\n4.285\n    \nlog1p(`Reach Slope`)\n\n\n\n\n\n\n\n\n\n-6.763***\n1.680\n-7.184\n4.961\n-4.585\n3.745\n-3.338\n4.338\n\n\n-1.558\n1.292\n-0.318\n0.654\n-1.384*\n0.615\n-3.356***\n0.856\n0.997\n0.799\n1.518+\n0.812\n-7.046***\n1.853\n-8.234***\n2.112\n-7.026**\n2.604\n-8.490+\n4.847\n    \nYear_n\n\n\n\n\n\n\n\n\n\n0.002\n0.031\n0.018\n0.138\n-0.135\n0.137\n0.032\n0.186\n\n\n-0.177**\n0.061\n-0.096***\n0.028\n-0.129***\n0.030\n0.159***\n0.025\n-0.117***\n0.022\n-0.119***\n0.022\n-0.017\n0.036\n0.059\n0.055\n-0.095\n0.080\n-0.124\n0.140\n    \n`UCA Class`Intermediate\n\n\n\n\n\n\n\n\n\n-1.961**\n0.759\n-2.491\n1.568\n-1.998\n1.662\n-0.833\n2.168\n\n\n-1.286*\n0.652\n-1.033**\n0.332\n-1.290***\n0.310\n-1.753***\n0.431\n0.643\n0.413\n0.639\n0.418\n-2.310**\n0.802\n-2.262*\n0.988\n-2.936**\n1.054\n-2.623\n1.728\n    \n`UCA Class`Large\n\n\n\n\n\n\n\n\n\n-4.961***\n1.011\n-4.961+\n2.858\n-5.159\n3.277\n-18.505\n8556.698\n\n\n-1.970*\n0.771\n-1.594***\n0.418\n-2.061***\n0.389\n-0.633\n0.514\n2.170***\n0.524\n2.412***\n0.532\n-2.458*\n1.047\n-2.718*\n1.154\n-3.132*\n1.423\n-3.713\n2.490\n    \n`Stress Class`Medium\n\n\n\n\n\n\n\n\n\n-1.355+\n0.737\n-2.516+\n1.409\n-2.202\n1.624\n-2.845\n2.474\n\n\n0.794\n0.654\n-1.022**\n0.342\n-1.005**\n0.309\n-0.302\n0.418\n1.623***\n0.422\n1.684***\n0.428\n-2.408**\n0.787\n-2.973**\n0.952\n-3.526***\n1.035\n-3.065+\n1.765\n    \n`Stress Class`High\n\n\n\n\n\n\n\n\n\n-2.370**\n0.847\n-3.279+\n1.744\n-2.251\n1.812\n-2.522\n2.391\n\n\n0.156\n0.702\n-1.291***\n0.386\n-2.241***\n0.372\n-0.277\n0.462\n2.488***\n0.471\n2.579***\n0.480\n-2.771**\n0.905\n-3.396**\n1.074\n-3.796***\n1.129\n-3.657+\n1.976\n    ran_pars zi\nsd__(Intercept)\n`UCA Class`:`Stress Class`:SiteCode\n\n\n\n\n\n\n\n\n2.755\n\n6.017\n\n5.897\n\n12.833\n\n\n\n0.762\n\n0.898\n\n1.286\n\n2.491\n\n2.291\n\n2.572\n\n2.815\n\n5.200\n\n3.530\n\n10.250\n\n    \n\nYear_n\n\n\n\n\n\n\n\n\n0.710\n\n0.796\n\n0.678\n\n0.001\n\n\n\n0.323\n\n0.821\n\n0.865\n\n0.591\n\n0.426\n\n0.420\n\n0.195\n\n0.391\n\n0.777\n\n1.398\n\n    \nsd__Year_n\n`UCA Class`:`Stress Class`:SiteCode\n\n\n\n\n\n\n\n\n0.074\n\n0.010\n\n0.430\n\n0.660\n\n\n\n0.098\n\n0.029\n\n0.065\n\n0.082\n\n0.055\n\n0.055\n\n0.000\n\n0.118\n\n0.160\n\n0.426\n\n    \ncor__(Intercept).Year_n\n\n\n\n\n\n\n\n\n\n-0.038\n\n0.997\n\n0.106\n\n-0.840\n\n\n\n1.000\n\n0.557\n\n-0.608\n\n-0.767\n\n-0.795\n\n-0.931\n\n0.997\n\n-0.819\n\n-0.104\n\n-0.602\n\n    \nNum.Obs.\n\n1168\n\n1168\n\n1168\n\n1157\n\n1059\n\n1078\n\n1091\n\n1166\n\n1177\n\n1168\n\n1168\n\n1168\n\n1168\n\n1168\n\n1168\n\n1168\n\n1168\n\n1168\n\n1168\n\n    \nRMSE\n\n5.01\n\n54.70\n\n10.91\n\n82.94\n\n12.47\n\n72.65\n\n37.87\n\n52.13\n\n0.08\n\n0.11\n\n0.16\n\n0.16\n\n0.14\n\n0.04\n\n0.04\n\n0.09\n\n0.09\n\n0.09\n\n0.09\n\n    \nPseudo R2\n\n0.771\n\n0.822\n\n0.851\n\n0.937\n\n0.367\n\n0.728\n\n0.783\n\n0.331\n\n0.638\n\n0.547\n\n0.485\n\n0.386\n\n0.317\n\n0.180\n\n0.203\n\n0.602\n\n0.707\n\n0.763\n\n0.809\n\n  \n  \n    \n      + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001\n    \n    \n      zi = zero-inflation; cond = conditional; fixed = fixed effects parameter; ran_pars = random effects parameters;\n    \n  \n\n\n\n\n\n\nResults of the DHARMa package which uses a simulation-based approach to create readily interpretable scaled (quantile) residuals for fitted generalized linear (mixed) models. Left panel is a qq-plot to detect overall deviations from the expected distribution, with added tests for correct distribution (KS test), dispersion and outliers. Note that outliers are values that are defined as values outside the simulation envelope, not in terms of a particular quantile. Right panel is a plot of the residuals against the predicted value. Simulation outliers (data points that are outside the range of simulated values) are highlighted as red stars.\n\n\nMorphologySubstrate SizesIndicesPercentCover\n\n\n\nWidth - MeanDepth - MeanWidth:Depth RatioUsable Area\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nD50D85D50Max\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSediment Sorting IndexBank Stability - MeanHabitat Homogeneity\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nFilamentous Algae PercentNon-Filamentous Algae PercentMoss Percent\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nWood Cover - UnembeddedWood Cover - TotalRound Rock Cover - UnembeddedRound Rock Cover - TotalFlat Rock Cover - UnembeddedFlat Rock Cover - Total\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nThese figures show 1:1 plots of observed and model fitted values. The plots are shown on transformed scales. Endpoints were model fitted values fall more closely to the 1:1 line better fit the raw data. A good fitting model means the endpoint align with the distributional family in both mean and variance, that means of monitoring locations are normally distributed (on the transformed scale), and the overdispersion and zero-inflation terms are able to describe the attributes of the raw data. A pseudo R2 value is shown as represented by the squared spearman correlation coefficient of observed vs predicted values.\n\n\nMorphologySubstrate SizesIndicesPercentCover\n\n\n\nWidth - MeanDepth - MeanWidth:Depth RatioUsable Area\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nD50D85D50Max\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSediment Sorting IndexBank Stability - MeanHabitat Homogeneity\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nFilamentous Algae PercentNon-Filamentous Algae PercentMoss Percent\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nWood Cover - UnembeddedWood Cover - TotalRound Rock Cover - UnembeddedRound Rock Cover - TotalFlat Rock Cover - UnembeddedFlat Rock Cover - Total\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nOverallUCA and StressEndpoints by Monitoring LocationsSpatial Correlations\n\n\nThis figure shows the global means and associated error bars. The Overall mean reflects the patterns across all monitoring locations, whereas the UCA Class and Stress Class, each reflect the patterns across locations assigned to those levels. For more detailed breakdowns across combinations of these 3 location classes, see the UCA and Stress tab.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nMorphologySubstrate SizesIndicesPercentCover\n\n\n\nWidth - MeanDepth - MeanWidth:Depth RatioUsable Area\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nD50D85D50Max\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSediment Sorting IndexBank Stability - MeanHabitat Homogeneity\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nFilamentous Algae PercentNon-Filamentous Algae PercentMoss Percent\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nWood Cover - UnembeddedWood Cover - TotalRound Rock Cover - UnembeddedRound Rock Cover - TotalFlat Rock Cover - UnembeddedFlat Rock Cover - Total\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nHeatmap of spearman correlation coefficients among habitat endpoints (including Aquatic Ecosystem Classification variables), with green and blue indicating positive and negative relationships respectively. Strong Statistically significant correlations (rho &gt; 0.6 & p &lt; 0.1) are shown with red outlines. Moderate statistically significant correlations (rho &gt; 0.4 & p &lt; 0.1) are shown with orange outlines. Endpoints are arranged according to a Ward clustering.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nOverallUCA and StressEndpoints by Monitoring LocationsTrend Correlation\n\n\nThis figure shows the global temporal trend coefficients and associated error bars. The Overall trend reflects the patterns across all monitoring locations, whereas the UCA Class and Stress Class each reflect the patterns across locations assigned to those levels. For more detailed breakdowns across combinations of these 3 location classes, see the UCA and Stress tab.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nMorphologySubstrate SizesIndicesPercentCover\n\n\n\nWidth - MeanDepth - MeanWidth:Depth RatioUsable Area\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nD50D85D50Max\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSediment Sorting IndexBank Stability - MeanHabitat Homogeneity\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nFilamentous Algae PercentNon-Filamentous Algae PercentMoss Percent\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nWood Cover - UnembeddedWood Cover - TotalRound Rock Cover - UnembeddedRound Rock Cover - TotalFlat Rock Cover - UnembeddedFlat Rock Cover - Total\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nHeatmap and cluster diagram of spearman correlations among temporal trends in habitat endpoints. Trends were coded as +2, +1, 0, -1, and -2 corresponding with ++, +, 0, -, and -- from the Trends Table. Strong positive correlations among habitat endpoints indicate shared increasing or decreasing temporal trends across multiple sites, while strong negative correlations indicate opposing increasing and decreasing temporal trends across multiple sites. Strong Statistically significant correlations (rho &gt; 0.6 & p &lt; 0.1) are shown with red outlines. Moderate statistically significant correlations (rho &gt; 0.4 & p &lt; 0.1) are shown with orange outlines. Endpoints are arranged according to a Ward clustering.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTrends by Stream Order and StressTrends by Location\n\n\nThis table shows concurrent patterns of temporal trends across all habitat endpoints by stream order and stress class. The ++ and -- indicate that the 90 percent confidence interval of the slope coefficient does not intersect 0, suggesting a significant increasing and decreasing patterns, respectively. The + and - indicate that the 50 percent confidence interval of the of the slope coefficient does not intersect 0, suggesting increasing and decreasing non-significant trends.\n\n\n\n\n\n\n  \n    \n      Overall Trends\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n       \n    \n    Global Trend\n++\n+\n0\n++\n++\n+\n0\n0\n+\n++\n++\n++\n--\n+\n+\n+\n0\n++\n++\n    \n      Stress Class\n    \n    Low\n0\n+\n0\n+\n+\n0\n0\n+\n0\n0\n0\n+\n-\n+\n+\n-\n-\n+\n+\n    Medium\n++\n+\n0\n++\n+\n0\n0\n0\n++\n+\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    High\n++\n+\n0\n++\n++\n++\n+\n-\n+\n++\n++\n++\n--\n0\n0\n++\n+\n++\n++\n    \n      UCA Class\n    \n    Small\n+\n0\n0\n++\n+\n+\n0\n-\n+\n++\n+\n++\n--\n+\n+\n0\n-\n++\n+\n    Intermediate\n+\n+\n0\n++\n++\n++\n++\n+\n++\n++\n++\n++\n--\n0\n+\n+\n0\n++\n+\n    Large\n+\n+\n0\n+\n++\n-\n-\n0\n0\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      UCA Class / Stress Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stress\n    \n    UCA Small\n+\n+\n0\n++\n++\n+\n+\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    UCA Intermediate\n+\n+\n0\n+\n++\n++\n++\n0\n+\n++\n++\n++\n--\n0\n0\n++\n+\n++\n++\n    UCA Large\n+\n0\n0\n0\n++\n0\n-\n-\n0\n++\n++\n++\n--\n0\n0\n++\n+\n+\n+\n    \n      Medium Stress\n    \n    UCA Small\n+\n0\n0\n+\n0\n+\n+\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    UCA Intermediate\n+\n+\n-\n+\n+\n-\n0\n0\n++\n++\n++\n++\n--\n+\n+\n0\n-\n+\n0\n    UCA Large\n++\n+\n0\n++\n+\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    \n      Low Stress\n    \n    UCA Small\n0\n0\n0\n+\n0\n0\n0\n0\n0\n++\n0\n0\n0\n++\n+\n0\n-\n+\n+\n    UCA Intermediate\n0\n0\n+\n+\n+\n0\n0\n+\n+\n0\n0\n+\n-\n+\n+\n0\n-\n+\n+\n    UCA Large\n0\n0\n-\n0\n+\n0\n0\n+\n-\n0\n0\n+\n-\n+\n+\n-\n-\n+\n+\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n\nThis table shows concurrent patterns of temporal trends across all habitat endpoints by monitoring locations. The ++ and -- indicate that the 90 percent confidence interval of the slope coefficient does not intersect 0, suggesting a significant increasing and decreasing patterns, respectively. The + and - indicate that the 50 percent confidence interval of the of the slope coefficient does not intersect 0, suggesting increasing and decreasing non-significant trends.\n\n\n\n\n\n\n  \n    \n      HUMBER\n    \n    \n    \n      HUMBER\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    HU008WM\nSmall\n+\n+\n0\n+\n+\n+\n++\n-\n-\n0\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    HU005WM\nSmall\n0\n+\n-\n+\n+\n+\n0\n0\n-\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    HU006WM\nIntermediate\n-\n0\n0\n-\n+\n++\n++\n0\n0\n++\n++\n++\n-\n0\n0\n++\n+\n++\n++\n    \n      Medium Stess Class\n    \n    HU039WM\nSmall\n0\n0\n-\n0\n0\n+\n0\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    HU016WM\nSmall\n0\n0\n+\n++\n0\n+\n0\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n+\n0\n    HU001WM\nIntermediate\n0\n+\n0\n-\n0\n0\n0\n0\n0\n+\n++\n++\n--\n+\n0\n0\n0\n0\n0\n    HU028WM\nIntermediate\n0\n+\n-\n0\n+\n0\n0\n0\n+\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    HU026WM\nIntermediate\n+\n+\n0\n+\n0\n0\n0\n0\n0\n+\n++\n+\n--\n+\n+\n0\n-\n0\n0\n    HU027WM\nIntermediate\n0\n0\n+\n+\n0\n-\n0\n0\n++\n+\n++\n++\n--\n+\n0\n0\n0\n+\n0\n    HU011WM\nIntermediate\n+\n0\n+\n0\n+\n0\n0\n0\n0\n+\n++\n++\n--\n+\n0\n0\n0\n+\n+\n    HU015WM\nIntermediate\n0\n0\n0\n0\n0\n-\n0\n0\n+\n+\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    HU014WM\nIntermediate\n0\n0\n0\n0\n0\n-\n0\n0\n0\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    HU022WM\nLarge\n0\n+\n0\n+\n0\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n0\n0\n0\n0\n    HU024WM\nLarge\n0\n+\n0\n++\n0\n0\n0\n0\n0\n0\n+\n++\n--\n+\n0\n0\n0\n0\n0\n    HU010WM\nLarge\n0\n+\n0\n+\n++\n0\n0\n-\n0\n0\n++\n++\n--\n0\n0\n+\n0\n+\n+\n    HU003WM\nLarge\n++\n0\n0\n+\n0\n-\n0\n-\n-\n+\n++\n++\n--\n0\n0\n0\n0\n++\n+\n    HU007WM\nLarge\n++\n+\n0\n0\n0\n0\n-\n-\n-\n0\n++\n++\n--\n0\n0\n0\n0\n+\n++\n    HU012WM\nLarge\n0\n+\n0\n-\n0\n0\n0\n0\n-\n0\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    HU013WM\nLarge\n0\n+\n0\n+\n+\n0\n0\n-\n+\n0\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    HU009WM\nLarge\n+\n0\n0\n+\n0\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n0\n0\n0\n0\n    \n      Low Stess Class\n    \n    HU032WM\nSmall\n0\n+\n0\n+\n0\n0\n0\n0\n++\n+\n0\n0\n0\n+\n0\n0\n-\n+\n0\n    HU030WM\nSmall\n0\n0\n+\n+\n0\n0\n0\n0\n-\n+\n0\n0\n0\n++\n+\n-\n-\n+\n+\n    HU035WM\nSmall\n0\n0\n0\n+\n0\n0\n0\n0\n0\n++\n0\n0\n0\n++\n+\n-\n0\n+\n+\n    HU036WM\nIntermediate\n0\n0\n0\n0\n+\n0\n0\n+\n+\n0\n0\n+\n0\n+\n0\n0\n-\n0\n0\n    HU033WM\nIntermediate\n0\n0\n0\n0\n+\n0\n0\n+\n0\n0\n0\n+\n-\n+\n0\n0\n-\n0\n0\n    HU031WM\nIntermediate\n0\n0\n++\n++\n+\n0\n0\n+\n++\n0\n0\n+\n-\n+\n0\n0\n-\n0\n0\n    HU037WM\nIntermediate\n0\n+\n0\n+\n+\n0\n0\n+\n++\n0\n0\n+\n-\n++\n+\n0\n-\n0\n0\n    HU034WM\nIntermediate\n0\n0\n0\n+\n+\n0\n0\n+\n0\n0\n0\n+\n0\n++\n0\n0\n-\n0\n0\n    HU038WM\nIntermediate\n0\n0\n0\n+\n+\n0\n--\n+\n0\n0\n0\n+\n-\n+\n0\n0\n-\n0\n0\n    HU029WM\nLarge\n0\n+\n--\n0\n0\n0\n-\n0\n-\n0\n0\n+\n-\n+\n+\n-\n-\n0\n0\n    HU002WM\nLarge\n0\n+\n0\n-\n+\n0\n0\n+\n-\n0\n0\n0\n-\n+\n0\n-\n-\n0\n0\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      CARRUTHERS\n    \n    \n    \n      CARRUTHERS\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      Medium Stess Class\n    \n    CC003WM\nSmall\n0\n0\n0\n+\n0\n+\n-\n0\n0\n0\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    CC002WM\nIntermediate\n++\n++\n-\n++\n0\n0\n-\n+\n+\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    CC001WM\nIntermediate\n+\n0\n0\n++\n0\n0\n0\n+\n0\n+\n++\n+\n--\n+\n+\n0\n0\n0\n0\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      HIGHLAND\n    \n    \n    \n      HIGHLAND\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    HL001WM\nSmall\n+\n+\n--\n--\n+\n+\n0\n-\n0\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    HL006WM\nSmall\n0\n0\n+\n0\n+\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    HL008WM\nSmall\n+\n0\n+\n++\n+\n+\n0\n-\n-\n+\n++\n++\n--\n0\n0\n+\n0\n++\n+\n    HL007WM\nSmall\n0\n0\n--\n0\n+\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n0\n0\n+\n0\n    HL009WM\nSmall\n--\n0\n-\n-\n++\n0\n+\n-\n+\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    HL005WM\nIntermediate\n++\n0\n++\n++\n+\n++\n++\n0\n++\n++\n++\n++\n--\n0\n0\n++\n+\n++\n++\n    HL010WM\nIntermediate\n++\n++\n0\n++\n+\n++\n+\n0\n+\n+\n++\n++\n--\n0\n0\n++\n+\n++\n+\n    HL003WM\nIntermediate\n++\n++\n-\n+\n+\n++\n+\n0\n0\n+\n++\n++\n--\n0\n0\n++\n0\n++\n+\n    HL011WM\nIntermediate\n+\n0\n+\n-\n+\n++\n+\n0\n0\n+\n++\n++\n-\n0\n0\n++\n+\n++\n+\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      DUFFINS\n    \n    \n    \n      DUFFINS\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    DF001WM\nSmall\n--\n+\n0\n0\n+\n+\n0\n-\n-\n0\n++\n+\n--\n0\n0\n+\n0\n+\n+\n    DF002WM\nSmall\n0\n-\n++\n+\n+\n0\n0\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    \n      Medium Stess Class\n    \n    DF018WM\nSmall\n0\n-\n+\n0\n0\n0\n+\n0\n0\n0\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    DF008WM\nSmall\n+\n0\n+\n++\n0\n+\n0\n0\n0\n0\n+\n++\n--\n++\n+\n0\n0\n0\n0\n    DF005WM\nSmall\n0\n0\n-\n+\n0\n+\n0\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    DF007WM\nSmall\n+\n0\n+\n+\n0\n+\n0\n0\n0\n0\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    DF014WM\nSmall\n0\n0\n0\n-\n0\n+\n+\n0\n0\n0\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    DF016WM\nSmall\n0\n0\n0\n0\n0\n+\n0\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    DF020WMB\nIntermediate\n0\n0\n0\n0\n+\n0\n+\n0\n++\n+\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    DF013WM\nIntermediate\n0\n0\n0\n0\n0\n0\n+\n0\n++\n+\n++\n++\n--\n+\n0\n0\n0\n+\n+\n    DF011WM\nLarge\n0\n0\n0\n+\n0\n0\n0\n-\n++\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    DF010WM\nLarge\n0\n+\n0\n0\n0\n0\n--\n-\n+\n0\n++\n++\n--\n0\n0\n0\n0\n0\n0\n    DF009WM\nLarge\n++\n+\n0\n++\n0\n0\n-\n0\n0\n0\n++\n++\n--\n0\n0\n0\n0\n+\n0\n    DF003WM\nLarge\n0\n+\n0\n++\n0\n0\n+\n-\n0\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    \n      Low Stess Class\n    \n    DF021WMB\nSmall\n0\n0\n0\n+\n0\n0\n0\n0\n0\n+\n0\n0\n0\n+\n+\n0\n-\n+\n0\n    DF004WM\nSmall\n0\n0\n+\n+\n0\n0\n0\n0\n0\n+\n0\n0\n0\n+\n0\n0\n0\n+\n+\n    09263_UP\nSmall\n0\n0\n0\n+\n0\n0\n0\n0\n+\n+\n0\n0\n0\n++\n+\n0\n0\n+\n0\n    09263_DOWN\nSmall\n0\n0\n0\n0\n0\n0\n0\n0\n+\n+\n0\n0\n0\n++\n+\n0\n0\n+\n+\n    DF019WM\nIntermediate\n0\n0\n+\n0\n+\n0\n0\n+\n+\n0\n+\n++\n-\n+\n0\n0\n-\n0\n0\n    DF017WM\nIntermediate\n-\n0\n0\n0\n+\n0\n+\n+\n0\n0\n0\n+\n0\n+\n+\n-\n-\n0\n0\n    DF015WM\nIntermediate\n0\n0\n+\n+\n+\n0\n0\n0\n+\n0\n0\n++\n-\n+\n0\n0\n-\n+\n+\n    DF012WM\nIntermediate\n0\n0\n0\n0\n++\n+\n+\n0\n+\n0\n+\n++\n-\n+\n0\n0\n0\n+\n+\n    DF006WM\nLarge\n0\n0\n0\n+\n+\n0\n0\n+\n0\n0\n0\n0\n-\n+\n0\n0\n-\n+\n+\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      ETOBICOKE\n    \n    \n    \n      ETOBICOKE\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    EC010WM\nSmall\n+\n+\n+\n++\n+\n+\n0\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n++\n+\n    EC006WM\nSmall\n+\n+\n0\n++\n0\n0\n0\n0\n+\n+\n++\n++\n--\n0\n0\n+\n0\n0\n0\n    EC003WM\nSmall\n+\n+\n0\n++\n0\n0\n--\n0\n-\n+\n++\n++\n--\n0\n0\n0\n0\n0\n-\n    EC009WM\nIntermediate\n-\n+\n-\n-\n+\n++\n++\n0\n+\n+\n++\n++\n--\n0\n0\n++\n+\n++\n++\n    EC005WM\nLarge\n+\n0\n0\n0\n+\n0\n0\n0\n+\n++\n++\n++\n--\n0\n0\n++\n++\n0\n0\n    EC004WM\nLarge\n++\n-\n++\n0\n++\n0\n--\n0\n-\n++\n++\n++\n--\n0\n0\n+\n+\n+\n+\n    EC002WM\nLarge\n--\n+\n--\n--\n+\n0\n-\n-\n0\n++\n++\n++\n--\n0\n0\n++\n+\n+\n++\n    EC001WM\nLarge\n0\n++\n-\n0\n+\n0\n0\n-\n0\n++\n++\n++\n--\n0\n0\n+\n+\n++\n+\n    \n      Medium Stess Class\n    \n    EC012WM\nIntermediate\n0\n0\n0\n0\n+\n-\n-\n0\n+\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    EC008WM\nLarge\n+\n0\n0\n+\n0\n-\n0\n-\n+\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    EC007WM\nLarge\n+\n+\n0\n+\n+\n--\n--\n-\n0\n0\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    EC011WM\nLarge\n0\n0\n0\n0\n+\n0\n0\n-\n0\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      FRENCHMANS BAY\n    \n    \n    \n      FRENCHMANS BAY\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    FB001WM\nSmall\n+\n0\n++\n++\n+\n+\n0\n0\n0\n0\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    FB002WM\nSmall\n+\n0\n-\n+\n+\n+\n+\n-\n0\n0\n++\n++\n-\n0\n0\n+\n0\n+\n+\n    FB004WM\nSmall\n++\n++\n0\n+\n+\n+\n0\n-\n0\n0\n++\n++\n--\n0\n0\n+\n0\n+\n0\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      DON\n    \n    \n    \n      DON\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    DN011WM\nSmall\n+\n+\n0\n+\n0\n0\n--\n-\n0\n+\n++\n++\n--\n0\n0\n0\n-\n++\n+\n    DN010WMB\nSmall\n+\n+\n0\n+\n+\n0\n-\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n+\n+\n    DN009WMB\nSmall\n0\n0\n0\n0\n+\n+\n+\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    DN006WMB\nSmall\n0\n++\n-\n0\n0\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n+\n0\n++\n+\n    DN007WM\nSmall\n0\n0\n+\n0\n+\n0\n0\n-\n-\n0\n++\n++\n-\n0\n0\n+\n0\n++\n++\n    DN013WM\nSmall\n+\n0\n+\n++\n+\n+\n++\n-\n-\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    DN014WM\nSmall\n0\n++\n--\n0\n+\n++\n++\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n+\n+\n    DN020WM\nSmall\n0\n0\n0\n0\n+\n+\n0\n-\n0\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    DN018WM\nSmall\n+\n0\n+\n0\n+\n+\n0\n0\n0\n0\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    DN008WM\nIntermediate\n-\n0\n0\n0\n+\n++\n+\n0\n+\n+\n++\n++\n-\n0\n0\n++\n+\n++\n+\n    DN003WM\nIntermediate\n+\n++\n-\n+\n++\n++\n++\n0\n0\n++\n++\n++\n--\n0\n0\n++\n+\n++\n++\n    DN002WM\nIntermediate\n0\n0\n0\n+\n+\n++\n+\n0\n+\n+\n++\n++\n--\n0\n0\n++\n+\n++\n++\n    DN016WM\nIntermediate\n+\n++\n--\n+\n++\n++\n+\n0\n0\n+\n++\n++\n--\n0\n0\n++\n+\n+\n+\n    DN001WM\nLarge\n++\n0\n+\n+\n+\n0\n0\n-\n0\n+\n++\n+\n--\n0\n0\n+\n+\n0\n0\n    DN005WM\nLarge\n0\n0\n0\n0\n+\n0\n0\n0\n0\n++\n++\n++\n--\n0\n0\n++\n+\n+\n+\n    DN012WM\nLarge\n+\n0\n+\n+\n+\n0\n-\n-\n0\n+\n++\n++\n--\n0\n0\n+\n+\n0\n0\n    DN015WM\nLarge\n0\n0\n0\n0\n+\n0\n+\n-\n0\n+\n++\n++\n--\n0\n0\n++\n+\n+\n+\n    \n      Medium Stess Class\n    \n    DN023WM\nSmall\n0\n0\n-\n0\n0\n0\n0\n0\n+\n0\n++\n++\n--\n++\n+\n0\n0\n+\n+\n    DN019WM\nSmall\n0\n0\n+\n+\n0\n+\n+\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    DN021WM\nIntermediate\n+\n+\n0\n+\n+\n-\n0\n0\n+\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    \n      Low Stess Class\n    \n    DN022WM\nSmall\n0\n0\n0\n0\n0\n0\n0\n0\n--\n+\n0\n0\n0\n++\n+\n0\n-\n+\n0\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      ROUGE\n    \n    \n    \n      ROUGE\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    RG004WM\nSmall\n0\n0\n0\n0\n+\n0\n0\n-\n+\n+\n++\n++\n--\n0\n0\n+\n0\n+\n0\n    RG005WM\nSmall\n0\n+\n-\n0\n+\n0\n0\n0\n0\n+\n++\n++\n--\n0\n0\n+\n0\n+\n0\n    RG003WM\nSmall\n+\n+\n0\n++\n0\n0\n0\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n+\n0\n    RG017WM\nSmall\n+\n0\n+\n++\n+\n0\n0\n0\n0\n+\n++\n++\n--\n0\n0\n+\n0\n0\n0\n    RG024WM\nSmall\n+\n0\n+\n+\n+\n+\n+\n-\n-\n+\n++\n++\n--\n0\n0\n+\n0\n+\n+\n    \n      Medium Stess Class\n    \n    RG010WM\nSmall\n0\n0\n0\n0\n+\n+\n0\n0\n+\n0\n++\n++\n--\n+\n+\n+\n0\n+\n+\n    RG022WM\nSmall\n+\n0\n+\n+\n0\n+\n+\n0\n0\n0\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    RG023WM\nSmall\n0\n0\n+\n0\n0\n+\n0\n0\n+\n0\n++\n++\n--\n+\n+\n0\n0\n+\n+\n    RG011WM\nIntermediate\n+\n+\n0\n+\n0\n-\n-\n0\n0\n+\n+\n++\n--\n+\n0\n0\n0\n0\n0\n    RG018WM\nIntermediate\n0\n0\n0\n+\n+\n0\n0\n0\n+\n+\n++\n++\n--\n+\n+\n0\n-\n+\n+\n    RG015WM\nIntermediate\n+\n0\n0\n+\n+\n-\n0\n0\n+\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    RG016WM\nIntermediate\n0\n+\n0\n0\n0\n-\n-\n0\n+\n+\n++\n++\n--\n+\n0\n0\n-\n+\n+\n    RG019WM\nIntermediate\n+\n++\n--\n+\n0\n0\n0\n0\n+\n+\n+\n+\n--\n+\n+\n0\n0\n0\n0\n    RG020WM\nIntermediate\n+\n++\n--\n+\n0\n-\n0\n0\n0\n+\n++\n++\n--\n+\n+\n0\n0\n0\n0\n    RG021WM\nIntermediate\n0\n0\n-\n0\n0\n0\n0\n0\n0\n+\n++\n++\n--\n+\n+\n0\n-\n0\n0\n    RG007WM\nLarge\n++\n+\n0\n++\n+\n0\n-\n-\n++\n0\n++\n++\n--\n0\n0\n0\n0\n0\n0\n    RG001WM\nLarge\n+\n+\n0\n++\n0\n0\n++\n0\n++\n+\n++\n++\n--\n0\n0\n0\n0\n0\n0\n    RG006WM\nLarge\n+\n0\n0\n0\n0\n0\n0\n-\n0\n0\n++\n++\n--\n0\n0\n0\n0\n0\n0\n    RG009WM\nLarge\n-\n++\n-\n++\n+\n0\n++\n-\n0\n+\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    RG002WM\nLarge\n+\n+\n-\n+\n0\n-\n+\n-\n0\n0\n++\n++\n--\n0\n0\n0\n0\n+\n+\n    \n      Low Stess Class\n    \n    RG026WM\nSmall\n-\n0\n++\n++\n0\n0\n0\n0\n0\n+\n0\n0\n0\n++\n+\n-\n-\n+\n0\n    RG027WM\nSmall\n0\n0\n0\n+\n0\n0\n0\n0\n0\n+\n0\n0\n0\n++\n+\n-\n0\n+\n0\n    RG025WM\nSmall\n0\n0\n-\n0\n0\n0\n-\n0\n0\n+\n0\n0\n0\n+\n++\n0\n-\n+\n0\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      MIMICO\n    \n    \n    \n      MIMICO\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      High Stess Class\n    \n    MM005WM\nSmall\n+\n+\n0\n+\n+\n++\n+\n-\n0\n+\n++\n++\n--\n0\n0\n+\n0\n++\n++\n    MM004WM\nIntermediate\n+\n++\n-\n+\n+\n++\n+\n0\n0\n+\n++\n++\n-\n0\n0\n++\n+\n+\n+\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n  \n    \n      PETTICOAT\n    \n    \n    \n      PETTICOAT\n      UCA Class\n      \n        Morphology\n      \n      \n        Substrate Sizes\n      \n      \n        Indices\n      \n      \n        Percent\n      \n      \n        Cover\n      \n    \n    \n      Width - Mean\n      Depth - Mean\n      Width:Depth Ratio\n      Usable Area\n      D50\n      D85\n      D50Max\n      Sediment Sorting Index\n      Bank Stability - Mean\n      Habitat Homogeneity\n      Filamentous Algae Percent\n      Non-Filamentous Algae Percent\n      Moss Percent\n      Wood Cover - Unembedded\n      Wood Cover - Total\n      Round Rock Cover - Unembedded\n      Round Rock Cover - Total\n      Flat Rock Cover - Unembedded\n      Flat Rock Cover - Total\n    \n  \n  \n    \n      Medium Stess Class\n    \n    PT004WM\nSmall\n+\n0\n0\n++\n0\n+\n0\n0\n0\n0\n++\n++\n--\n+\n+\n0\n0\n+\n0\n    PT002WM\nIntermediate\n+\n+\n--\n+\n0\n-\n-\n0\n+\n+\n++\n++\n--\n+\n+\n0\n-\n+\n0\n    PT001WM\nIntermediate\n0\n0\n0\n0\n+\n-\n--\n0\n0\n+\n++\n++\n--\n+\n+\n0\n-\n0\n-\n  \n  \n    \n      + + = Increasing Significant | + = Increasing Trend | 0 = No Change | - = Decreasing Trend | - - = Decreasing Significant\n    \n  \n\n\n\n\n\n\n\n\n\n\nCorrelationsScatterplots\n\n\nHeatmap of spearman correlation coefficients of habitat and fish community endpoints, with green and blue indicating positive and negative relationships respectively. Strong Statistically significant correlations (rho &gt; 0.6 & p &lt; 0.1) are shown with red outlines. Moderate statistically significant correlations (rho &gt; 0.4 & p &lt; 0.1) are shown with orange outlines. Endpoints are arranged according to a Ward clustering.\n\n\n\n\n\n\n\n\n\n\n\nScatterplots of habitat and fish community endpoints where absolute spearman correlation coefficients are greater than 0.3.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nBy Les Stanfield November 10, 2025\nAs a follow up to the holistic analysis conducted by Patrick Schaefer, I asked for a subset of sites for which field crews had identified visually as becoming “more degraded over time. The intention was to provide a quality control check on the broader analysis. That is, are the broad patterns in the analysis in agreement with field impressions. Such intuitive interpretation provides a form of quality control for the conclusions.\nA Crew leader (Mark Szonda) and Jeff Vandenburg (program supervisor) developed the following list of sites deemed to be undergoing “significant morphological change over the observed time of sampling.\nThe selected sites were:\n\nCC002WM\nDN008WM\nHU021WM (excluded due to lack of data)\nHU032WM\nDF005WM\nEC002WM\nHU024WM\nPT001WM\nDF008WM\nEC012WM\nHU029WM\nRG003WM\n\nInterpretations from table changetbl1.xls were summarized to provide a synopsis of directions for each habitat endpoint. Each endpoint was classified as to whether over the 25-year period there was no change (0); nonsignificant increasing (+1) or decreasing (-1) change; or significant increasing (+2) or decreasing (-2) change. Habitat variables were ranked according to the mean change over time for all the sites for that category. For example, a value close to 2 indicates that nearly all the sites had significant changes in that variable. The results of this analysis is summarized below:\n\n\n\n\n\nRanked Habitat variables by amount of change over time\n  \n    \n      Habitat Variable\n      Amount of classified change\n    \n  \n  \n    Non-Filamentous Algae Percent\n1.82\n    Moss Percent\n-1.64\n    Filamentous Algae Percent\n1.36\n    D50\n1.09\n    Wood Cover - Unembedded\n1.00\n    Habitat Homogeneity\n1.00\n    Flat Rock Cover - Unembedded\n0.64\n    Wood Cover - Total\n0.64\n    Usable Area\n0.55\n    Depth - Mean\n0.55\n    D50Max\n-0.55\n    Bank Stability - Mean\n0.45\n    Round Rock Cover - Total\n-0.36\n    Flat Rock Cover - Total\n0.27\n    Width:Depth Ratio\n-0.27\n    Round Rock Cover - Unembedded\n0.18\n    D85\n0.18\n    Sediment Sorting Index\n-0.18\n    Width - Mean\n0.09\n    Bank Cover - Total\n0.00\n    Bank Cover - Unembedded\n0.00\n    Macrophyte Cover - Total\n0.00\n  \n  \n\n\n\n\nThis analysis supports the broader conclusions that the most consistent measure of change over time in habitat is reflected in an increase in the amount of algae, both non and filamentous with a concurrent decrease in the amount of moss at a site. These conclusions are strong and consistent with ecological theory. Degrading streams have less stable substrates to which moss would attach. Algae is a much faster and seasonal plant and would be more adapted to grow on less stable substrates. Additionally, degrading streams are often found to receive increased nutrients which would also encourage algal growth.\nWhile not significant, there were increasing trends in the mean point particle (D50), amount of unembedded and total wood cover and sites became more similar in depth and velocity profiles (Habitat homogeneity. This tendency is more complicated to interpret. A stream that is undergoing increased flow flashiness would be hypothesized to have greater movement of substrate and potentially loss of finer materials. This scenario would also result in increased erosion and therefore increased supply of wood into the channel. Finally, increased erosion typically manifests as either downcutting (degradation) or channel widening (aggradation). Assuming channel capacity doesn’t change, downcutting would tend to narrow the channel, decreasing mean width (as evidenced EC002WM). When stream beds are less erodible, the channel tends to widen as is evidenced at site CC02WM). There is clearly evidence of both scenarios in the dataset that complicate interpretation of broad patterns.\nNone of the geomorphic metrics consistently indicate a degradation in channel stability and in some cases the data are confounding. For example, in contrast to expectations, bank stability tended to increase at most of the sites over time. A cursory look at the 2025 site features data for these sites determined that at only one site (EC012WM) was there evidence of channel hardening, negating this activity as an explanation of these findings.\nThere were also no consistent changes in the width or depth, substrate or sediment sorting. At many of the site’s crews recorded evidence of sediment loading that could be a factor in their classification of these sites as being degrading over time. Perhaps there is a more nuanced and multivariate relationship between these metrics and channel stability, but there is no simplistic correlation between what biologists interpret as channel degradation and the OSAP derived metrics of channel stability. We will continue to seek an independent measure of channel degradation and to reevaluate the existing metrics of channel stability in attempts to improve our ability to measure this important stream metric.\nThe OSAP habitat module was designed to quantify conditions at a site over time and to provide guidance as to probable causal pathways. The strength of this module is hypothesized to be in its ability to help disentangle the effects of geomorphic processes at an individual site level, for example to understand the often opposite effects of degradation and aggradation. The two sites identified above will be used as case studies to ascertain whether observed patterns agree with ecological theory.\nSite CC002WM: This site is on an intermediate sized stream significantly increased in both width and depth over the study period. This resulted in a predictable significant increase in usable area. There were no consistent changes in the traditional substrate metrics, which is supported by their being no change in rock cover, contrary to what I might have predicted. In contrast to expectations the bank stability indice does not decrease and in fact shows a positive tendency. A review of the cross-sectional profiles for this site shows a generally wide channel with shallow banks, many of which would be classified as point bars and therefore stable. The channel, while widening has maintained its overall form from year to year. I hypothesize that if calculated and compared there would also be an increase in the bankfull channel capacity over time. Like other sites there were significant increases in both filamentous and non-filamentous algae and a decrease in moss. There was also a significant increase in macrophytes. These increases imply considerable increase in nutrients and sunlight to the channel. I hypothesis that there would be a significant decline in the Hilsenhoff Index of benthic invertebrates for this site.\nIn general, the habitat data has documented that this channel is aggrading, but the channel has been able to accommodate this change with minimal impact on habitat quality. However, there is considerable evidence of eutrophication occurring at the site that I hypothesize is enhanced by a declining riparian cover.\nSite EC002WM: This site is in the lower sections of Etobicoke Creek in an area that has cut through shale. The streams mean width and usable area have both significantly decreased over time suggesting serious degradation of the channel. The depth has only tended to increase but this could be a limitation of the protocol because in the later years points along several transects were “too deep to be safely measured” and therefore changes in depth were underestimated. Traditional substrate metrics change inconsistently. For example, the point particle size significantly increases over time as fewer smaller sands and gravels are observed. The stream is predictably becoming more poorly sorted, although not in a significant pattern. With downcutting the stream is predictably becoming significantly more homogeneous and the site is trending towards having more rock cover of both types.\nConclusions:\nThat the strongest signature across the dataset was in the significant decrease in moss that was coupled with significant increases in filamentous and non-filamentous algae was a surprise. This finding generates several other hypotheses that could be explored. For example, exploring whether other causal pathways explain this finding. As pointed out from the analysis above, there is value in interpreting the ecological changes in sites over time on both a broad and individual basis. There may be stream temperature or riparian vegetation changes that could explain the changes in vegetation.\nIt is also recommended that individual sites be evaluated for concerns on an annual basis.Such analysis could look for patterns, both on an annual basis and over time. The analysis should consider a holistic approach utilizing many of the main OSAP modules and other supporting data, such that ecological concerns could be identified and addressed in a timely manner.For example, analysis could evaluate benthic communities, temperature and habitat to see if flags emerge in any ecological factor (i.e., eutrophication, aggrading channels etc.). Where concerns are identified, methods could be modified to provide more diagnostic capabilities (greater numbers of points or more transects) or inclusion of other sampling methods in a truly adaptive manner. Conversely, sites which show no trends of change could be reconsidered for less sampling periodicity, or less intensity (i.e., rapid assessment modules). One recommendation then would be to generate an annual synopsis of site conditions that generates hypothesis that direct staff to action.\nThere is clearly more to the finding of the changes in vegetation that should be investigated.Leading hypothesis are that it truly is a measure of the stability of the bed, in that a rolling stone gathers no moss. However, equally plausible findings could be related to increased solar radiation (changes to riparian vegetation) and/or changes in stream temperature\n\n\n\nModel Fit\nOverall models fit observed data well. Generally, the best fits were observed for Morphology endpoints, and weakest for some Substrate Sizes, Percent, and Cover endpoints. Most modeled endpoints contained some statistical deviations from expectations based on the selected distributional family, but visual inspection of residual plots showed good matches between observed and expected values to their theoretical quantiles.\n\n\nSpatial Patterns\n\nSpatial Correlations\nAt a high level, there are groups of endpoints with positive and negative correlations. Flat and round rock cover, substrate sizes, and algae and moss cover endpoints all showed some degree of positive correlations. Most of these endpoints were negatively correlated with wood cover and sediment sorting index. These endpoints were also positively correlated with reach slope, upstream catchment developed (%) and upstream catchment stress index, but uncorrelated with upstream agriculture. Stream morphology endpoints were also positively correlated with this cluster, but only weakly so.\n\n\nMorphology\nOverall there were clear and expected patterns in morphology across the Upstream Catchment Area (UCA) classes. For stream width, there was a non-significant pattern of low stress streams being narrower, especially among smaller streams. Conversely, for stream depth, there was a non-significant pattern of low stress streams being shallower, but only among small and intermediate streams. Together these patterns showed higher usable areas among small.\n\n\nSubstrate Sizes\nSubstrate sizes varied predictably with UCA, as smaller streams had smaller substrates. Substrates were also larger at high stress streams. Many of the monitoring locations with the smallest substrate sizes were found in Carruthers Creek watershed, but also some among the smaller streams in the upper Don and Humber watersheds.\n\n\nIndices\nSediment sorting index was lowest in high stress streams, especially among the largest UCA. Mean bank stability was lowest in high stress streams, and highest in low stress streams. Within the low stress streams, there is a pattern of decreasing bank stability among larger streams than smaller streams. Habitat homogeneity varied by stream size, with larger streams having higher homogeneity. Upstream stress did not have a significant impact on homogeity.\n\n\nPercent\nAmong the percent endpoints, there is a greater amount of variation among larger streams, than small and intermediate streams. Among small streams in particular, upstream stress seemed to play a large role in formation of algae which accumulated more in high stress sites then low stress sites. Filamentous and non-filamentous algae tended to be high in sites closer to lake Ontario and increasing further from the lake. Carruthers Creek and Frenchmans Bay watersheds locations were an exception and had high percent algae. Percent moss did not show this spatial pattern. High algae percentages may be related to elevated nutrient concentrations among more agricultural streams, especially in the upper Humber river watershed.\n\n\nCover\nThere is little difference in the spatial patterns between the unembedded and total fractions of wood, round rock and flat rock cover endpoints. There are also few consistent patterns among the cover endpoints in relation to overall UCA, but did show some weak patterns related to upstream stress. Wood cover tended to increase with decreasing stress, while flat and round rock cover increased with increasing stress. Wood cover tended to be lowest closer to lake Ontario, and higher further from the lake. This may be reflective of reduced forest cover in more densely urbanized areas closer to the lake. Round and flat rock covers both tend to be higher closer to lake Ontario, suggesting greater proportions of these cover types in more developed areas. These spatial patterns are confirmed in trend analysis which showed positive correlations with Upstream Catchment Stress Index and Upstream Catchment Developed (%).\n\n\n\nTemporal Patterns\n\nTemporal Correlations\nTemporal trends in flat and round rock cover, substrate sizes and stream morphology were generally positively correlated, indicating share increasing or decreasing trends over time. Wood cover, bank stability, sediment sorting index and moss percent were mostly negatively correlated with the previous endpoints, indicating contrasting trends (i.e., one endpoint is increasing while the other is decreasing over time, or vice versa). Wood cover, bank stability, sediment sorting index and moss percent were generally positively correlated with each other.\n\n\nMorphology\nStream width, depth and usable area are showing overall patterns of increasing over time throughout the TRCA. The rate of increasing width and depth was greatest in high and medium stress streams. Width to depth ratios were not changing consistently over time.\n\n\nSubstrate Sizes\nThe D50 endpoint showed consistently increasing trends over time, especially at large and intermediate streams. There are also patterns of increasing D50 at high and low stress classes, but not medium stress. Variation in temporal trends among D85 and D50Max were inconsistent across UCA and stress, but were both significantly increasing at high stress, intermediate sized streams.\n\n\nIndices\nHabitat homogeneity showed consistent increasing trends over time. The rate of increase was highest in high stress streams. Bank stability and sediment sorting index did not show consistent or significant temporal changes across UCA, stress or habitat stability classes. Spatially, bank stability tended to decrease among sites along, or direct tributaries to the Don and Huber rivers.\n\n\nPercent\nFilamentous and non-filamentous algae percents both increased over time at high and medium stress sites, and showed no consistent trends at low stress sites. The trends did not vary consistently by upstream catchment area. Rates of change were consistently higher for non-filamentous algae than for filamentous algae. Moss percent had an inverse pattern from algae, showing significant decreases over time at high and medium stress sites. Most areas of increasing algae were closer to lake Ontario, while the upper watersheds showed fewer patterns or even decreases.\n\n\nCover\nThere is little difference in the temporal patterns between the unembedded and total fractions of wood, round rock and flat rock cover endpoints. Round rock cover showed slight increasing trends, but only among high stress streams. Flat rock cover showed significant increases in small and intermediate, high stress streams. Spatially, sites showing increases in round and flat rock covers tended to be closer lake Ontario, while sites increasing in wood cover tended to be in the upper parts of the watershed.\n\n\n\nRelationships Between Habitat and Fish Communities\nThere are no strong relationships (spearman rho &gt; 0.6) between habitat and fish community endpoints. Some weak, but noteworthy relationships do exist however. Specifically, lithophilic spawners and open substratum spawners were positively correlated with a cluster of habitat endpoints including round and flat rock cover, substrate sizes, moss percent and habitat homogeneity. Sensitive darters were positively correlated with width, usable area, and width:depth ration, but not depth alone. Interestingly total community biomass, creek chub and community density were negatively correlated with these same morphology endpoints. Wood cover was also positively correlated with brook trout, creek chub, and coldwater stenotherm fish endpoints. Fish community richness, tolerant taxa richness and SATI biomass (a thermally weighted biomass measure) were positively correlated with width, depth and usable area.\n\n\nConclusions\nOverall, morphology and percent moss and algae endpoints showed strongest and most consistent spatial and temporal patterns to broad landscape level drivers. Morphology also showed some of the strongest correlations with fish community endpoints. Cover endpoints showed less consistent spatial and temporal patterns, but did show some relationships with fish community endpoints.\nThe stress classes used in the current models are perhaps suboptimal for describing spatial patterns in stream habitat data. Though correlation between most habitat endpoints were stronger with the Upstream Catchment Stress Index than with Upstream Catchment Developed (%), perhaps different thresholds should be considered to better understand spatial patterns among in stream habitat endpoints."
  }
]